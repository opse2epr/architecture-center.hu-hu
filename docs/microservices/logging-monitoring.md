---
title: Naplózás és figyelés a mikroszolgáltatások
description: Naplózás és figyelés a mikroszolgáltatások
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: b7206e2f35b9f227ff298f077ddafef1c6015b15
ms.sourcegitcommit: 94d50043db63416c4d00cebe927a0c88f78c3219
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 09/28/2018
ms.locfileid: "47428771"
---
# <a name="designing-microservices-logging-and-monitoring"></a><span data-ttu-id="ae76d-103">Mikroszolgáltatások tervezése: naplózást és figyelést</span><span class="sxs-lookup"><span data-stu-id="ae76d-103">Designing microservices: Logging and monitoring</span></span>

<span data-ttu-id="ae76d-104">Bármely összetett alkalmazásban valamikor hiba fog hiba lép fel.</span><span class="sxs-lookup"><span data-stu-id="ae76d-104">In any complex application, at some point something will go wrong.</span></span> <span data-ttu-id="ae76d-105">A mikroszolgáltatás-alkalmazások, a nyomon követendő több tucat vagy akár több száz szolgáltatások történéseiről.</span><span class="sxs-lookup"><span data-stu-id="ae76d-105">In a microservices application, you need to track what's happening across dozens or even hundreds of services.</span></span> <span data-ttu-id="ae76d-106">Naplózás és figyelés különösen fontosak, hogy a rendszer holisztikus.</span><span class="sxs-lookup"><span data-stu-id="ae76d-106">Logging and monitoring are critically important to give you a holistic view of the system.</span></span> 

![](./images/monitoring.png)

<span data-ttu-id="ae76d-107">A mikroszolgáltatási architektúrákban, különösen kihívást jelenthet kiszűrheti a hibák vagy a teljesítmény szűk pontos okát.</span><span class="sxs-lookup"><span data-stu-id="ae76d-107">In a microservices architecture, it can be especially challenging to pinpoint the exact cause of errors or performance bottlenecks.</span></span> <span data-ttu-id="ae76d-108">Egyetlen felhasználói művelet több szolgáltatást előfordulhat, hogy kiterjednek.</span><span class="sxs-lookup"><span data-stu-id="ae76d-108">A single user operation might span multiple services.</span></span> <span data-ttu-id="ae76d-109">Szolgáltatások tapasztalhat a hálózati i/o-korlátok a fürtben.</span><span class="sxs-lookup"><span data-stu-id="ae76d-109">Services may hit network I/O limits inside the cluster.</span></span> <span data-ttu-id="ae76d-110">Szolgáltatások közötti hívások láncolatától ellennyomás a rendszer magas késést eredményez, vagy alapú egymásra épülő hibákat okozhat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-110">A chain of calls across services may cause backpressure in the system, resulting in high latency or cascading failures.</span></span> <span data-ttu-id="ae76d-111">Ezen kívül általában nem tudja melyik csomópont egy adott tároló fog futni.</span><span class="sxs-lookup"><span data-stu-id="ae76d-111">Moreover, you generally don't know which node a particular container will run in.</span></span> <span data-ttu-id="ae76d-112">Ugyanazon a csomóponton elhelyezett tárolók korlátozott CPU és memória tagja is lehet.</span><span class="sxs-lookup"><span data-stu-id="ae76d-112">Containers placed on the same node may be competing for limited CPU or memory.</span></span> 

<span data-ttu-id="ae76d-113">Ahhoz, hogy az értelemben, hogy mi történik, az alkalmazás telemetrikus eseményeket kell kibocsátania.</span><span class="sxs-lookup"><span data-stu-id="ae76d-113">To make sense of what's happening, the application must emit telemetry events.</span></span> <span data-ttu-id="ae76d-114">Ezek a metrikák és a szöveges naplók rendezheti.</span><span class="sxs-lookup"><span data-stu-id="ae76d-114">You can categorize these into metrics and text-based logs.</span></span> 

<span data-ttu-id="ae76d-115">*Metrikák* numerikus érték, amely elemezhetők.</span><span class="sxs-lookup"><span data-stu-id="ae76d-115">*Metrics* are numerical values that can be analyzed.</span></span> <span data-ttu-id="ae76d-116">Használhatja őket megfigyelését a rendszer a valós idejű (vagy a közel valós idejű), vagy a teljesítménytrendek elemzéséhez az idő függvényében.</span><span class="sxs-lookup"><span data-stu-id="ae76d-116">You can use them to observe the system in real time (or close to real time), or to analyze performance trends over time.</span></span> <span data-ttu-id="ae76d-117">Metrikák a következők:</span><span class="sxs-lookup"><span data-stu-id="ae76d-117">Metrics include:</span></span>

- <span data-ttu-id="ae76d-118">Csomópont-szintű rendszer metrikái, többek között a CPU, memória, hálózati, lemez és fájlrendszerhasználat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-118">Node-level system metrics, including CPU, memory, network, disk, and file system usage.</span></span> <span data-ttu-id="ae76d-119">Rendszermérőszámokat könnyebben értheti meg a fürt egyes csomópontjaihoz tartozó erőforrás-elosztás és kiugró értékek a hibaelhárítás.</span><span class="sxs-lookup"><span data-stu-id="ae76d-119">System metrics help you to understand resource allocation for each node in the cluster, and troubleshoot outliers.</span></span>
 
- <span data-ttu-id="ae76d-120">Kubernetes-metrikákat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-120">Kubernetes metrics.</span></span> <span data-ttu-id="ae76d-121">Mivel a szolgáltatások futnak a tárolók, kell gyűjteni a tároló szintjén, nem csak a virtuális gép szintjén.</span><span class="sxs-lookup"><span data-stu-id="ae76d-121">Because services run in containers, you need to collect metrics at the container level, not just at the VM level.</span></span> <span data-ttu-id="ae76d-122">A Kubernetes cAdvisor (tároló Advisor) az ügynök által összegyűjtött statisztikai adatok a CPU, memória, a fájlrendszer és a használt hálózati erőforrások által a tárolók.</span><span class="sxs-lookup"><span data-stu-id="ae76d-122">In Kubernetes, cAdvisor (Container Advisor) is the agent that collects statistics about the CPU, memory, file system, and network resources used by each container.</span></span> <span data-ttu-id="ae76d-123">A kubelet démon cAdvisor erőforrás statisztikákat gyűjt, és elérhetővé teszi azokat a REST API-n keresztül.</span><span class="sxs-lookup"><span data-stu-id="ae76d-123">The kubelet daemon collects resource statistics from cAdvisor and exposes them through a REST API.</span></span>
   
- <span data-ttu-id="ae76d-124">Alkalmazásmetrikák.</span><span class="sxs-lookup"><span data-stu-id="ae76d-124">Application metrics.</span></span> <span data-ttu-id="ae76d-125">Ez magában foglalja a minden olyan metrikák, amely a szolgáltatás működésének megismerése.</span><span class="sxs-lookup"><span data-stu-id="ae76d-125">This includes any metrics that are relevant to understanding the behavior of a service.</span></span> <span data-ttu-id="ae76d-126">Ilyenek például a várólistán lévő bejövő HTTP-kérelmekre, késleltetése, üzenet-várólista hossza vagy a másodpercenként feldolgozott tranzakciók számát.</span><span class="sxs-lookup"><span data-stu-id="ae76d-126">Examples include the number of queued inbound HTTP requests, request latency, message queue length, or number of transactions processed per second.</span></span>

- <span data-ttu-id="ae76d-127">Függő szolgáltatások mérőszámait.</span><span class="sxs-lookup"><span data-stu-id="ae76d-127">Dependent service metrics.</span></span> <span data-ttu-id="ae76d-128">A fürtön belüli szolgáltatások, például a felügyelt PaaS-szolgáltatások a fürtön kívüli külső szolgáltatásokat hívhatja.</span><span class="sxs-lookup"><span data-stu-id="ae76d-128">Services inside the cluster may call external services that are outside the cluster, such as managed PaaS services.</span></span> <span data-ttu-id="ae76d-129">Az Azure-szolgáltatásokat is figyelhet [Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview).</span><span class="sxs-lookup"><span data-stu-id="ae76d-129">You can monitor Azure services by using [Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview).</span></span> <span data-ttu-id="ae76d-130">Harmadik féltől származó szolgáltatásokkal is, vagy előfordulhat, hogy biztosít bármely metrikák.</span><span class="sxs-lookup"><span data-stu-id="ae76d-130">Third-party services may or may not provide any metrics.</span></span> <span data-ttu-id="ae76d-131">Ha nem, saját nyomon követheti statisztika a késés és a hibák aránya, alkalmazásmetrikák támaszkodnak kell.</span><span class="sxs-lookup"><span data-stu-id="ae76d-131">If not, you'll have to rely on your own application metrics to track statistics for latency and error rate.</span></span>

<span data-ttu-id="ae76d-132">*Naplók* bejegyzései az alkalmazás futása közben előforduló eseményeket.</span><span class="sxs-lookup"><span data-stu-id="ae76d-132">*Logs* are records of events that occur while the application is running.</span></span> <span data-ttu-id="ae76d-133">Ezek közé tartozik többek között az alkalmazásnaplókat (nyomkövetési utasításokat) vagy a webkiszolgáló-naplókkal.</span><span class="sxs-lookup"><span data-stu-id="ae76d-133">They include things like application logs (trace statements) or web server logs.</span></span> <span data-ttu-id="ae76d-134">Naplók elsősorban hasznosak lehetnek az eseményadatokhoz és a legfelső szintű alapprobléma elemzéséhez.</span><span class="sxs-lookup"><span data-stu-id="ae76d-134">Logs are primarily useful for forensics and root cause analysis.</span></span> 

## <a name="considerations"></a><span data-ttu-id="ae76d-135">Megfontolandó szempontok</span><span class="sxs-lookup"><span data-stu-id="ae76d-135">Considerations</span></span>

<span data-ttu-id="ae76d-136">A cikk [Monitorozási és diagnosztikai](../best-practices/monitoring.md) egy általános ajánlott eljárásokat ismerteti.</span><span class="sxs-lookup"><span data-stu-id="ae76d-136">The article [Monitoring and diagnostics](../best-practices/monitoring.md) describes general best practices for monitoring an application.</span></span> <span data-ttu-id="ae76d-137">Az alábbiakban néhány adott tudnivaló a mikroszolgáltatási architektúra kontextusában gondolja.</span><span class="sxs-lookup"><span data-stu-id="ae76d-137">Here are some particular things to think about in the context of a microservices architecture.</span></span>

<span data-ttu-id="ae76d-138">**Konfigurálással és felügyelettel**.</span><span class="sxs-lookup"><span data-stu-id="ae76d-138">**Configuration and management**.</span></span> <span data-ttu-id="ae76d-139">Fogja alkalmazni egy felügyelt szolgáltatás, naplózás és figyelés vagy naplózás és figyelés összetevők, a fürtben lévő tárolók üzembe helyezése?</span><span class="sxs-lookup"><span data-stu-id="ae76d-139">Will you use a managed service for logging and monitoring, or deploy logging and monitoring components as containers inside the cluster?</span></span> <span data-ttu-id="ae76d-140">További leírását az alábbi lehetőségek közül, tekintse meg a szakasz [technológiákkal](#technology-options) alatt.</span><span class="sxs-lookup"><span data-stu-id="ae76d-140">For more discussion of these options, see the section [Technology Options](#technology-options) below.</span></span>

<span data-ttu-id="ae76d-141">**Betöltési arány**.</span><span class="sxs-lookup"><span data-stu-id="ae76d-141">**Ingestion rate**.</span></span> <span data-ttu-id="ae76d-142">Mi az az átviteli sebességet, amellyel a rendszer betöltheti a telemetria-eseményeinek?</span><span class="sxs-lookup"><span data-stu-id="ae76d-142">What is the throughput at which the system can ingest telemetry events?</span></span> <span data-ttu-id="ae76d-143">Mi történik, hogy aránya túllépi?</span><span class="sxs-lookup"><span data-stu-id="ae76d-143">What happens if that rate is exceeded?</span></span> <span data-ttu-id="ae76d-144">Ha például a rendszer lehetséges, hogy ügyfelek forgalmának szabályozása, ebben az esetben telemetriai adat elvész, vagy, előfordulhat, hogy az adatok felbontásának.</span><span class="sxs-lookup"><span data-stu-id="ae76d-144">For example, the system may throttle clients, in which case telemetry data is lost, or it may downsample the data.</span></span> <span data-ttu-id="ae76d-145">A probléma néha csökkentheti a gyűjtött adatok mennyisége csökkentésével:</span><span class="sxs-lookup"><span data-stu-id="ae76d-145">Sometimes you can mitigate this problem by reducing the amount of data that you collect:</span></span>

  - <span data-ttu-id="ae76d-146">Metrikák összesítés szerint kiszámításának statisztikákat, pl.: átlagos és a szórást, és a statisztikai adatokat küldeni a monitorozási rendszer.</span><span class="sxs-lookup"><span data-stu-id="ae76d-146">Aggregate metrics by calculating statistics, such as average and standard deviation, and send that statistical data to the monitoring system.</span></span>  

  - <span data-ttu-id="ae76d-147">Az adatok felbontásának &mdash; , az csak az események százalékos feldolgozni.</span><span class="sxs-lookup"><span data-stu-id="ae76d-147">Downsample the data &mdash; that is, process only a percentage of the events.</span></span>

  - <span data-ttu-id="ae76d-148">Batch az adatokat a figyelési szolgáltatás hálózati hívások számának csökkentése érdekében.</span><span class="sxs-lookup"><span data-stu-id="ae76d-148">Batch the data to reduce the number of network calls to the monitoring service.</span></span>

<span data-ttu-id="ae76d-149">**Költség**.</span><span class="sxs-lookup"><span data-stu-id="ae76d-149">**Cost**.</span></span> <span data-ttu-id="ae76d-150">Előfordulhat, hogy magas, különösen nagy mennyiségben feldolgozására, és tárolja a telemetriai adatokat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-150">The cost of ingesting and storing telemetry data may be high, especially at high volumes.</span></span> <span data-ttu-id="ae76d-151">Bizonyos esetekben ez még akkor is túllépheti az alkalmazás futtatásával járó költségeket.</span><span class="sxs-lookup"><span data-stu-id="ae76d-151">In some cases it could even exceed the cost of running the application.</span></span> <span data-ttu-id="ae76d-152">Ebben az esetben előfordulhat, hogy csökkenteni kell a telemetriai adatok mennyisége összesítésével, egyszerűsítés, vagy az adatok kötegelés fent leírtak szerint.</span><span class="sxs-lookup"><span data-stu-id="ae76d-152">In that case, you may need to reduce the volume of telemetry by aggregating, downsampling, or batching the data, as described above.</span></span> 
        
<span data-ttu-id="ae76d-153">**Adathűséget**.</span><span class="sxs-lookup"><span data-stu-id="ae76d-153">**Data fidelity**.</span></span> <span data-ttu-id="ae76d-154">Hogyan pontos vannak a metrikák?</span><span class="sxs-lookup"><span data-stu-id="ae76d-154">How accurate are the metrics?</span></span> <span data-ttu-id="ae76d-155">Kiugró értékek, különösen nagy mennyiségű átlagokat elrejtéséhez.</span><span class="sxs-lookup"><span data-stu-id="ae76d-155">Averages can hide outliers, especially at scale.</span></span> <span data-ttu-id="ae76d-156">Is ha a mintavételi ráta túl alacsony, azt is simítja ingadozása az adatokat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-156">Also, if the sampling rate is too low, it can smooth out fluctuations in the data.</span></span> <span data-ttu-id="ae76d-157">Jelenhet meg, hogy minden kérelemhez van kapcsolatban az azonos végpontok közötti késés, ha valójában egy jelentős része kérelmek vannak sokkal tovább tart.</span><span class="sxs-lookup"><span data-stu-id="ae76d-157">It may appear that all requests have about the same end-to-end latency, when in fact a significant fraction of requests are taking much longer.</span></span> 

<span data-ttu-id="ae76d-158">**Késés**.</span><span class="sxs-lookup"><span data-stu-id="ae76d-158">**Latency**.</span></span> <span data-ttu-id="ae76d-159">Engedélyezi a valós idejű figyelés és riasztások, a telemetriai adatok elérhetőnek kell lennie gyorsan.</span><span class="sxs-lookup"><span data-stu-id="ae76d-159">To enable real-time monitoring and alerts, telemetry data should be available quickly.</span></span> <span data-ttu-id="ae76d-160">Hogyan "valós idejű" az a figyelési irányítópulton megjelenő adatokat?</span><span class="sxs-lookup"><span data-stu-id="ae76d-160">How "real-time" is the data that appears on the monitoring dashboard?</span></span> <span data-ttu-id="ae76d-161">Néhány másodperc régi?</span><span class="sxs-lookup"><span data-stu-id="ae76d-161">A few seconds old?</span></span> <span data-ttu-id="ae76d-162">Több mint egy perc?</span><span class="sxs-lookup"><span data-stu-id="ae76d-162">More than a minute?</span></span>

<span data-ttu-id="ae76d-163">**Storage.**</span><span class="sxs-lookup"><span data-stu-id="ae76d-163">**Storage.**</span></span> <span data-ttu-id="ae76d-164">A naplók esetében lehet leghatékonyabb a naplózási eseményeket írni a fürt ideiglenes tároló, és a egy ügynök több állandó tárolókba naplófájlok szállításra való konfigurálásához.</span><span class="sxs-lookup"><span data-stu-id="ae76d-164">For logs, it may be most efficient to write the log events to ephemeral storage in the cluster, and configure an agent to ship the log files to more persistent storage.</span></span>  <span data-ttu-id="ae76d-165">Adatok idővel át hosszú távú tárolásra, hogy legyen elérhető utólagos elemzése.</span><span class="sxs-lookup"><span data-stu-id="ae76d-165">Data should eventually be moved to long-term storage so that it's available for retrospective analysis.</span></span> <span data-ttu-id="ae76d-166">A mikroszolgáltatási architektúra hozhat létre nagy mennyiségű telemetriai adatot, így az adatok költségét fontos szempont.</span><span class="sxs-lookup"><span data-stu-id="ae76d-166">A microservices architecture can generate a large volume of telemetry data, so the cost of storing that data is an important consideration.</span></span> <span data-ttu-id="ae76d-167">Is vegye figyelembe, hogyan fog kérdezni az adatokat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-167">Also consider how you will query the data.</span></span> 

<span data-ttu-id="ae76d-168">**Irányítópult és a Vizualizáció.**</span><span class="sxs-lookup"><span data-stu-id="ae76d-168">**Dashboard and visualization.**</span></span> <span data-ttu-id="ae76d-169">Kapunk holisztikus a rendszer minden szolgáltatás, mind a fürt és a külső szolgáltatások között?</span><span class="sxs-lookup"><span data-stu-id="ae76d-169">Do you get a holistic view of the system, across all of the services, both within the cluster and external services?</span></span> <span data-ttu-id="ae76d-170">Ha naplók és a telemetriai adatokat több helyre, is az irányítópult összes megjelenítése és összekapcsolását?</span><span class="sxs-lookup"><span data-stu-id="ae76d-170">If you are writing telemetry data and logs to more than one location, can the dashboard show all of them and correlate?</span></span> <span data-ttu-id="ae76d-171">A figyelési irányítópult kell megjelennie, legalább a következő információkat:</span><span class="sxs-lookup"><span data-stu-id="ae76d-171">The monitoring dashboard should show at least the following information:</span></span>

- <span data-ttu-id="ae76d-172">Általános erőforrás-elosztás kapacitás és a növekedés.</span><span class="sxs-lookup"><span data-stu-id="ae76d-172">Overall resource allocation for capacity and growth.</span></span> <span data-ttu-id="ae76d-173">Ez magában foglalja a tárolók, a fájl rendszermérőszámokat, a hálózati és a core foglalási számát.</span><span class="sxs-lookup"><span data-stu-id="ae76d-173">This includes the number of containers, file system metrics, network, and core allocation.</span></span>
- <span data-ttu-id="ae76d-174">Tárolómetrikák korrelált szolgáltatási szintű.</span><span class="sxs-lookup"><span data-stu-id="ae76d-174">Container metrics correlated at the service level.</span></span>
- <span data-ttu-id="ae76d-175">Rendszermérőszámokat tárolók is vonatkozhatnak.</span><span class="sxs-lookup"><span data-stu-id="ae76d-175">System metrics correlated with containers.</span></span>
- <span data-ttu-id="ae76d-176">Szolgáltatási hibák és a kiugró értékeket.</span><span class="sxs-lookup"><span data-stu-id="ae76d-176">Service errors and outliers.</span></span>
    

## <a name="distributed-tracing"></a><span data-ttu-id="ae76d-177">Elosztott nyomkövetés</span><span class="sxs-lookup"><span data-stu-id="ae76d-177">Distributed tracing</span></span>

<span data-ttu-id="ae76d-178">Ahogy már említettük, a mikroszolgáltatások az egyik kihívás van szolgáltatások között az események áramlását ismertetése.</span><span class="sxs-lookup"><span data-stu-id="ae76d-178">As mentioned, one challenge in microservices is understanding the flow of events across services.</span></span> <span data-ttu-id="ae76d-179">Egy egyszeri művelet vagy egy tranzakció több szolgáltatásra meghívásával is járhat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-179">A single operation or transaction may involve calls to multiple services.</span></span> <span data-ttu-id="ae76d-180">Lépések teljes rekonstruálhassa az egyes szolgáltatások propagálása kell egy *korrelációs azonosító* , amely úgy működik, mint a művelet egyedi azonosítója.</span><span class="sxs-lookup"><span data-stu-id="ae76d-180">To reconstruct the entire sequence of steps, each service should propagate a *correlation ID* that acts as a unique identifier for that operation.</span></span> <span data-ttu-id="ae76d-181">A korrelációs azonosító lehetővé teszi, hogy [elosztott nyomkövetési](https://microservices.io/patterns/observability/distributed-tracing.html) szolgáltatások között.</span><span class="sxs-lookup"><span data-stu-id="ae76d-181">The correlation ID enables [distributed tracing](https://microservices.io/patterns/observability/distributed-tracing.html) across services.</span></span>

<span data-ttu-id="ae76d-182">Az első szolgáltatás, amely fogad egy ügyfél kérelmet kell létrehoznia a korrelációs azonosítót.</span><span class="sxs-lookup"><span data-stu-id="ae76d-182">The first service that receives a client request should generate the correlation ID.</span></span> <span data-ttu-id="ae76d-183">Ha a szolgáltatás lehetővé teszi a HTTP-hívás egy másik szolgáltatás, a korrelációs azonosító a fejléc helyezi el.</span><span class="sxs-lookup"><span data-stu-id="ae76d-183">If the service makes an HTTP call to another service, it puts the correlation ID in a request header.</span></span> <span data-ttu-id="ae76d-184">Hasonlóképpen ha a szolgáltatás aszinkron üzenetet küld, helyezi el a korrelációs Azonosítót az üzenet.</span><span class="sxs-lookup"><span data-stu-id="ae76d-184">Similarly, if the service sends an asynchronous message, it puts the correlation ID into the message.</span></span> <span data-ttu-id="ae76d-185">Alárendelt szolgáltatásokkal továbbra is propagálása a korrelációs Azonosítót, hogy a teljes rendszeren keresztül biztosítani.</span><span class="sxs-lookup"><span data-stu-id="ae76d-185">Downstream services continue to propagate the correlation ID, so that it flows through the entire system.</span></span> <span data-ttu-id="ae76d-186">Emellett az összes olyan kód, írja az alkalmazás metrikákkal vagy naplózási események tartalmaznia kell a korrelációs azonosítót.</span><span class="sxs-lookup"><span data-stu-id="ae76d-186">In addition, all code that writes application metrics or log events should include the correlation ID.</span></span>

<span data-ttu-id="ae76d-187">Hívások közötti kapcsolatot, ha például a végpontok közötti késése a teljes tranzakció, a másodpercenkénti sikeres tranzakciók számát és százalékos arányát sikertelen tranzakciók üzemeltetési mérőszámokkal kiszámíthatja.</span><span class="sxs-lookup"><span data-stu-id="ae76d-187">When service calls are correlated, you can calculate operational metrics such as the end-to-end latency for a complete transaction, the number of successful transactions per second, and the percentage of failed transactions.</span></span> <span data-ttu-id="ae76d-188">Beleértve a korrelációs azonosítók alkalmazásnaplókat, lehetővé válik a hajtsa végre a problémák eredeti okának feltárását.</span><span class="sxs-lookup"><span data-stu-id="ae76d-188">Including correlation IDs in application logs makes it possible to perform root cause analysis.</span></span> <span data-ttu-id="ae76d-189">Ha egy művelet meghiúsul, a log utasítások a szolgáltatás meghívja a műveletben részét képező összes is megtalálhatja.</span><span class="sxs-lookup"><span data-stu-id="ae76d-189">If an operation fails, you can find the log statements for all of the service calls that were part of the same operation.</span></span> 

<span data-ttu-id="ae76d-190">Elosztott nyomkövetést megvalósításához az alábbiakban néhány szempontot:</span><span class="sxs-lookup"><span data-stu-id="ae76d-190">Here are some considerations when implementing distributed tracing:</span></span>

- <span data-ttu-id="ae76d-191">Jelenleg nem korrelációs azonosítók nem szabványos HTTP-fejléc.</span><span class="sxs-lookup"><span data-stu-id="ae76d-191">There is currently no standard HTTP header for correlation IDs.</span></span> <span data-ttu-id="ae76d-192">A csapat egységesen kell ezeket egy egyéni fejléc értéke.</span><span class="sxs-lookup"><span data-stu-id="ae76d-192">Your team should standardize on a custom header value.</span></span> <span data-ttu-id="ae76d-193">A kiválasztott határozzák meg a naplózás és figyelés keretrendszer vagy szolgáltatás háló kiválasztását.</span><span class="sxs-lookup"><span data-stu-id="ae76d-193">The choice may be decided by your logging/monitoring framework or choice of service mesh.</span></span>

- <span data-ttu-id="ae76d-194">Aszinkron üzenetek az üzenetkezelési infrastruktúra támogatja a hozzáadásával metaadatok üzenetek, akkor tartalmaznia kell a korrelációs Azonosítót metaadatokként.</span><span class="sxs-lookup"><span data-stu-id="ae76d-194">For asynchronous messages, if your messaging infrastructure supports adding metadata to messages, you should include the correlation ID as metadata.</span></span> <span data-ttu-id="ae76d-195">Ellenkező esetben adja meg az üzenet-séma részeként.</span><span class="sxs-lookup"><span data-stu-id="ae76d-195">Otherwise, include it as part of the message schema.</span></span>

- <span data-ttu-id="ae76d-196">Ahelyett, hogy egyetlen nem átlátszó azonosítót, előfordulhat, hogy küldjön egy *korrelációs környezet* , amely részletesebb információkat, például a hívó által hívott kapcsolatokat tartalmaz.</span><span class="sxs-lookup"><span data-stu-id="ae76d-196">Rather than a single opaque identifier, you might send a *correlation context* that includes richer information, such as caller-callee relationships.</span></span> 

- <span data-ttu-id="ae76d-197">Az Azure Application Insights SDK automatikusan korrelációs környezet kódtárba be HTTP-fejléceket, és az Application Insights-naplók a korrelációs Azonosítót tartalmaz.</span><span class="sxs-lookup"><span data-stu-id="ae76d-197">The Azure Application Insights SDK automatically injects correlation context into HTTP headers, and includes the correlation ID in Application Insights logs.</span></span> <span data-ttu-id="ae76d-198">Ha úgy dönt, az Application Insights beépített korrelációs funkcióinak használatát, bizonyos szolgáltatások előfordulhat, hogy továbbra is explicit módon propagálni kell a korrelációs fejlécek, a használt kódtárak függően.</span><span class="sxs-lookup"><span data-stu-id="ae76d-198">If you decide to use the correlation features built into Application Insights, some services may still need to explicitly propagate the correlation headers, depending on the libraries being used.</span></span> <span data-ttu-id="ae76d-199">További információkért lásd: [az Application Insights Telemetriai korreláció](/azure/application-insights/application-insights-correlation).</span><span class="sxs-lookup"><span data-stu-id="ae76d-199">For more information, see [Telemetry correlation in Application Insights](/azure/application-insights/application-insights-correlation).</span></span>
   
- <span data-ttu-id="ae76d-200">Ha használunk szolgáltatás rácsvonal Istio vagy linkerd, ezek a technológiák automatikusan generáljon korrelációs fejlécek HTTP-hívások kerülnek a szolgáltatás háló proxyk.</span><span class="sxs-lookup"><span data-stu-id="ae76d-200">If you are using Istio or linkerd as a service mesh, these technologies automatically generate correlation headers when HTTP calls are routed through the service mesh proxies.</span></span> <span data-ttu-id="ae76d-201">Szolgáltatások továbbítsa a megfelelő fejlécek.</span><span class="sxs-lookup"><span data-stu-id="ae76d-201">Services should forward the relevant headers.</span></span> 

    - <span data-ttu-id="ae76d-202">Istio: [elosztott kérelmek nyomkövetése](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span><span class="sxs-lookup"><span data-stu-id="ae76d-202">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span></span>
    
    - <span data-ttu-id="ae76d-203">linkerd: [helyi fejlécek](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span><span class="sxs-lookup"><span data-stu-id="ae76d-203">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span></span>
    
- <span data-ttu-id="ae76d-204">Fontolja meg, hogyan fogja összesíteni a naplókat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-204">Consider how you will aggregate logs.</span></span> <span data-ttu-id="ae76d-205">Különböző csapatokkal való korrelációazonosítók bele naplók egységesítésére érdemes.</span><span class="sxs-lookup"><span data-stu-id="ae76d-205">You may want to standardize across teams on how to include correlation IDs in logs.</span></span> <span data-ttu-id="ae76d-206">Használhat egy strukturált és részben strukturált formátumban, például a JSON-t, és egy közös mezőt, amely tárolja a korrelációs azonosítót.</span><span class="sxs-lookup"><span data-stu-id="ae76d-206">Use a structured or semi-structured format, such as JSON, and define a common field to hold the correlation ID.</span></span>

## <a name="technology-options"></a><span data-ttu-id="ae76d-207">Technológiai lehetőségek</span><span class="sxs-lookup"><span data-stu-id="ae76d-207">Technology options</span></span>

<span data-ttu-id="ae76d-208">**Az Application Insights** egy felügyelt szolgáltatás, az Azure-ban, amely feltölti és tárolja a telemetriai adatokat és eszközöket biztosít az adatok keresése és elemzésére.</span><span class="sxs-lookup"><span data-stu-id="ae76d-208">**Application Insights** is a managed service in Azure that ingests and stores telemetry data, and provides tools for analyzing and searching the data.</span></span> <span data-ttu-id="ae76d-209">Az Application Insights használatához telepítenie egy kialakítási csomagot az alkalmazásban.</span><span class="sxs-lookup"><span data-stu-id="ae76d-209">To use Application Insights, you install an instrumentation package in your application.</span></span> <span data-ttu-id="ae76d-210">Ez a csomag az alkalmazás figyeli, és telemetriai adatokat küld az Application Insights szolgáltatás.</span><span class="sxs-lookup"><span data-stu-id="ae76d-210">This package monitors the app and sends telemetry data to the Application Insights service.</span></span> <span data-ttu-id="ae76d-211">Azt is lekéri, hogy a gazdagép-környezetből a telemetriai adatokat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-211">It can also pull telemetry data from the host environment.</span></span> <span data-ttu-id="ae76d-212">Az Application Insights biztosít beépített összefüggések keresésére és függőségi nyomkövetés.</span><span class="sxs-lookup"><span data-stu-id="ae76d-212">Application Insights provides built-in correlation and dependency tracking.</span></span> <span data-ttu-id="ae76d-213">Segítségével nyomon követheti a rendszer metrikákat, alkalmazásmetrikák és Azure-szolgáltatási metrika, egy helyen.</span><span class="sxs-lookup"><span data-stu-id="ae76d-213">It lets you track system metrics, application metrics, and Azure service metrics, all in one place.</span></span>

<span data-ttu-id="ae76d-214">Vegye figyelembe, hogy az Application Insights szabályozza, ha az adatátviteli sebessége meghaladja a maximális határértéket; További információkért lásd: [korlátozza az Application Insights](/azure/azure-subscription-service-limits#application-insights-limits).</span><span class="sxs-lookup"><span data-stu-id="ae76d-214">Be aware that Application Insights throttles if the data rate exceeds a maximum limit; for details, see [Application Insights limits](/azure/azure-subscription-service-limits#application-insights-limits).</span></span> <span data-ttu-id="ae76d-215">Egyetlen művelet több telemetriai események, előfordulhat, hogy létrehozása, ha az alkalmazás nagy mennyiségű forgalmat, valószínű, hogy leszabályozza.</span><span class="sxs-lookup"><span data-stu-id="ae76d-215">A single operation may generate several telemetry events, so if the application experiences a high volume of traffic, it is likely to get throttled.</span></span> <span data-ttu-id="ae76d-216">A probléma mérséklése érdekében elvégezhet a mintavétel a telemetriai forgalom csökkentése érdekében.</span><span class="sxs-lookup"><span data-stu-id="ae76d-216">To mitigate this problem, you can perform sampling to reduce the telemetry traffic.</span></span> <span data-ttu-id="ae76d-217">A rendszer a kompromisszummal jár, hogy a metrikák kevésbé lesznek pontosak.</span><span class="sxs-lookup"><span data-stu-id="ae76d-217">The tradeoff is that your metrics will be less precise.</span></span> <span data-ttu-id="ae76d-218">További információkért lásd: [Application Insights-mintavétel](/azure/application-insights/app-insights-sampling).</span><span class="sxs-lookup"><span data-stu-id="ae76d-218">For more information, see [Sampling in Application Insights](/azure/application-insights/app-insights-sampling).</span></span> <span data-ttu-id="ae76d-219">Is csökkenthető az adatmennyiség előre összesítése metrikák &mdash; azt jelenti, például átlag, és a szórást statisztikai értékek kiszámítása, és ezek az értékek helyett a nyers telemetriát küld.</span><span class="sxs-lookup"><span data-stu-id="ae76d-219">You can also reduce the data volume by pre-aggregating metrics &mdash; that is, calculating statistical values such as average and standard deviation, and sending those values instead of the raw telemetry.</span></span> <span data-ttu-id="ae76d-220">A következő blogbejegyzés ismerteti egy Application Insights használatával nagy mennyiségű megközelítése: [Azure Monitoring és a nagy méretű](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span><span class="sxs-lookup"><span data-stu-id="ae76d-220">The following blog post describes an approach to using Application Insights at scale: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span></span>

<span data-ttu-id="ae76d-221">Emellett ellenőrizze, hogy megértette a díjszabási modell az Application Insights, mert, adatmennyiség alapján lesznek kiszámlázva.</span><span class="sxs-lookup"><span data-stu-id="ae76d-221">In addition, make sure that you understand the pricing model for Application Insights, because you are charged based on data volume.</span></span> <span data-ttu-id="ae76d-222">További információkért lásd: [az Application Insights árak és adatmennyiségek kezelése](/azure/application-insights/app-insights-pricing).</span><span class="sxs-lookup"><span data-stu-id="ae76d-222">For more information, see [Manage pricing and data volume in Application Insights](/azure/application-insights/app-insights-pricing).</span></span> <span data-ttu-id="ae76d-223">Ha az alkalmazás egy igen nagy mennyiségű telemetriai adatokat hoz létre, és nem kívánja azt végre mintavétel vagy az adatok összesítését, majd az Application Insights nem lehet a megfelelő választás.</span><span class="sxs-lookup"><span data-stu-id="ae76d-223">If your application generates a large volume of telemetry, and you don't wish to perform sampling or aggregation of the data, then Application Insights may not be the appropriate choice.</span></span> 

<span data-ttu-id="ae76d-224">Ha az Application Insights nem felel meg a követelményeknek, az alábbiakban néhány olyan népszerű nyílt forráskódú technológiákat használó javasolt módszert.</span><span class="sxs-lookup"><span data-stu-id="ae76d-224">If Application Insights doesn't meet your requirements, here are some suggested approaches that use popular open-source technologies.</span></span>

<span data-ttu-id="ae76d-225">A rendszer és a tároló mérőszámokat, fontolja meg a metrikák exportálása egy idősorozat-adatbázisba például **Prometheus** vagy **InfluxDB** a fürtben futó.</span><span class="sxs-lookup"><span data-stu-id="ae76d-225">For system and container metrics, consider exporting metrics to a time-series database such as **Prometheus** or **InfluxDB** running in the cluster.</span></span>

- <span data-ttu-id="ae76d-226">InfluxDB egy leküldéses rendszerbe.</span><span class="sxs-lookup"><span data-stu-id="ae76d-226">InfluxDB is a push-based system.</span></span> <span data-ttu-id="ae76d-227">Küldje le a metrikákat kell egy ügynököt.</span><span class="sxs-lookup"><span data-stu-id="ae76d-227">An agent needs to push the metrics.</span></span> <span data-ttu-id="ae76d-228">Használhat [Heapster][heapster], egy szolgáltatás, amely a fürt szintű metrikákat gyűjt kubelet, azaz összesíti az adatokat, majd leküldi azt InfluxDB vagy egyéb idősorozat-tárolási megoldás.</span><span class="sxs-lookup"><span data-stu-id="ae76d-228">You can use [Heapster][heapster], which is a service that collects cluster-wide metrics from kubelet, aggregates the data, and pushes it to InfluxDB or other time-series storage solution.</span></span> <span data-ttu-id="ae76d-229">Az Azure Container Service Heapster a fürt telepítés részeként telepíti.</span><span class="sxs-lookup"><span data-stu-id="ae76d-229">Azure Container Service deploys Heapster as part of the cluster setup.</span></span> <span data-ttu-id="ae76d-230">Másik lehetőségként [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), ez az ügynök gyűjtéséhez és jelentéskészítési metrikákat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-230">Another option is [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), which is an agent for collecting and reporting metrics.</span></span> 

- <span data-ttu-id="ae76d-231">Prometheus egy olyan pull-alapú rendszer.</span><span class="sxs-lookup"><span data-stu-id="ae76d-231">Prometheus is a pull-based system.</span></span> <span data-ttu-id="ae76d-232">A konfigurált helyeket metrikák rendszeres időközönként scrapes.</span><span class="sxs-lookup"><span data-stu-id="ae76d-232">It periodically scrapes metrics from configured locations.</span></span> <span data-ttu-id="ae76d-233">Prometheus is scrape metrikák cAdvisor vagy kube-állapot-metrikák alapján jön létre.</span><span class="sxs-lookup"><span data-stu-id="ae76d-233">Prometheus can scrape metrics generated by cAdvisor or kube-state-metrics.</span></span> <span data-ttu-id="ae76d-234">[kube-állapot-metrics] [ kube-state-metrics] egy szolgáltatás, amely a mérőszámokat gyűjti össze a Kubernetes API-kiszolgálóhoz, és elérhetővé teszi azokat Prometheus (vagy egy Prometheus ügyfél végpont kompatibilis kaparóként).</span><span class="sxs-lookup"><span data-stu-id="ae76d-234">[kube-state-metrics][kube-state-metrics] is a service that collects metrics from the Kubernetes API server and makes them available to Prometheus (or a scraper that is compatible with a Prometheus client endpoint).</span></span> <span data-ttu-id="ae76d-235">Heapster összesíti, hogy a Kubernetes állít elő, és továbbítja őket a fogadóba másolt metrikák, mivel kube-állapot-metrikák hoz létre a saját mérőszámokat, és elérhetővé teszi azokat a Pro automatizované získávání dat-végponton keresztül.</span><span class="sxs-lookup"><span data-stu-id="ae76d-235">Whereas Heapster aggregates metrics that Kubernetes generates and forwards them to a sink, kube-state-metrics generates its own metrics and makes them available through an endpoint for scraping.</span></span> <span data-ttu-id="ae76d-236">Használja a rendszer mérőszámokat, [csomópont exportáló](https://github.com/prometheus/node_exporter), azaz a rendszer metrikákhoz Prometheus exportáló.</span><span class="sxs-lookup"><span data-stu-id="ae76d-236">For system metrics, use [Node exporter](https://github.com/prometheus/node_exporter), which is a Prometheus exporter for system metrics.</span></span> <span data-ttu-id="ae76d-237">Pont adatait, de nem karakterláncadatokat lebegőpontos Prometheus támogatja, így célszerű a rendszer metrikák naplókat azonban nem.</span><span class="sxs-lookup"><span data-stu-id="ae76d-237">Prometheus supports floating point data, but not string data, so it is appropriate for system metrics but not logs.</span></span>

- <span data-ttu-id="ae76d-238">Például egy irányítópult eszközzel **Kibana** vagy **Grafana** , az adatok megjelenítése és figyelése.</span><span class="sxs-lookup"><span data-stu-id="ae76d-238">Use a dashboard tool such as **Kibana** or **Grafana** to visualize and monitor the data.</span></span> <span data-ttu-id="ae76d-239">Az irányítópult szolgáltatás is futtathatja a fürt egy tárolóban.</span><span class="sxs-lookup"><span data-stu-id="ae76d-239">The dashboard service can also run inside a container in the cluster.</span></span>

<span data-ttu-id="ae76d-240">Az alkalmazásnaplók, fontolja meg **Fluentd** és **Elasticsearch**.</span><span class="sxs-lookup"><span data-stu-id="ae76d-240">For application logs, consider using **Fluentd** and **Elasticsearch**.</span></span> <span data-ttu-id="ae76d-241">Fluentd egy nyílt forráskódú adatgyűjtő, és az Elasticsearch a dokumentum-adatbázis, amely arra optimalizáltuk, hogy a keresőmotor-kiszolgálóként.</span><span class="sxs-lookup"><span data-stu-id="ae76d-241">Fluentd is an open source data collector, and Elasticsearch is a document database that is optimized to act as a search engine.</span></span> <span data-ttu-id="ae76d-242">Ezt a módszert használja, minden egyes szolgáltatás naplókat küld `stdout` és `stderr`, és a Kubernetes ezekbe az adatfolyamokba ír a helyi fájlrendszerben.</span><span class="sxs-lookup"><span data-stu-id="ae76d-242">Using this approach, each service sends logs to `stdout` and `stderr`, and Kubernetes writes these streams to the local file system.</span></span> <span data-ttu-id="ae76d-243">Fluentd összegyűjti a naplókat, igény szerint bővíti azokat a további metaadatokkal a Kubernetes és a naplókat küld az Elasticsearchbe.</span><span class="sxs-lookup"><span data-stu-id="ae76d-243">Fluentd collects the logs, optionally enriches them with additional metadata from Kubernetes, and sends the logs to Elasticsearch.</span></span> <span data-ttu-id="ae76d-244">Kibana, a Grafana vagy egy hasonló eszköz használatával hozzon létre egy irányítópultot az elasticsearch számára.</span><span class="sxs-lookup"><span data-stu-id="ae76d-244">Use Kibana, Grafana, or a similar tool to create a dashboard for Elasticsearch.</span></span> <span data-ttu-id="ae76d-245">A daemonset a fürtben, amely biztosítja, hogy egy Fluentd pod hozzá van rendelve minden csomóponton fut Fluentd.</span><span class="sxs-lookup"><span data-stu-id="ae76d-245">Fluentd runs as a daemonset in the cluster, which ensures that one Fluentd pod is assigned to each node.</span></span> <span data-ttu-id="ae76d-246">Kubelet-naplók, valamint a tároló naplóinak gyűjtéséhez Fluentd konfigurálhatja.</span><span class="sxs-lookup"><span data-stu-id="ae76d-246">You can configure Fluentd to collect kubelet logs as well as container logs.</span></span> <span data-ttu-id="ae76d-247">Nagy mennyiségben naplók írása a helyi fájlrendszerbe válhat teljesítménybeli szűk keresztmetszetek, különösen akkor, ha több szolgáltatás ugyanazon a csomóponton futnak.</span><span class="sxs-lookup"><span data-stu-id="ae76d-247">At high volumes, writing logs to the local file system could become a performance bottleneck, especially when multiple services are running on the same node.</span></span> <span data-ttu-id="ae76d-248">Figyelheti a késés és a fájl rendszer lemezhasználat éles környezetben.</span><span class="sxs-lookup"><span data-stu-id="ae76d-248">Monitor disk latency and file system utilization in production.</span></span>

<span data-ttu-id="ae76d-249">Egy Fluentd az Elasticsearch a naplók előnye, hogy a szolgáltatások nem szükséges további könyvtár függőségeit.</span><span class="sxs-lookup"><span data-stu-id="ae76d-249">One advantage of using Fluentd with Elasticsearch for logs is that services do not require any additional library dependencies.</span></span> <span data-ttu-id="ae76d-250">Minden egyes szolgáltatás csak ír `stdout` és `stderr`, és az Elasticsearch a naplók exportálása Fluentd kezeli.</span><span class="sxs-lookup"><span data-stu-id="ae76d-250">Each service just writes to `stdout` and `stderr`, and Fluentd handles exporting the logs into Elasticsearch.</span></span> <span data-ttu-id="ae76d-251">Megtudhatja, hogyan konfigurálhatja a naplózás infrastruktúra is, a csapatok szolgáltatások írása nem szükséges.</span><span class="sxs-lookup"><span data-stu-id="ae76d-251">Also, the teams writing services don't need to understand how to configure the logging infrastructure.</span></span> <span data-ttu-id="ae76d-252">Az egyik kihívás, hogy az Elasticsearch-fürt, éles környezet konfigurálása, úgy, hogy a méretezés a forgalom kezelésére.</span><span class="sxs-lookup"><span data-stu-id="ae76d-252">One challenge is to configure the Elasticsearch cluster for a production deployment, so that it scales to handle your traffic.</span></span> 

<span data-ttu-id="ae76d-253">Egy másik lehetőség, hogy az Operations Management Suite (OMS) Log Analytics naplók küldése.</span><span class="sxs-lookup"><span data-stu-id="ae76d-253">Another option is to send logs to Operations Management Suite (OMS) Log Analytics.</span></span> <span data-ttu-id="ae76d-254">A [Log Analytics] [ log-analytics] egy központi tárházba gyűjti naplóadatok szolgáltatást, és más Azure-szolgáltatások, az alkalmazás által használt adatokat blokktárolását.</span><span class="sxs-lookup"><span data-stu-id="ae76d-254">The [Log Analytics][log-analytics] service collects log data into a central repository, and can also consolidate data from other Azure services that your application uses.</span></span> <span data-ttu-id="ae76d-255">További információkért lásd: [monitorozása az Azure Container Service-fürt a Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span><span class="sxs-lookup"><span data-stu-id="ae76d-255">For more information, see [Monitor an Azure Container Service cluster with Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span></span>

## <a name="example-logging-with-correlation-ids"></a><span data-ttu-id="ae76d-256">Példa: Naplózás korrelációs azonosítók</span><span class="sxs-lookup"><span data-stu-id="ae76d-256">Example: Logging with correlation IDs</span></span>

<span data-ttu-id="ae76d-257">Egyes ebben a fejezetben ismertetett pontok megmutatják, Íme egy kiterjesztett példa hogyan a a csomag szolgáltatás biztosítja a naplózás.</span><span class="sxs-lookup"><span data-stu-id="ae76d-257">To illustrate some of the points discussed in this chapter, here is an extended example of how the Package service implements logging.</span></span> <span data-ttu-id="ae76d-258">A csomag szolgáltatás íródott, a TypeScript, és használja a [Koa](https://koajs.com/) Node.js webes keretrendszer.</span><span class="sxs-lookup"><span data-stu-id="ae76d-258">The Package service was written in TypeScript and uses the [Koa](https://koajs.com/) web framework for Node.js.</span></span> <span data-ttu-id="ae76d-259">Nincsenek számos Node.js naplózási függvénytárak közül választhat.</span><span class="sxs-lookup"><span data-stu-id="ae76d-259">There are several Node.js logging libraries to choose from.</span></span> <span data-ttu-id="ae76d-260">Hogy kivételezett [Winston](https://github.com/winstonjs/winston), a teljesítményre vonatkozó követelmények teljesítése tesztelt, amikor egy elterjedt naplózási könyvtár.</span><span class="sxs-lookup"><span data-stu-id="ae76d-260">We picked [Winston](https://github.com/winstonjs/winston), a popular logging library that met our performance requirements when we tested it.</span></span>

<span data-ttu-id="ae76d-261">A gyakorlati kivitelezés részleteinek tárolják, egy absztrakt meghatározott `ILogger` felületen:</span><span class="sxs-lookup"><span data-stu-id="ae76d-261">To encapsulate the implementation details, we defined an abstract  `ILogger` interface:</span></span>

```ts
export interface ILogger {
    log(level: string, msg: string, meta?: any)
    debug(msg: string, meta?: any)
    info(msg: string, meta?: any)
    warn(msg: string, meta?: any)
    error(msg: string, meta?: any)
}
```

<span data-ttu-id="ae76d-262">Íme egy `ILogger` megvalósítása, amely a Winston könyvtárban.</span><span class="sxs-lookup"><span data-stu-id="ae76d-262">Here is an `ILogger` implementation that wraps the Winston library.</span></span> <span data-ttu-id="ae76d-263">Konstruktor paramétereként a korrelációs Azonosítót vesz igénybe, és az azonosító kódtárba minden naplóüzenetre be.</span><span class="sxs-lookup"><span data-stu-id="ae76d-263">It takes the correlation ID as a constructor parameter, and injects the ID into every log message.</span></span> 

```ts
class WinstonLogger implements ILogger {
    constructor(private correlationId: string) {}
    log(level: string, msg: string, payload?: any) {
        var meta : any = {};
        if (payload) { meta.payload = payload };
        if (this.correlationId) { meta.correlationId = this.correlationId }
        winston.log(level, msg, meta)
    }
  
    info(msg: string, payload?: any) {
        this.log('info', msg, payload);
    }
    debug(msg: string, payload?: any) {
        this.log('debug', msg, payload);
    }
    warn(msg: string, payload?: any) {
        this.log('warn', msg, payload);
    }
    error(msg: string, payload?: any) {
        this.log('error', msg, payload);
    }
}
```

<span data-ttu-id="ae76d-264">A csomag szolgáltatást kell a korrelációs Azonosítót kinyerése a HTTP-kérelem.</span><span class="sxs-lookup"><span data-stu-id="ae76d-264">The Package service needs to extract the correlation ID from the HTTP request.</span></span> <span data-ttu-id="ae76d-265">Például ha linkerd használ, a korrelációs azonosító megtalálható a `l5d-ctx-trace` fejléc.</span><span class="sxs-lookup"><span data-stu-id="ae76d-265">For example, if you're using linkerd, the correlation ID is found in the `l5d-ctx-trace` header.</span></span> <span data-ttu-id="ae76d-266">A HTTP-kérelem Koa, a Context objektumot, amely a kérelemfeldolgozási folyamatot keresztülmegy van tárolva.</span><span class="sxs-lookup"><span data-stu-id="ae76d-266">In Koa, the HTTP request is stored in a Context object that gets passed through the request processing pipeline.</span></span> <span data-ttu-id="ae76d-267">A korrelációs Azonosítót a környezetből, és a naplózó inicializálása egy közbenső függvényt is meghatározzuk.</span><span class="sxs-lookup"><span data-stu-id="ae76d-267">We can define a middleware function to get the correlation ID from the Context and initialize the logger.</span></span> <span data-ttu-id="ae76d-268">(Egy közbenső Koa függvényt a egyszerűen függvény, amely lekéri az egyes kérések végrehajtása.)</span><span class="sxs-lookup"><span data-stu-id="ae76d-268">(A middleware function in Koa is simply a function that gets executed for each request.)</span></span>

```ts
export type CorrelationIdFn = (ctx: Context) => string;

export function logger(level: string, getCorrelationId: CorrelationIdFn) {
    winston.configure({ 
        level: level,
        transports: [new (winston.transports.Console)()]
        });
    return async function(ctx: any, next: any) {
        ctx.state.logger = new WinstonLogger(getCorrelationId(ctx));
        await next();
    }
}
```

<span data-ttu-id="ae76d-269">A közbenső szoftver meghívja a hívó által megadott függvény `getCorrelationId`beolvasásához a korrelációs azonosítót.</span><span class="sxs-lookup"><span data-stu-id="ae76d-269">This middleware invokes a caller-defined function, `getCorrelationId`, to get the correlation ID.</span></span> <span data-ttu-id="ae76d-270">Majd létrehoz egy példányt a naplózó és stashes azt `ctx.state`, azaz egy kulcs-érték szótára Koa keresztül adatokat átadni.</span><span class="sxs-lookup"><span data-stu-id="ae76d-270">Then it creates an instance of the logger and stashes it inside `ctx.state`, which is a key-value dictionary used in Koa to pass information through the pipeline.</span></span> 

<span data-ttu-id="ae76d-271">A naplózó közbenső kerül a folyamat indításakor:</span><span class="sxs-lookup"><span data-stu-id="ae76d-271">The logger middleware is added to the pipeline on startup:</span></span>

```ts
app.use(logger(Settings.logLevel(), function (ctx) {
    return ctx.headers[Settings.correlationHeader()];  
}));
```

<span data-ttu-id="ae76d-272">Miután minden be van állítva, könnyebbé vált a naplózási utasítások hozzá a kódot.</span><span class="sxs-lookup"><span data-stu-id="ae76d-272">Once everything is configured, it's easy to add logging statements to the code.</span></span> <span data-ttu-id="ae76d-273">Például a itt módszer, amely megkeresi az egy csomagot.</span><span class="sxs-lookup"><span data-stu-id="ae76d-273">For example, here is the method that looks up a package.</span></span> <span data-ttu-id="ae76d-274">Két hív a `ILogger.info` metódust.</span><span class="sxs-lookup"><span data-stu-id="ae76d-274">It makes two calls to the `ILogger.info` method.</span></span>

```ts
async getById(ctx: any, next: any) {
  var logger : ILogger = ctx.state.logger;
  var packageId = ctx.params.packageId;
  logger.info('Entering getById, packageId = %s', packageId);

  await next();

  let pkg = await this.repository.findPackage(ctx.params.packageId)

  if (pkg == null) {
    logger.info(`getById: %s not found`, packageId);
    ctx.response.status= 404;
    return;
  }

  ctx.response.status = 200;
  ctx.response.body = this.mapPackageDbToApi(pkg);
}
```

<span data-ttu-id="ae76d-275">Nincs szükségünk, a naplózás utasításokat tartalmazza a korrelációs Azonosítót, mert, amely a közbenső szoftver függvény által automatikusan történik.</span><span class="sxs-lookup"><span data-stu-id="ae76d-275">We don't need to include the correlation ID in the logging statements, because that's done automatically by the middleware function.</span></span> <span data-ttu-id="ae76d-276">Ez lehetővé teszi a naplózást kód tisztító, és csökkenti annak az esélyét, hogy a fejlesztő felejtse el tartalmazza a korrelációs azonosítót.</span><span class="sxs-lookup"><span data-stu-id="ae76d-276">This makes the logging code cleaner, and reduces the chance that a developer will forget to include the correlation ID.</span></span> <span data-ttu-id="ae76d-277">És mivel minden, a naplózás kimutatások használata az absztrakt `ILogger` felületen, könnyű lenne később naplózó megvalósítása helyett.</span><span class="sxs-lookup"><span data-stu-id="ae76d-277">And because all of the logging statements use the abstract `ILogger` interface, it would be easy to replace the logger implementation later.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="ae76d-278">A folyamatos integrációt és teljesítést</span><span class="sxs-lookup"><span data-stu-id="ae76d-278">Continuous integration and delivery</span></span>](./ci-cd.md)

<!-- links -->

[app-insights]: /azure/application-insights/app-insights-overview
[heapster]: https://github.com/kubernetes/heapster
[kube-state-metrics]: https://github.com/kubernetes/kube-state-metrics
[k8s-to-oms]: /azure/container-service/kubernetes/container-service-kubernetes-oms
[log-analytics]: /azure/log-analytics/