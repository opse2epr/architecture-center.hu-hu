---
title: Naplózás és figyelés a mikroszolgáltatások
description: Naplózás és figyelés a mikroszolgáltatások
author: MikeWasson
ms.date: 12/08/2017
ms.openlocfilehash: 1da67047daa9ae87cda5dd7dd581d6081183c428
ms.sourcegitcommit: 786bafefc731245414c3c1510fc21027afe303dc
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 12/12/2017
---
# <a name="designing-microservices-logging-and-monitoring"></a><span data-ttu-id="dad4d-103">Mikroszolgáltatások tervezése: naplózás és figyelés</span><span class="sxs-lookup"><span data-stu-id="dad4d-103">Designing microservices: Logging and monitoring</span></span>

<span data-ttu-id="dad4d-104">Bármely összetett alkalmazásban bármikor valami fog hiba lép fel.</span><span class="sxs-lookup"><span data-stu-id="dad4d-104">In any complex application, at some point something will go wrong.</span></span> <span data-ttu-id="dad4d-105">Egy mikroszolgáltatások alkalmazásban kell nyomon követnie, több tucatnyi vagy akár több száz szolgáltatások történéseiről.</span><span class="sxs-lookup"><span data-stu-id="dad4d-105">In a microservices application, you need to track what's happening across dozens or even hundreds of services.</span></span> <span data-ttu-id="dad4d-106">Naplózás és figyelés különösen fontos, hogy a rendszer átfogó képet biztosítson.</span><span class="sxs-lookup"><span data-stu-id="dad4d-106">Logging and monitoring are critically important to give you a holistic view of the system.</span></span> 

![](./images/monitoring.png)

<span data-ttu-id="dad4d-107">Mikroszolgáltatások architektúra, akkor különösen kihívást jelenthet rögzítési ponthoz hibák vagy a teljesítmény szűk pontos okát.</span><span class="sxs-lookup"><span data-stu-id="dad4d-107">In a microservices architecture, it can be especially challenging to pinpoint the exact cause of errors or performance bottlenecks.</span></span> <span data-ttu-id="dad4d-108">Egyetlen felhasználót span előfordulhat, hogy több szolgáltatásra.</span><span class="sxs-lookup"><span data-stu-id="dad4d-108">A single user operation might span multiple services.</span></span> <span data-ttu-id="dad4d-109">Szolgáltatások előfordulhat, hogy elérte a hálózati i/o-korlátok a fürtben található.</span><span class="sxs-lookup"><span data-stu-id="dad4d-109">Services may hit network I/O limits inside the cluster.</span></span> <span data-ttu-id="dad4d-110">Szolgáltatások közötti hívások láncolata ellennyomás okozhat a rendszer, ami nagy késleltetésű vagy egymásra épülő hibák.</span><span class="sxs-lookup"><span data-stu-id="dad4d-110">A chain of calls across services may cause backpressure in the system, resulting in high latency or cascading failures.</span></span> <span data-ttu-id="dad4d-111">Továbbá általában nem tudja melyik csomópontján egy adott konténerben fog futni.</span><span class="sxs-lookup"><span data-stu-id="dad4d-111">Moreover, you generally don't know which node a particular container will run in.</span></span> <span data-ttu-id="dad4d-112">Ugyanazon a csomóponton elhelyezett tárolók is lehet használják, a korlátozott CPU és memória.</span><span class="sxs-lookup"><span data-stu-id="dad4d-112">Containers placed on the same node may be competing for limited CPU or memory.</span></span> 

<span data-ttu-id="dad4d-113">Győződjön meg arról, mi történik az értelemben, hogy az alkalmazás kell kibocsátás telemetriai események.</span><span class="sxs-lookup"><span data-stu-id="dad4d-113">To make sense of what's happening, the application must emit telemetry events.</span></span> <span data-ttu-id="dad4d-114">Ezek a metrikák és a szöveges naplók rendezheti.</span><span class="sxs-lookup"><span data-stu-id="dad4d-114">You can categorize these into metrics and text-based logs.</span></span> 

<span data-ttu-id="dad4d-115">*Metrikák* numerikus érték, amely elemzése.</span><span class="sxs-lookup"><span data-stu-id="dad4d-115">*Metrics* are numerical values that can be analyzed.</span></span> <span data-ttu-id="dad4d-116">Használhatja őket megfigyelheti, a rendszer a valós idejű (vagy a közel valós időben), illetve időbeli teljesítménytrendek elemzéséhez.</span><span class="sxs-lookup"><span data-stu-id="dad4d-116">You can use them to observe the system in real time (or close to real time), or to analyze performance trends over time.</span></span> <span data-ttu-id="dad4d-117">Mérőszámok közé tartozik:</span><span class="sxs-lookup"><span data-stu-id="dad4d-117">Metrics include:</span></span>

- <span data-ttu-id="dad4d-118">Csomópont-szintű rendszer metrika, beleértve a CPU, a memória, a hálózati, a lemez és a rendszer használata.</span><span class="sxs-lookup"><span data-stu-id="dad4d-118">Node-level system metrics, including CPU, memory, network, disk, and file system usage.</span></span> <span data-ttu-id="dad4d-119">Rendszer mérőszámok segítenek megérteni a fürt minden csomópontja erőforrás-elosztás és hibáinak elhárításában kiugró.</span><span class="sxs-lookup"><span data-stu-id="dad4d-119">System metrics help you to understand resource allocation for each node in the cluster, and troubleshoot outliers.</span></span>
 
- <span data-ttu-id="dad4d-120">Kubernetes metrikákat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-120">Kubernetes metrics.</span></span> <span data-ttu-id="dad4d-121">Szolgáltatások futnak-tárolókban, mert kell gyűjteni a processzorhasználatról, a tároló szintjén, nem csak a virtuális gép szinten.</span><span class="sxs-lookup"><span data-stu-id="dad4d-121">Because services run in containers, you need to collect metrics at the container level, not just at the VM level.</span></span> <span data-ttu-id="dad4d-122">A Kubernetes cAdvisor (tároló Advisor) az ügynök által összegyűjtött statisztikai adatok a CPU, a memória, a fájlrendszer és a használt hálózati erőforrások minden egyes tároló.</span><span class="sxs-lookup"><span data-stu-id="dad4d-122">In Kubernetes, cAdvisor (Container Advisor) is the agent that collects statistics about the CPU, memory, file system, and network resources used by each container.</span></span> <span data-ttu-id="dad4d-123">A kubelet démon cAdvisor erőforrás statisztikákat gyűjt, és elérhetővé teszi azokat a REST API-n keresztül.</span><span class="sxs-lookup"><span data-stu-id="dad4d-123">The kubelet daemon collects resource statistics from cAdvisor and exposes them through a REST API.</span></span>
   
- <span data-ttu-id="dad4d-124">Alkalmazás metrikákat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-124">Application metrics.</span></span> <span data-ttu-id="dad4d-125">Ez magában foglalja a metrikákat, amely kapcsolódik a szolgáltatás működésének megértése.</span><span class="sxs-lookup"><span data-stu-id="dad4d-125">This includes any metrics that are relevant to understanding the behavior of a service.</span></span> <span data-ttu-id="dad4d-126">Például a várólistán lévő bejövő HTTP-kérelmekre, a kérés várakozási ideje, az üzenet-várólista hossza vagy a másodpercenként feldolgozott tranzakciók száma száma.</span><span class="sxs-lookup"><span data-stu-id="dad4d-126">Examples include the number of queued inbound HTTP requests, request latency, message queue length, or number of transactions processed per second.</span></span>

- <span data-ttu-id="dad4d-127">Függő szolgáltatások metrikákat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-127">Dependent service metrics.</span></span> <span data-ttu-id="dad4d-128">A fürtben található szolgáltatások kérhet például kezelt PaaS-szolgáltatások, a fürtön kívüli külső szolgáltatásokat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-128">Services inside the cluster may call external services that are outside the cluster, such as managed PaaS services.</span></span> <span data-ttu-id="dad4d-129">Az Azure-szolgáltatásokat is figyelhet használatával [Azure figyelő](/azure/monitoring-and-diagnostics/monitoring-overview).</span><span class="sxs-lookup"><span data-stu-id="dad4d-129">You can monitor Azure services by using [Azure Monitor](/azure/monitoring-and-diagnostics/monitoring-overview).</span></span> <span data-ttu-id="dad4d-130">Harmadik féltől származó szolgáltatással is, vagy nem rendelkezhetnek bármely metrikákat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-130">Third-party services may or may not provide any metrics.</span></span> <span data-ttu-id="dad4d-131">Ha nem, akkor konfigurálnia kell a saját alkalmazás metrikák késleltetés és a Hibaarány statisztikáinak nyomon követéséhez támaszkodnak.</span><span class="sxs-lookup"><span data-stu-id="dad4d-131">If not, you'll have to rely on your own application metrics to track statistics for latency and error rate.</span></span>

<span data-ttu-id="dad4d-132">*Naplók* bejegyzései az alkalmazás futása közben bekövetkező eseményekről.</span><span class="sxs-lookup"><span data-stu-id="dad4d-132">*Logs* are records of events that occur while the application is running.</span></span> <span data-ttu-id="dad4d-133">Ezek közé tartozik többek között a alkalmazásnaplók (nyomkövetési utasítások) vagy a webkiszolgáló naplóinak.</span><span class="sxs-lookup"><span data-stu-id="dad4d-133">They include things like application logs (trace statements) or web server logs.</span></span> <span data-ttu-id="dad4d-134">Naplók esetében elsősorban akkor hasznos, a vizsgálatokhoz és a legfelső szintű alapprobléma elemzéséhez.</span><span class="sxs-lookup"><span data-stu-id="dad4d-134">Logs are primarily useful for forensics and root cause analysis.</span></span> 

## <a name="considerations"></a><span data-ttu-id="dad4d-135">Megfontolandó szempontok</span><span class="sxs-lookup"><span data-stu-id="dad4d-135">Considerations</span></span>

<span data-ttu-id="dad4d-136">A cikk [megfigyelési és diagnosztikai](../best-practices/monitoring.md) egy alkalmazás általános bevált gyakorlat ismertetése.</span><span class="sxs-lookup"><span data-stu-id="dad4d-136">The article [Monitoring and diagnostics](../best-practices/monitoring.md) describes general best practices for monitoring an application.</span></span> <span data-ttu-id="dad4d-137">A következőkben adott mikroszolgáltatások architektúrájának környezetében gondolniuk.</span><span class="sxs-lookup"><span data-stu-id="dad4d-137">Here are some particular things to think about in the context of a microservices architecture.</span></span>

<span data-ttu-id="dad4d-138">**Konfigurációs és felügyeleti**.</span><span class="sxs-lookup"><span data-stu-id="dad4d-138">**Configuration and management**.</span></span> <span data-ttu-id="dad4d-139">A naplózás és figyelés felügyelt szolgáltatást használ, vagy hoz naplózásának és figyelésének összetevők a fürtben található tárolóként telepíteni?</span><span class="sxs-lookup"><span data-stu-id="dad4d-139">Will you use a managed service for logging and monitoring, or deploy logging and monitoring components as containers inside the cluster?</span></span> <span data-ttu-id="dad4d-140">Ezek a beállítások több tárgyalását című témakör [technológia beállítások](#technology-options) alatt.</span><span class="sxs-lookup"><span data-stu-id="dad4d-140">For more discussion of these options, see the section [Technology Options](#technology-options) below.</span></span>

<span data-ttu-id="dad4d-141">**Adatfeldolgozást arány**.</span><span class="sxs-lookup"><span data-stu-id="dad4d-141">**Ingestion rate**.</span></span> <span data-ttu-id="dad4d-142">Mi az az átviteli sebesség, amellyel a rendszer fogadására képes, telemetriai események?</span><span class="sxs-lookup"><span data-stu-id="dad4d-142">What is the throughput at which the system can ingest telemetry events?</span></span> <span data-ttu-id="dad4d-143">Mi történik, ha adott aránya túllépi?</span><span class="sxs-lookup"><span data-stu-id="dad4d-143">What happens if that rate is exceeded?</span></span> <span data-ttu-id="dad4d-144">Például a rendszer lehetséges, hogy sávszélesség-szabályozási ügyfelek, ebben az esetben telemetriai adatok nem vesztek el, vagy előfordulhat, hogy az adatok felbontásának.</span><span class="sxs-lookup"><span data-stu-id="dad4d-144">For example, the system may throttle clients, in which case telemetry data is lost, or it may downsample the data.</span></span> <span data-ttu-id="dad4d-145">Ez a probléma néha csökkentheti a begyűjtött adatok mennyiségét csökkenti:</span><span class="sxs-lookup"><span data-stu-id="dad4d-145">Sometimes you can mitigate this problem by reducing the amount of data that you collect:</span></span>

  - <span data-ttu-id="dad4d-146">Metrikák összesítése statisztikákat, pl.: átlagos és a szórást, kiszámításával és statisztikai adatokat küldeni a felügyeleti rendszer.</span><span class="sxs-lookup"><span data-stu-id="dad4d-146">Aggregate metrics by calculating statistics, such as average and standard deviation, and send that statistical data to the monitoring system.</span></span>  

  - <span data-ttu-id="dad4d-147">Az adatok felbontásának &mdash; Ez azt jelenti, hogy az csak az események százalékát feldolgozni.</span><span class="sxs-lookup"><span data-stu-id="dad4d-147">Downsample the data &mdash; that is, process only a percentage of the events.</span></span>

  - <span data-ttu-id="dad4d-148">Kötegelt az adatokat az állapotfigyelő szolgáltatás hálózati hívások számának csökkentése érdekében.</span><span class="sxs-lookup"><span data-stu-id="dad4d-148">Batch the data to reduce the number of network calls to the monitoring service.</span></span>

<span data-ttu-id="dad4d-149">**Költség**.</span><span class="sxs-lookup"><span data-stu-id="dad4d-149">**Cost**.</span></span> <span data-ttu-id="dad4d-150">Lehet, hogy magas, különösen a nagy mennyiségük választásával dolgozhat fel, és tárolja a telemetriai adatokat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-150">The cost of ingesting and storing telemetry data may be high, especially at high volumes.</span></span> <span data-ttu-id="dad4d-151">Bizonyos esetekben sikerült is lehet az alkalmazás futtatásának.</span><span class="sxs-lookup"><span data-stu-id="dad4d-151">In some cases it could even exceed the cost of running the application.</span></span> <span data-ttu-id="dad4d-152">Ebben az esetben előfordulhat, hogy csökkenteni kell a telemetriai adatok mennyiségének összesítése, egyszerűsítés, vagy az adatok kötegelés fent leírt módon.</span><span class="sxs-lookup"><span data-stu-id="dad4d-152">In that case, you may need to reduce the volume of telemetry by aggregating, downsampling, or batching the data, as described above.</span></span> 
        
<span data-ttu-id="dad4d-153">**Adatok rögzített**.</span><span class="sxs-lookup"><span data-stu-id="dad4d-153">**Data fidelity**.</span></span> <span data-ttu-id="dad4d-154">Hogyan pontos vannak a metrikák?</span><span class="sxs-lookup"><span data-stu-id="dad4d-154">How accurate are the metrics?</span></span> <span data-ttu-id="dad4d-155">Átlagok kiugró, főleg nagyobb méretezésnél elrejthetők.</span><span class="sxs-lookup"><span data-stu-id="dad4d-155">Averages can hide outliers, especially at scale.</span></span> <span data-ttu-id="dad4d-156">Is ha a mintavételi ráta értéke túl alacsony, azt is simítja ingadozásai az adatokat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-156">Also, if the sampling rate is too low, it can smooth out fluctuations in the data.</span></span> <span data-ttu-id="dad4d-157">Tűnhet, hogy a összes kérelem kapcsolatos végpont ugyanolyan késéssel, lehet, ha ténylegesen végzése sokkal hosszabb kérelmek jelentős része.</span><span class="sxs-lookup"><span data-stu-id="dad4d-157">It may appear that all requests have about the same end-to-end latency, when in fact a significant fraction of requests are taking much longer.</span></span> 

<span data-ttu-id="dad4d-158">**Késés**.</span><span class="sxs-lookup"><span data-stu-id="dad4d-158">**Latency**.</span></span> <span data-ttu-id="dad4d-159">Engedélyezi a valós idejű figyelés és a riasztások, telemetriai adatokat kell biztosítani gyorsan.</span><span class="sxs-lookup"><span data-stu-id="dad4d-159">To enable real-time monitoring and alerts, telemetry data should be available quickly.</span></span> <span data-ttu-id="dad4d-160">Hogyan "valós idejű" van a figyelési irányítópulton megjelenő adatokat?</span><span class="sxs-lookup"><span data-stu-id="dad4d-160">How "real-time" is the data that appears on the monitoring dashboard?</span></span> <span data-ttu-id="dad4d-161">Néhány másodperc régi?</span><span class="sxs-lookup"><span data-stu-id="dad4d-161">A few seconds old?</span></span> <span data-ttu-id="dad4d-162">Tovább egy percnél?</span><span class="sxs-lookup"><span data-stu-id="dad4d-162">More than a minute?</span></span>

<span data-ttu-id="dad4d-163">**Tárolás.**</span><span class="sxs-lookup"><span data-stu-id="dad4d-163">**Storage.**</span></span> <span data-ttu-id="dad4d-164">A naplókhoz lehet leghatékonyabb írni a naplóeseményeket a fürt rövid élettartamú tárhelyre, és küldje el a naplófájlok több állandó tároló az ügynök konfigurálása.</span><span class="sxs-lookup"><span data-stu-id="dad4d-164">For logs, it may be most efficient to write the log events to ephemeral storage in the cluster, and configure an agent to ship the log files to more persistent storage.</span></span>  <span data-ttu-id="dad4d-165">Adatok végül kívánja helyezni a hosszú távú, hogy az utólagos elemzés érhető el.</span><span class="sxs-lookup"><span data-stu-id="dad4d-165">Data should eventually be moved to long-term storage so that it's available for retrospective analysis.</span></span> <span data-ttu-id="dad4d-166">Egy mikroszolgáltatások architektúra hozhat létre a telemetriai adatok nagy mennyiségű, így az adott adattárolás díja fontos szempont.</span><span class="sxs-lookup"><span data-stu-id="dad4d-166">A microservices architecture can generate a large volume of telemetry data, so the cost of storing that data is an important consideration.</span></span> <span data-ttu-id="dad4d-167">Is gondolja át, hogyan fogja kérdezni az adatokat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-167">Also consider how you will query the data.</span></span> 

<span data-ttu-id="dad4d-168">**Irányítópult és a képi megjelenítés.**</span><span class="sxs-lookup"><span data-stu-id="dad4d-168">**Dashboard and visualization.**</span></span> <span data-ttu-id="dad4d-169">Kapunk egy átfogó képet, a rendszer az összes szolgáltatását, mind a fürt és a külső szolgáltatások között?</span><span class="sxs-lookup"><span data-stu-id="dad4d-169">Do you get a holistic view of the system, across all of the services, both within the cluster and external services?</span></span> <span data-ttu-id="dad4d-170">Ha telemetriai adatok és a naplók egynél több helyre, az irányítópult megjelenítése az összes is összefüggéseket?</span><span class="sxs-lookup"><span data-stu-id="dad4d-170">If you are writing telemetry data and logs to more than one location, can the dashboard show all of them and correlate?</span></span> <span data-ttu-id="dad4d-171">A figyelési irányítópult megjelenítése kell legalább a következő információkat:</span><span class="sxs-lookup"><span data-stu-id="dad4d-171">The monitoring dashboard should show at least the following information:</span></span>

- <span data-ttu-id="dad4d-172">Általános erőforrás-elosztás kapacitás és a növekedési.</span><span class="sxs-lookup"><span data-stu-id="dad4d-172">Overall resource allocation for capacity and growth.</span></span> <span data-ttu-id="dad4d-173">Ez magában foglalja a tárolók, fájl rendszer metrikákat, hálózati és core foglalási száma.</span><span class="sxs-lookup"><span data-stu-id="dad4d-173">This includes the number of containers, file system metrics, network, and core allocation.</span></span>
- <span data-ttu-id="dad4d-174">Tároló metrikák korrelált a szolgáltatás szintjén.</span><span class="sxs-lookup"><span data-stu-id="dad4d-174">Container metrics correlated at the service level.</span></span>
- <span data-ttu-id="dad4d-175">Rendszer metrikák tárolók tartozzanak.</span><span class="sxs-lookup"><span data-stu-id="dad4d-175">System metrics correlated with containers.</span></span>
- <span data-ttu-id="dad4d-176">Hibákat és kiugró.</span><span class="sxs-lookup"><span data-stu-id="dad4d-176">Service errors and outliers.</span></span>
    

## <a name="distributed-tracing"></a><span data-ttu-id="dad4d-177">Elosztott nyomkövetése</span><span class="sxs-lookup"><span data-stu-id="dad4d-177">Distributed tracing</span></span>

<span data-ttu-id="dad4d-178">Ahogy azt korábban említettük, az egyik kihívás a mikroszolgáltatások események áramló van szolgáltatásban ismertetése.</span><span class="sxs-lookup"><span data-stu-id="dad4d-178">As mentioned, one challenge in microservices is understanding the flow of events across services.</span></span> <span data-ttu-id="dad4d-179">Egy egyetlen művelet, vagy a tranzakció magában foglalhatja hívások vonatkozik több szolgáltatásra.</span><span class="sxs-lookup"><span data-stu-id="dad4d-179">A single operation or transaction may involve calls to multiple services.</span></span> <span data-ttu-id="dad4d-180">Hozza létre újból a teljes feladatütemezési lépéseket, hogy egyes szolgáltatások propagálása kell egy *korrelációs azonosító* , amely úgy működik, mint ennek a műveletnek egyedi azonosítója.</span><span class="sxs-lookup"><span data-stu-id="dad4d-180">To reconstruct the entire sequence of steps, each service should propagate a *correlation ID* that acts as a unique identifier for that operation.</span></span> <span data-ttu-id="dad4d-181">A korrelációs azonosító lehetővé teszi, hogy [nyomkövetés elosztott](http://microservices.io/patterns/observability/distributed-tracing.html) szolgáltatásban.</span><span class="sxs-lookup"><span data-stu-id="dad4d-181">The correlation ID enables [distributed tracing](http://microservices.io/patterns/observability/distributed-tracing.html) across services.</span></span>

<span data-ttu-id="dad4d-182">Az első szolgáltatás, amely fogad egy ügyfél kérelmet kell létrehozni a korrelációs azonosítója.</span><span class="sxs-lookup"><span data-stu-id="dad4d-182">The first service that receives a client request should generate the correlation ID.</span></span> <span data-ttu-id="dad4d-183">Ha a szolgáltatás hívást egy HTTP egy másik szolgáltatás, a korrelációs azonosító fejléc az helyezi el.</span><span class="sxs-lookup"><span data-stu-id="dad4d-183">If the service makes an HTTP call to another service, it puts the correlation ID in a request header.</span></span> <span data-ttu-id="dad4d-184">Hasonlóképpen ha a szolgáltatás aszinkron üzenetet küld, helyezi el a korrelációs azonosító az üzenetbe.</span><span class="sxs-lookup"><span data-stu-id="dad4d-184">Similarly, if the service sends an asynchronous message, it puts the correlation ID into the message.</span></span> <span data-ttu-id="dad4d-185">Alárendelt szolgáltatásokkal továbbra is a korrelációs azonosító propagálására, hogy azt a teljes rendszer áthaladó.</span><span class="sxs-lookup"><span data-stu-id="dad4d-185">Downstream services continue to propagate the correlation ID, so that it flows through the entire system.</span></span> <span data-ttu-id="dad4d-186">Emellett minden kódot írja az alkalmazás metrikák vagy a napló események tartalmaznia kell a korrelációs azonosítója.</span><span class="sxs-lookup"><span data-stu-id="dad4d-186">In addition, all code that writes application metrics or log events should include the correlation ID.</span></span>

<span data-ttu-id="dad4d-187">Hívások közötti kapcsolatot, ha például a végpontok közötti késés a teljes tranzakció, a sikeres tranzakciók másodpercenkénti száma és a sikertelen tranzakciók százaléka működési metrikák is kiszámíthatja.</span><span class="sxs-lookup"><span data-stu-id="dad4d-187">When service calls are correlated, you can calculate operational metrics such as the end-to-end latency for a complete transaction, the number of successful transactions per second, and the percentage of failed transactions.</span></span> <span data-ttu-id="dad4d-188">Többek között a korrelációs azonosító alkalmazásnaplók lehetővé teszi kiváltó okának elemzése végrehajtásához.</span><span class="sxs-lookup"><span data-stu-id="dad4d-188">Including correlation IDs in application logs makes it possible to perform root cause analysis.</span></span> <span data-ttu-id="dad4d-189">Egy művelet meghiúsul, ha a log utasítások található összes a szolgáltatáshoz intézett hívások szereplő ugyanazt a műveletet.</span><span class="sxs-lookup"><span data-stu-id="dad4d-189">If an operation fails, you can find the log statements for all of the service calls that were part of the same operation.</span></span> 

<span data-ttu-id="dad4d-190">Elosztott nyomkövetés végrehajtása során az alábbiakban néhány szempontok:</span><span class="sxs-lookup"><span data-stu-id="dad4d-190">Here are some considerations when implementing distributed tracing:</span></span>

- <span data-ttu-id="dad4d-191">Jelenleg nincs korrelációs azonosító szabványos HTTP-fejléc.</span><span class="sxs-lookup"><span data-stu-id="dad4d-191">There is currently no standard HTTP header for correlation IDs.</span></span> <span data-ttu-id="dad4d-192">A csoport értéket meg kell szabványosítására.</span><span class="sxs-lookup"><span data-stu-id="dad4d-192">Your team should standardize on a custom header value.</span></span> <span data-ttu-id="dad4d-193">A választott határozzák meg a naplózási/figyelési keretrendszer vagy a választott szolgáltatás háló.</span><span class="sxs-lookup"><span data-stu-id="dad4d-193">The choice may be decided by your logging/monitoring framework or choice of service mesh.</span></span>

- <span data-ttu-id="dad4d-194">Aszinkron üzenetek Ha az üzenetkezelési infrastruktúra támogatja az üzenetek, hozzáadását metaadatok kell foglalni a korrelációs azonosító, a metaadatok.</span><span class="sxs-lookup"><span data-stu-id="dad4d-194">For asynchronous messages, if your messaging infrastructure supports adding metadata to messages, you should include the correlation ID as metadata.</span></span> <span data-ttu-id="dad4d-195">Ellenkező esetben adja hozzá az üzenet-séma részeként.</span><span class="sxs-lookup"><span data-stu-id="dad4d-195">Otherwise, include it as part of the message schema.</span></span>

- <span data-ttu-id="dad4d-196">Ahelyett, hogy egyetlen átlátszatlan azonosítót, előfordulhat, hogy küldjön egy *korrelációs környezet* , amely részletesebb információkat, például a hívó által hívott kapcsolatok tartalmazza.</span><span class="sxs-lookup"><span data-stu-id="dad4d-196">Rather than a single opaque identifier, you might send a *correlation context* that includes richer information, such as caller-callee relationships.</span></span> 

- <span data-ttu-id="dad4d-197">Az Azure Application Insights SDK automatikusan be HTTP-fejlécek korrelációs környezet esetében, és az Application Insights-logs magában foglalja a korrelációs azonosító.</span><span class="sxs-lookup"><span data-stu-id="dad4d-197">The Azure Application Insights SDK automatically injects correlation context into HTTP headers, and includes the correlation ID in Application Insights logs.</span></span> <span data-ttu-id="dad4d-198">Ha úgy dönt, hogy az Application Insights épített korrelációs használatát, bizonyos szolgáltatások lehet szükség a korrelációs fejlécek, attól függően, hogy a használt könyvtárak explicit módon terjesztése.</span><span class="sxs-lookup"><span data-stu-id="dad4d-198">If you decide to use the correlation features built into Application Insights, some services may still need to explicitly propagate the correlation headers, depending on the libraries being used.</span></span> <span data-ttu-id="dad4d-199">További információkért lásd: [az Application Insights Telemetria korrelációs](/azure/application-insights/application-insights-correlation).</span><span class="sxs-lookup"><span data-stu-id="dad4d-199">For more information, see [Telemetry correlation in Application Insights](/azure/application-insights/application-insights-correlation).</span></span>
   
- <span data-ttu-id="dad4d-200">Ha használunk szolgáltatás rácsvonal Istio vagy linkerd, ezek a technológiák automatikusan generáljon korrelációs fejlécek HTTP-hívások révén a szolgáltatás háló proxyk legyenek átirányítva.</span><span class="sxs-lookup"><span data-stu-id="dad4d-200">If you are using Istio or linkerd as a service mesh, these technologies automatically generate correlation headers when HTTP calls are routed through the service mesh proxies.</span></span> <span data-ttu-id="dad4d-201">Szolgáltatások továbbítsa a megfelelő fejléceket.</span><span class="sxs-lookup"><span data-stu-id="dad4d-201">Services should forward the relevant headers.</span></span> 

    - <span data-ttu-id="dad4d-202">Istio: [elosztott kérelmek nyomkövetése](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span><span class="sxs-lookup"><span data-stu-id="dad4d-202">Istio: [Distributed Request Tracing](https://istio-releases.github.io/v0.1/docs/tasks/zipkin-tracing.html)</span></span>
    
    - <span data-ttu-id="dad4d-203">linkerd: [környezeti fejléceket](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span><span class="sxs-lookup"><span data-stu-id="dad4d-203">linkerd: [Context Headers](https://linkerd.io/config/1.3.0/linkerd/index.html#http-headers)</span></span>
    
- <span data-ttu-id="dad4d-204">Vegye figyelembe, hogyan fogja naplók összevonásakor.</span><span class="sxs-lookup"><span data-stu-id="dad4d-204">Consider how you will aggregate logs.</span></span> <span data-ttu-id="dad4d-205">Érdemes lehet a naplókban korrelációs azonosító hozzáadásának a módját a csapatok szabványosítására.</span><span class="sxs-lookup"><span data-stu-id="dad4d-205">You may want to standardize across teams on how to include correlation IDs in logs.</span></span> <span data-ttu-id="dad4d-206">Strukturált vagy félig strukturált formátumban, például a JSON-NÁ, és adja meg egy közös mező ahhoz, hogy a korrelációs azonosítója.</span><span class="sxs-lookup"><span data-stu-id="dad4d-206">Use a structured or semi-structured format, such as JSON, and define a common field to hold the correlation ID.</span></span>

## <a name="technology-options"></a><span data-ttu-id="dad4d-207">Technológia beállítások</span><span class="sxs-lookup"><span data-stu-id="dad4d-207">Technology options</span></span>

<span data-ttu-id="dad4d-208">**Az Application Insights** egy felügyelt szolgáltatás, amely ingests és tárolja a telemetriai adatokat, és elemzésével, és az adatok kereséséhez eszközöket biztosít az Azure-ban.</span><span class="sxs-lookup"><span data-stu-id="dad4d-208">**Application Insights** is a managed service in Azure that ingests and stores telemetry data, and provides tools for analyzing and searching the data.</span></span> <span data-ttu-id="dad4d-209">Az Application Insights használatához egy instrumentation csomag az alkalmazás telepítése.</span><span class="sxs-lookup"><span data-stu-id="dad4d-209">To use Application Insights, you install an instrumentation package in your application.</span></span> <span data-ttu-id="dad4d-210">Ez a csomag az alkalmazás figyeli, és telemetriai adatokat küld az Application Insights szolgáltatással.</span><span class="sxs-lookup"><span data-stu-id="dad4d-210">This package monitors the app and sends telemetry data to the Application Insights service.</span></span> <span data-ttu-id="dad4d-211">Azt is le, hogy a gazdagép-környezetben telemetriai adatait.</span><span class="sxs-lookup"><span data-stu-id="dad4d-211">It can also pull telemetry data from the host environment.</span></span> <span data-ttu-id="dad4d-212">Az Application Insights biztosít, beépített korrelációs és függőségi nyomon követését.</span><span class="sxs-lookup"><span data-stu-id="dad4d-212">Application Insights provides built-in correlation and dependency tracking.</span></span> <span data-ttu-id="dad4d-213">Lehetővé teszi a rendszer metrikákat, alkalmazás metrikák és az Azure szolgáltatás metrika, egyetlen helyen követik.</span><span class="sxs-lookup"><span data-stu-id="dad4d-213">It lets you track system metrics, application metrics, and Azure service metrics, all in one place.</span></span>

<span data-ttu-id="dad4d-214">Vegye figyelembe, hogy az Application Insights azelőtt gyorsítja fel, ha a adatok meghaladja a maximálisan megengedettet; További információkért lásd: [korlátozza az Application Insights](/azure/azure-subscription-service-limits#application-insights-limits).</span><span class="sxs-lookup"><span data-stu-id="dad4d-214">Be aware that Application Insights throttles if the data rate exceeds a maximum limit; for details, see [Application Insights limits](/azure/azure-subscription-service-limits#application-insights-limits).</span></span> <span data-ttu-id="dad4d-215">Egyetlen művelettel hozhat létre több telemetriai események, ezért, ha az alkalmazás a forgalom nagy mennyiségű valószínű halmozódni beolvasása.</span><span class="sxs-lookup"><span data-stu-id="dad4d-215">A single operation may generate several telemetry events, so if the application experiences a high volume of traffic, it is likely to get throttled.</span></span> <span data-ttu-id="dad4d-216">Ez a probléma mérséklése érdekében a telemetriai adatok forgalom csökkentése érdekében mintavételi végezheti el.</span><span class="sxs-lookup"><span data-stu-id="dad4d-216">To mitigate this problem, you can perform sampling to reduce the telemetry traffic.</span></span> <span data-ttu-id="dad4d-217">Mi a fontosabb: az, hogy a metrikákat kevésbé lesznek pontosak.</span><span class="sxs-lookup"><span data-stu-id="dad4d-217">The tradeoff is that your metrics will be less precise.</span></span> <span data-ttu-id="dad4d-218">További információkért lásd: [az Application Insightsban mintavételi](/azure/application-insights/app-insights-sampling).</span><span class="sxs-lookup"><span data-stu-id="dad4d-218">For more information, see [Sampling in Application Insights](/azure/application-insights/app-insights-sampling).</span></span> <span data-ttu-id="dad4d-219">Az adatmennyiség csökkentése érdekében által előre összesítése metrikák &mdash; Ez azt jelenti, például átlag és szórás statisztikai értékek kiszámítása, és ezeket az értékeket a nyers telemetriaadatok helyett küld.</span><span class="sxs-lookup"><span data-stu-id="dad4d-219">You can also reduce the data volume by pre-aggregating metrics &mdash; that is, calculating statistical values such as average and standard deviation, and sending those values instead of the raw telemetry.</span></span> <span data-ttu-id="dad4d-220">A következő blogbejegyzés ismerteti egy Application Insights segítségével léptékű módjáról: [Azure figyelése és az elemzések léptékű](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span><span class="sxs-lookup"><span data-stu-id="dad4d-220">The following blog post describes an approach to using Application Insights at scale: [Azure Monitoring and Analytics at Scale](https://blogs.msdn.microsoft.com/azurecat/2017/05/11/azure-monitoring-and-analytics-at-scale/).</span></span>

<span data-ttu-id="dad4d-221">Ezenkívül győződjön meg arról, hogy tudomásul veszi a árképzési modellt az Application Insights, mert adatmennyiség alapján van szó.</span><span class="sxs-lookup"><span data-stu-id="dad4d-221">In addition, make sure that you understand the pricing model for Application Insights, because you are charged based on data volume.</span></span> <span data-ttu-id="dad4d-222">További információkért lásd: [kezelése az Application Insightsban tarifa- és adatok kötet](/azure/application-insights/app-insights-pricing).</span><span class="sxs-lookup"><span data-stu-id="dad4d-222">For more information, see [Manage pricing and data volume in Application Insights](/azure/application-insights/app-insights-pricing).</span></span> <span data-ttu-id="dad4d-223">Ha az alkalmazás telemetriai nagy mennyiségű hoz létre, és nem kíván végrehajtani mintavételi vagy az adatok összesítését, majd az Application Insights nem lehet a megfelelő választás.</span><span class="sxs-lookup"><span data-stu-id="dad4d-223">If your application generates a large volume of telemetry, and you don't wish to perform sampling or aggregation of the data, then Application Insights may not be the appropriate choice.</span></span> 

<span data-ttu-id="dad4d-224">Az Application Insights nem felel meg a követelményeknek, ha az alábbiakban néhány javasolt különböző módszer népszerű nyílt forráskódú technológiák használata.</span><span class="sxs-lookup"><span data-stu-id="dad4d-224">If Application Insights doesn't meet your requirements, here are some suggested approaches that use popular open-source technologies.</span></span>

<span data-ttu-id="dad4d-225">A rendszer és a tároló metrika, fontolja meg a metrikák exportálása egy idősorozat adatbázis, mint **Prometheus** vagy **InfluxDB** a fürtön.</span><span class="sxs-lookup"><span data-stu-id="dad4d-225">For system and container metrics, consider exporting metrics to a time-series database such as **Prometheus** or **InfluxDB** running in the cluster.</span></span>

- <span data-ttu-id="dad4d-226">InfluxDB egy leküldéses rendszerbe.</span><span class="sxs-lookup"><span data-stu-id="dad4d-226">InfluxDB is a push-based system.</span></span> <span data-ttu-id="dad4d-227">A metrikák leküldéses kell egy ügynököt.</span><span class="sxs-lookup"><span data-stu-id="dad4d-227">An agent needs to push the metrics.</span></span> <span data-ttu-id="dad4d-228">Használhat [Heapster][heapster], amely egy szolgáltatás, amely kubelet, a fürtre vonatkozó metrikákat gyűjtő összesíti az adatokat, és InfluxDB vagy más idősorozat tárolási megoldás leküldi.</span><span class="sxs-lookup"><span data-stu-id="dad4d-228">You can use [Heapster][heapster], which is a service that collects cluster-wide metrics from kubelet, aggregates the data, and pushes it to InfluxDB or other time-series storage solution.</span></span> <span data-ttu-id="dad4d-229">Az Azure Tárolószolgáltatás Heapster a fürt telepítés részeként telepíti.</span><span class="sxs-lookup"><span data-stu-id="dad4d-229">Azure Container Service deploys Heapster as part of the cluster setup.</span></span> <span data-ttu-id="dad4d-230">Másik lehetőségként [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), amely egy olyan ügynök összegyűjtésére és metrikákat reporting.</span><span class="sxs-lookup"><span data-stu-id="dad4d-230">Another option is [Telegraf](https://www.influxdata.com/time-series-platform/telegraf/), which is an agent for collecting and reporting metrics.</span></span> 

- <span data-ttu-id="dad4d-231">Prometheus egy olyan lekérésalapú rendszer.</span><span class="sxs-lookup"><span data-stu-id="dad4d-231">Prometheus is a pull-based system.</span></span> <span data-ttu-id="dad4d-232">A konfigurált helyeket metrikák rendszeresen scrapes.</span><span class="sxs-lookup"><span data-stu-id="dad4d-232">It periodically scrapes metrics from configured locations.</span></span> <span data-ttu-id="dad4d-233">Prometheus is scrape metrikák cAdvisor vagy kube-állapot-metrikák állítja elő.</span><span class="sxs-lookup"><span data-stu-id="dad4d-233">Prometheus can scrape metrics generated by cAdvisor or kube-state-metrics.</span></span> <span data-ttu-id="dad4d-234">[kube-állapot-metrikák] [ kube-state-metrics] metrikák gyűjti össze a Kubernetes API-kiszolgálóhoz, és elérhetővé teszi azokat Prometheus (vagy egy Prometheus ügyfél végpont kompatibilis kaparóként) szolgáltatás.</span><span class="sxs-lookup"><span data-stu-id="dad4d-234">[kube-state-metrics][kube-state-metrics] is a service that collects metrics from the Kubernetes API server and makes them available to Prometheus (or a scraper that is compatible with a Prometheus client endpoint).</span></span> <span data-ttu-id="dad4d-235">Heapster összefoglalja, hogy Kubernetes hoz létre, és továbbítja őket a fogadó metrikákat, mivel a kube-állapot-metrikák hoz létre a saját metrikákat, és elérhetővé válnak végpont lekaparást keresztül.</span><span class="sxs-lookup"><span data-stu-id="dad4d-235">Whereas Heapster aggregates metrics that Kubernetes generates and forwards them to a sink, kube-state-metrics generates its own metrics and makes them available through an endpoint for scraping.</span></span> <span data-ttu-id="dad4d-236">A rendszer metrika, használjon [csomópont exportáló](https://github.com/prometheus/node_exporter), vagyis a rendszer metrikáihoz Prometheus exportáló.</span><span class="sxs-lookup"><span data-stu-id="dad4d-236">For system metrics, use [Node exporter](https://github.com/prometheus/node_exporter), which is a Prometheus exporter for system metrics.</span></span> <span data-ttu-id="dad4d-237">Lebegőpontos pont adatait, de nem karakterlánc típusú adatok Prometheus támogatja, ezért indokolt rendszer metrikákat, de nem naplók.</span><span class="sxs-lookup"><span data-stu-id="dad4d-237">Prometheus supports floating point data, but not string data, so it is appropriate for system metrics but not logs.</span></span>

- <span data-ttu-id="dad4d-238">Például egy irányítópult eszközzel **Kibana** vagy **Grafana** megjelenítheti és áttekintheti az adatokat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-238">Use a dashboard tool such as **Kibana** or **Grafana** to visualize and monitor the data.</span></span> <span data-ttu-id="dad4d-239">Az irányítópult szolgáltatás is futtatható a fürt egy tároló belül.</span><span class="sxs-lookup"><span data-stu-id="dad4d-239">The dashboard service can also run inside a container in the cluster.</span></span>

<span data-ttu-id="dad4d-240">Az alkalmazás naplóiban, érdemes lehet **Fluentd** és **Elasticsearch**.</span><span class="sxs-lookup"><span data-stu-id="dad4d-240">For application logs, consider using **Fluentd** and **Elasticsearch**.</span></span> <span data-ttu-id="dad4d-241">Fluentd egy nyílt forráskódú adatgyűjtő, Elasticsearch pedig egy dokumentum-adatbázis egy keresőmotor segítségével optimalizált.</span><span class="sxs-lookup"><span data-stu-id="dad4d-241">Fluentd is an open source data collector, and Elasticsearch is a document database that is optimized to act as a search engine.</span></span> <span data-ttu-id="dad4d-242">Ezzel a megközelítéssel minden szolgáltatás által a naplófájlok `stdout` és `stderr`, és Kubernetes ezekbe az adatfolyamokba ír a helyi fájlrendszerben.</span><span class="sxs-lookup"><span data-stu-id="dad4d-242">Using this approach, each service sends logs to `stdout` and `stderr`, and Kubernetes writes these streams to the local file system.</span></span> <span data-ttu-id="dad4d-243">Fluentd gyűjti a naplókat, opcionálisan további metaadatokkal Kubernetes a következőképpen színesíti őket, és elküldi a naplók Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="dad4d-243">Fluentd collects the logs, optionally enriches them with additional metadata from Kubernetes, and sends the logs to Elasticsearch.</span></span> <span data-ttu-id="dad4d-244">Kibana, Grafana vagy hasonló eszköz használatával hozzon létre egy irányítópultot Elasticsearch.</span><span class="sxs-lookup"><span data-stu-id="dad4d-244">Use Kibana, Grafana, or a similar tool to create a dashboard for Elasticsearch.</span></span> <span data-ttu-id="dad4d-245">A fürt, amely biztosítja, hogy egy Fluentd pod hozzá van rendelve minden csomóponton egy daemonset Fluentd futtatja.</span><span class="sxs-lookup"><span data-stu-id="dad4d-245">Fluentd runs as a daemonset in the cluster, which ensures that one Fluentd pod is assigned to each node.</span></span> <span data-ttu-id="dad4d-246">Beállíthatja, hogy Fluentd kubelet naplókat, valamint a tároló naplók gyűjtéséhez.</span><span class="sxs-lookup"><span data-stu-id="dad4d-246">You can configure Fluentd to collect kubelet logs as well as container logs.</span></span> <span data-ttu-id="dad4d-247">A nagy mennyiségük naplók írása a helyi fájlrendszerben válhat a teljesítménybeli szűk keresztmetszetek, különösen akkor, ha több szolgáltatás ugyanazon a csomóponton futnak.</span><span class="sxs-lookup"><span data-stu-id="dad4d-247">At high volumes, writing logs to the local file system could become a performance bottleneck, especially when multiple services are running on the same node.</span></span> <span data-ttu-id="dad4d-248">Figyelje a késleltetés és a fájl rendszer lemezhasználat éles környezetben.</span><span class="sxs-lookup"><span data-stu-id="dad4d-248">Monitor disk latency and file system utilization in production.</span></span>

<span data-ttu-id="dad4d-249">Egy Fluentd Elasticsearch a naplók előnye, hogy a szolgáltatások nem szükséges további könyvtár függőségeit.</span><span class="sxs-lookup"><span data-stu-id="dad4d-249">One advantage of using Fluentd with Elasticsearch for logs is that services do not require any additional library dependencies.</span></span> <span data-ttu-id="dad4d-250">Minden szolgáltatás csak ír `stdout` és `stderr`, és a naplók exportálását történő Elasticsearch Fluentd kezeli.</span><span class="sxs-lookup"><span data-stu-id="dad4d-250">Each service just writes to `stdout` and `stderr`, and Fluentd handles exporting the logs into Elasticsearch.</span></span> <span data-ttu-id="dad4d-251">Megtudhatja, hogyan konfigurálhatja a naplózás infrastruktúrát is, a csoportok szolgáltatások írása nem szükséges.</span><span class="sxs-lookup"><span data-stu-id="dad4d-251">Also, the teams writing services don't need to understand how to configure the logging infrastructure.</span></span> <span data-ttu-id="dad4d-252">Egy feladat az éles környezet, a Elasticsearch fürt konfigurálásához, hogy a forgalom kezelésére méretezés.</span><span class="sxs-lookup"><span data-stu-id="dad4d-252">One challenge is to configure the Elasticsearch cluster for a production deployment, so that it scales to handle your traffic.</span></span> 

<span data-ttu-id="dad4d-253">Egy másik lehetőség egy elküldeni a naplókat az Operations Management Suite (OMS) szolgáltatáshoz.</span><span class="sxs-lookup"><span data-stu-id="dad4d-253">Another option is to send logs to Operations Management Suite (OMS) Log Analytics.</span></span> <span data-ttu-id="dad4d-254">A [Naplóelemzési] [ log-analytics] naplóadatokat gyűjti be egy központi tárházban, és a szolgáltatás képes egyesíteni más Azure-szolgáltatásokkal, az alkalmazás által használt adatokat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-254">The [Log Analytics][log-analytics] service collects log data into a central repository, and can also consolidate data from other Azure services that your application uses.</span></span> <span data-ttu-id="dad4d-255">További információkért lásd: [figyelése az Azure Tárolószolgáltatás-fürtöt a Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span><span class="sxs-lookup"><span data-stu-id="dad4d-255">For more information, see [Monitor an Azure Container Service cluster with Microsoft Operations Management Suite (OMS)][k8s-to-oms].</span></span>

## <a name="example-logging-with-correlation-ids"></a><span data-ttu-id="dad4d-256">Példa: Naplózás korrelációs azonosító</span><span class="sxs-lookup"><span data-stu-id="dad4d-256">Example: Logging with correlation IDs</span></span>

<span data-ttu-id="dad4d-257">Mutatja be az egyes ebben a fejezetben bemutatott pontok, ez hogyan a csomag szolgáltatás megvalósítja naplózási kiterjesztett példát.</span><span class="sxs-lookup"><span data-stu-id="dad4d-257">To illustrate some of the points discussed in this chapter, here is an extended example of how the Package service implements logging.</span></span> <span data-ttu-id="dad4d-258">A csomag szolgáltatáshoz készült géppel és használja a [Koa](http://koajs.com/) a Node.js webes keretrendszer.</span><span class="sxs-lookup"><span data-stu-id="dad4d-258">The Package service was written in TypeScript and uses the [Koa](http://koajs.com/) web framework for Node.js.</span></span> <span data-ttu-id="dad4d-259">Nincsenek több Node.js naplózási szalagtárak választhat.</span><span class="sxs-lookup"><span data-stu-id="dad4d-259">There are several Node.js logging libraries to choose from.</span></span> <span data-ttu-id="dad4d-260">A Microsoft kivételezett [Winston](https://github.com/winstonjs/winston), olyan népszerű naplózási könyvtár, amely megfelel a teljesítményének tesztelésekor azt.</span><span class="sxs-lookup"><span data-stu-id="dad4d-260">We picked [Winston](https://github.com/winstonjs/winston), a popular logging library that met our performance requirements when we tested it.</span></span>

<span data-ttu-id="dad4d-261">Foglalják magukban a megvalósítás részletei, hogy egy absztrakt meghatározott `ILogger` felület:</span><span class="sxs-lookup"><span data-stu-id="dad4d-261">To encapsulate the implementation details, we defined an abstract  `ILogger` interface:</span></span>

```ts
export interface ILogger {
    log(level: string, msg: string, meta?: any)
    debug(msg: string, meta?: any)
    info(msg: string, meta?: any)
    warn(msg: string, meta?: any)
    error(msg: string, meta?: any)
}
```

<span data-ttu-id="dad4d-262">Íme egy `ILogger` a Winston könyvtár nagyságúra végrehajtására.</span><span class="sxs-lookup"><span data-stu-id="dad4d-262">Here is an `ILogger` implementation that wraps the Winston library.</span></span> <span data-ttu-id="dad4d-263">A korrelációs azonosító konstruktor paramétert fogad, és az azonosító esetében minden napló üzenetbe.</span><span class="sxs-lookup"><span data-stu-id="dad4d-263">It takes the correlation ID as a constructor parameter, and injects the ID into every log message.</span></span> 

```ts
class WinstonLogger implements ILogger {
    constructor(private correlationId: string) {}
    log(level: string, msg: string, payload?: any) {
        var meta : any = {};
        if (payload) { meta.payload = payload };
        if (this.correlationId) { meta.correlationId = this.correlationId }
        winston.log(level, msg, meta)
    }
  
    info(msg: string, payload?: any) {
        this.log('info', msg, payload);
    }
    debug(msg: string, payload?: any) {
        this.log('debug', msg, payload);
    }
    warn(msg: string, payload?: any) {
        this.log('warn', msg, payload);
    }
    error(msg: string, payload?: any) {
        this.log('error', msg, payload);
    }
}
```

<span data-ttu-id="dad4d-264">A csomag szolgáltatásnak kell a korrelációs azonosító kinyerése a HTTP-kérelem.</span><span class="sxs-lookup"><span data-stu-id="dad4d-264">The Package service needs to extract the correlation ID from the HTTP request.</span></span> <span data-ttu-id="dad4d-265">Például ha linkerd használ, a korrelációs azonosító található a `l5d-ctx-trace` fejléc.</span><span class="sxs-lookup"><span data-stu-id="dad4d-265">For example, if you're using linkerd, the correlation ID is found in the `l5d-ctx-trace` header.</span></span> <span data-ttu-id="dad4d-266">A HTTP-kérelem Koa, egy környezeti objektumot, amely lekérdezi a csővezeték-kérelemfeldolgozáshoz keresztül történő továbbítása van tárolva.</span><span class="sxs-lookup"><span data-stu-id="dad4d-266">In Koa, the HTTP request is stored in a Context object that gets passed through the request processing pipeline.</span></span> <span data-ttu-id="dad4d-267">A korrelációs azonosító beszerzése a környezetben, és a tranzakciónaplókat tartalmazó inicializálása egy köztes függvény azt adhatja meg.</span><span class="sxs-lookup"><span data-stu-id="dad4d-267">We can define a middleware function to get the correlation ID from the Context and initialize the logger.</span></span> <span data-ttu-id="dad4d-268">(Egy köztes Koa a függvény egyszerűen hajtsa végre az egyes kérelmek függvényből.)</span><span class="sxs-lookup"><span data-stu-id="dad4d-268">(A middleware function in Koa is simply a function that gets executed for each request.)</span></span>

```ts
export type CorrelationIdFn = (ctx: Context) => string;

export function logger(level: string, getCorrelationId: CorrelationIdFn) {
    winston.configure({ 
        level: level,
        transports: [new (winston.transports.Console)()]
        });
    return async function(ctx: any, next: any) {
        ctx.state.logger = new WinstonLogger(getCorrelationId(ctx));
        await next();
    }
}
```

<span data-ttu-id="dad4d-269">A köztes meghívja a hívó által definiált függvény `getCorrelationId`, beolvasni a korrelációs.</span><span class="sxs-lookup"><span data-stu-id="dad4d-269">This middleware invokes a caller-defined function, `getCorrelationId`, to get the correlation ID.</span></span> <span data-ttu-id="dad4d-270">Ezután a naplózó példányát, és azt belül stashes `ctx.state`, amelyen egy kulcs-érték szótára Koa át az információkat a feldolgozási folyamaton keresztül.</span><span class="sxs-lookup"><span data-stu-id="dad4d-270">Then it creates an instance of the logger and stashes it inside `ctx.state`, which is a key-value dictionary used in Koa to pass information through the pipeline.</span></span> 

<span data-ttu-id="dad4d-271">A naplózó köztes kerül a folyamat indításakor:</span><span class="sxs-lookup"><span data-stu-id="dad4d-271">The logger middleware is added to the pipeline on startup:</span></span>

```ts
app.use(logger(Settings.logLevel(), function (ctx) {
    return ctx.headers[Settings.correlationHeader()];  
}));
```

<span data-ttu-id="dad4d-272">Miután minden be van állítva, is könnyen naplózási utasítás hozzá a kódot.</span><span class="sxs-lookup"><span data-stu-id="dad4d-272">Once everything is configured, it's easy to add logging statements to the code.</span></span> <span data-ttu-id="dad4d-273">Például itt a lehetőség, amely megkeresi a csomagot.</span><span class="sxs-lookup"><span data-stu-id="dad4d-273">For example, here is the method that looks up a package.</span></span> <span data-ttu-id="dad4d-274">Két hív a `ILogger.info` metódust.</span><span class="sxs-lookup"><span data-stu-id="dad4d-274">It makes two calls to the `ILogger.info` method.</span></span>

```ts
async getById(ctx: any, next: any) {
  var logger : ILogger = ctx.state.logger;
  var packageId = ctx.params.packageId;
  logger.info('Entering getById, packageId = %s', packageId);

  await next();

  let pkg = await this.repository.findPackage(ctx.params.packageId)

  if (pkg == null) {
    logger.info(`getById: %s not found`, packageId);
    ctx.response.status= 404;
    return;
  }

  ctx.response.status = 200;
  ctx.response.body = this.mapPackageDbToApi(pkg);
}
```

<span data-ttu-id="dad4d-275">Nem szükséges tartalmazza a korrelációs Azonosítót a naplózás utasításokat, mert a köztes függvény által automatikusan ezt.</span><span class="sxs-lookup"><span data-stu-id="dad4d-275">We don't need to include the correlation ID in the logging statements, because that's done automatically by the middleware function.</span></span> <span data-ttu-id="dad4d-276">Ez megkönnyíti a naplózás kód tisztító, és csökkenti annak esélyét, hogy a fejlesztő felejtse el tartalmazza a korrelációs azonosítót.</span><span class="sxs-lookup"><span data-stu-id="dad4d-276">This makes the logging code cleaner, and reduces the chance that a developer will forget to include the correlation ID.</span></span> <span data-ttu-id="dad4d-277">Ezért a naplózás utasítások használják az absztrakt `ILogger` felületet, lenne könnyen cserélje le a tranzakciónaplókat tartalmazó megvalósítása újabb.</span><span class="sxs-lookup"><span data-stu-id="dad4d-277">And because all of the logging statements use the abstract `ILogger` interface, it would be easy to replace the logger implementation later.</span></span>

> [!div class="nextstepaction"]
> [<span data-ttu-id="dad4d-278">Folyamatos integrációt és kézbesítés</span><span class="sxs-lookup"><span data-stu-id="dad4d-278">Continuous integration and delivery</span></span>](./ci-cd.md)

<!-- links -->

[app-insights]: /azure/application-insights/app-insights-overview
[heapster]: https://github.com/kubernetes/heapster
[kube-state-metrics]: https://github.com/kubernetes/kube-state-metrics
[k8s-to-oms]: /azure/container-service/kubernetes/container-service-kubernetes-oms
[log-analytics]: /azure/log-analytics/