---
title: Hitelesítés a több-bérlős alkalmazásokhoz
description: Hogyan egy több-bérlős alkalmazást az Azure ad-felhasználókat hitelesítheti
author: MikeWasson
ms:date: 07/21/2017
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: tailspin
pnp.series.next: claims
ms.openlocfilehash: e85817626675cec4d126921c19a31a0983ecd62d
ms.sourcegitcommit: 8ab30776e0c4cdc16ca0dcc881960e3108ad3e94
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 12/08/2017
---
# <a name="authenticate-using-azure-ad-and-openid-connect"></a><span data-ttu-id="d075e-103">Hitelesítés az Azure AD használatával és az OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="d075e-103">Authenticate using Azure AD and OpenID Connect</span></span>

<span data-ttu-id="d075e-104">[![GitHub](../_images/github.png) Mintakód][sample application]</span><span class="sxs-lookup"><span data-stu-id="d075e-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

<span data-ttu-id="d075e-105">A felmérések alkalmazás az OpenID Connect (OIDC) protokoll használatával hitelesíti a felhasználókat az Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="d075e-105">The Surveys application uses the OpenID Connect (OIDC) protocol to authenticate users with Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="d075e-106">A felmérések alkalmazás, amelynek beépített köztes OIDC az ASP.NET Core használja.</span><span class="sxs-lookup"><span data-stu-id="d075e-106">The Surveys application uses ASP.NET Core, which has built-in middleware for OIDC.</span></span> <span data-ttu-id="d075e-107">Az alábbi ábrán látható, hogy mi történik, ha a felhasználó bejelentkezik, magas szinten.</span><span class="sxs-lookup"><span data-stu-id="d075e-107">The following diagram shows what happens when the user signs in, at a high level.</span></span>

![Hitelesítési folyamat](./images/auth-flow.png)

1. <span data-ttu-id="d075e-109">Kattintás a "bejelentkezés" gombra az alkalmazásban.</span><span class="sxs-lookup"><span data-stu-id="d075e-109">The user clicks the "sign in" button in the app.</span></span> <span data-ttu-id="d075e-110">Ez a művelet az MVC-vezérlő kezeli.</span><span class="sxs-lookup"><span data-stu-id="d075e-110">This action is handled by an MVC controller.</span></span>
2. <span data-ttu-id="d075e-111">Az MVC-vezérlő értéket ad vissza egy **ChallengeResult** művelet.</span><span class="sxs-lookup"><span data-stu-id="d075e-111">The MVC controller returns a **ChallengeResult** action.</span></span>
3. <span data-ttu-id="d075e-112">A köztes elfogja a **ChallengeResult** , és létrehoz egy 302-es választ, amely átirányítja a felhasználót az Azure AD bejelentkezési oldalára.</span><span class="sxs-lookup"><span data-stu-id="d075e-112">The middleware intercepts the **ChallengeResult** and creates a 302 response, which redirects the user to the Azure AD sign-in page.</span></span>
4. <span data-ttu-id="d075e-113">A felhasználók hitelesítése az Azure ad-val.</span><span class="sxs-lookup"><span data-stu-id="d075e-113">The user authenticates with Azure AD.</span></span>
5. <span data-ttu-id="d075e-114">Az Azure AD egy azonosító tokent elküldi az alkalmazásnak.</span><span class="sxs-lookup"><span data-stu-id="d075e-114">Azure AD sends an ID token to the application.</span></span>
6. <span data-ttu-id="d075e-115">A köztes érvényesíti a azonosító jogkivonatot.</span><span class="sxs-lookup"><span data-stu-id="d075e-115">The middleware validates the ID token.</span></span> <span data-ttu-id="d075e-116">Ezen a ponton a felhasználói most már hitelesítve az alkalmazáson belüli.</span><span class="sxs-lookup"><span data-stu-id="d075e-116">At this point, the user is now authenticated inside the application.</span></span>
7. <span data-ttu-id="d075e-117">A köztes átirányítja a felhasználói alkalmazás.</span><span class="sxs-lookup"><span data-stu-id="d075e-117">The middleware redirects the user back to application.</span></span>

## <a name="register-the-app-with-azure-ad"></a><span data-ttu-id="d075e-118">Az alkalmazás regisztrálása az Azure ad szolgáltatással</span><span class="sxs-lookup"><span data-stu-id="d075e-118">Register the app with Azure AD</span></span>
<span data-ttu-id="d075e-119">OpenID Connect engedélyezéséhez a Szolgáltatottszoftver-szolgáltató regisztrálja az alkalmazást a saját Azure AD-bérlő belül.</span><span class="sxs-lookup"><span data-stu-id="d075e-119">To enable OpenID Connect, the SaaS provider registers the application inside their own Azure AD tenant.</span></span>

<span data-ttu-id="d075e-120">Az alkalmazás regisztrálásához kövesse [alkalmazások integrálása az Azure Active Directoryval](/azure/active-directory/active-directory-integrating-applications/), szakaszában [egy alkalmazás hozzáadása](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span><span class="sxs-lookup"><span data-stu-id="d075e-120">To register the application, follow the steps in [Integrating Applications with Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), in the section [Adding an Application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span></span>

<span data-ttu-id="d075e-121">Lásd: [futtassa a felmérések alkalmazást](./run-the-app.md) a felmérések alkalmazására vonatkozó lépéseit.</span><span class="sxs-lookup"><span data-stu-id="d075e-121">See [Run the Surveys application](./run-the-app.md) for the specific steps for the Surveys application.</span></span> <span data-ttu-id="d075e-122">Vegye figyelembe a következőket:</span><span class="sxs-lookup"><span data-stu-id="d075e-122">Note the following:</span></span>

- <span data-ttu-id="d075e-123">Egy több-bérlős alkalmazást konfigurálnia kell a multi-központjaként beállítást explicit módon.</span><span class="sxs-lookup"><span data-stu-id="d075e-123">For a multitenant application, you must configure the multi-tenanted option explicitly.</span></span> <span data-ttu-id="d075e-124">Ez lehetővé teszi, hogy más szervezetek számára, az alkalmazás eléréséhez.</span><span class="sxs-lookup"><span data-stu-id="d075e-124">This enables other organizations to to access the application.</span></span>

- <span data-ttu-id="d075e-125">A válasz URL-címe: az URL-cím, ahol az Azure AD küldi a válaszokat OAuth 2.0-s.</span><span class="sxs-lookup"><span data-stu-id="d075e-125">The reply URL is the URL where Azure AD will send OAuth 2.0 responses.</span></span> <span data-ttu-id="d075e-126">Az ASP.NET Core használata esetén ez egyezniük kell az elérési utat, amelyet megadtak a hitelesítési köztes (lásd a következő szakaszban),</span><span class="sxs-lookup"><span data-stu-id="d075e-126">When using the ASP.NET Core, this needs to match the path that you configure in the authentication middleware (see next section),</span></span> 

## <a name="configure-the-auth-middleware"></a><span data-ttu-id="d075e-127">A hitelesítési köztes konfigurálása</span><span class="sxs-lookup"><span data-stu-id="d075e-127">Configure the auth middleware</span></span>
<span data-ttu-id="d075e-128">Ez a szakasz ismerteti a hitelesítési köztes konfigurálása az ASP.NET Core az OpenID Connect több-bérlős hitelesítéshez.</span><span class="sxs-lookup"><span data-stu-id="d075e-128">This section describes how to configure the authentication middleware in ASP.NET Core for multitenant authentication with OpenID Connect.</span></span>

<span data-ttu-id="d075e-129">Az a [indítási osztály](/aspnet/core/fundamentals/startup), az OpenID Connect köztes hozzáadása:</span><span class="sxs-lookup"><span data-stu-id="d075e-129">In your [startup class](/aspnet/core/fundamentals/startup), add the OpenID Connect middleware:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(new OpenIdConnectOptions {
    ClientId = configOptions.AzureAd.ClientId,
    ClientSecret = configOptions.AzureAd.ClientSecret, // for code flow
    Authority = Constants.AuthEndpointPrefix,
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    PostLogoutRedirectUri = configOptions.AzureAd.PostLogoutRedirectUri,
    SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,
    TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = false },
    Events = new SurveyAuthenticationEvents(configOptions.AzureAd, loggerFactory),
});
```

<span data-ttu-id="d075e-130">Figyelje meg, hogy a beállításokat a konfigurációs beállításai futásidejű művelet.</span><span class="sxs-lookup"><span data-stu-id="d075e-130">Notice that some of the settings are taken from runtime configuration options.</span></span> <span data-ttu-id="d075e-131">Ez a köztes beállítások jelenti:</span><span class="sxs-lookup"><span data-stu-id="d075e-131">Here's what the middleware options mean:</span></span>

* <span data-ttu-id="d075e-132">**ClientId**.</span><span class="sxs-lookup"><span data-stu-id="d075e-132">**ClientId**.</span></span> <span data-ttu-id="d075e-133">Az alkalmazás ügyfél-azonosító az Azure ad-ben az alkalmazás regisztrálásakor kapott.</span><span class="sxs-lookup"><span data-stu-id="d075e-133">The application's client ID, which you got when you registered the application in Azure AD.</span></span>
* <span data-ttu-id="d075e-134">**Szolgáltató**.</span><span class="sxs-lookup"><span data-stu-id="d075e-134">**Authority**.</span></span> <span data-ttu-id="d075e-135">Egy több-bérlős alkalmazáshoz állítsa ezt a beállítást `https://login.microsoftonline.com/common/`.</span><span class="sxs-lookup"><span data-stu-id="d075e-135">For a multitenant application, set this to `https://login.microsoftonline.com/common/`.</span></span> <span data-ttu-id="d075e-136">Ez az az Azure AD közös végpont, amely lehetővé teszi a felhasználók bármely Azure AD-bérlő jelentkezzen be az URL-CÍMÉT.</span><span class="sxs-lookup"><span data-stu-id="d075e-136">This is the URL for the Azure AD common endpoint, which enables users from any Azure AD tenant to sign in.</span></span> <span data-ttu-id="d075e-137">A közös végpont kapcsolatos további információkért lásd: [ebben a blogbejegyzésben](http://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span><span class="sxs-lookup"><span data-stu-id="d075e-137">For more information about the common endpoint, see [this blog post](http://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span></span>
* <span data-ttu-id="d075e-138">A **TokenValidationParameters**, beállíthatja **ValidateIssuer** false értékre.</span><span class="sxs-lookup"><span data-stu-id="d075e-138">In **TokenValidationParameters**, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="d075e-139">Ez azt jelenti, hogy az alkalmazás kell konfigurálnia a kibocsátó érték a Azonosítót jogkivonatban ellenőrzése.</span><span class="sxs-lookup"><span data-stu-id="d075e-139">That means the app will be responsible for validating the issuer value in the ID token.</span></span> <span data-ttu-id="d075e-140">(A köztes továbbra is érvényesíti a jogkivonatot magát.) A kibocsátó ellenőrzésével kapcsolatos további információkért lásd: [kibocsátó érvényesítése](claims.md#issuer-validation).</span><span class="sxs-lookup"><span data-stu-id="d075e-140">(The middleware still validates the token itself.) For more information about validating the issuer, see [Issuer validation](claims.md#issuer-validation).</span></span>
* <span data-ttu-id="d075e-141">**PostLogoutRedirectUri**.</span><span class="sxs-lookup"><span data-stu-id="d075e-141">**PostLogoutRedirectUri**.</span></span> <span data-ttu-id="d075e-142">Adja meg a felhasználók a kijelentkezés után átirányítási URL-CÍMÉT. Ez legyen egy oldal, amely lehetővé teszi a névtelen kérelmek &mdash; általában a kezdőlap.</span><span class="sxs-lookup"><span data-stu-id="d075e-142">Specify a URL to redirect users after the sign out. This should be a page that allows anonymous requests &mdash; typically the home page.</span></span>
* <span data-ttu-id="d075e-143">**SignInScheme**.</span><span class="sxs-lookup"><span data-stu-id="d075e-143">**SignInScheme**.</span></span> <span data-ttu-id="d075e-144">Állítsa ezt a beállítást `CookieAuthenticationDefaults.AuthenticationScheme`.</span><span class="sxs-lookup"><span data-stu-id="d075e-144">Set this to `CookieAuthenticationDefaults.AuthenticationScheme`.</span></span> <span data-ttu-id="d075e-145">Ez a beállítás azt jelenti, hogy a felhasználó hitelesítése után a felhasználói jogcímeket kell tárolni helyileg egy cookie-ban.</span><span class="sxs-lookup"><span data-stu-id="d075e-145">This setting means that after the user is authenticated, the user claims are stored locally in a cookie.</span></span> <span data-ttu-id="d075e-146">Ez a cookie, hogy a felhasználó bejelentkezett marad a böngésző-munkamenet során.</span><span class="sxs-lookup"><span data-stu-id="d075e-146">This cookie is how the user stays logged in during the browser session.</span></span>
* <span data-ttu-id="d075e-147">**Események.**</span><span class="sxs-lookup"><span data-stu-id="d075e-147">**Events.**</span></span> <span data-ttu-id="d075e-148">Esemény visszahívások; Lásd: [hitelesítési események](#authentication-events).</span><span class="sxs-lookup"><span data-stu-id="d075e-148">Event callbacks; see [Authentication events](#authentication-events).</span></span>

<span data-ttu-id="d075e-149">A hitelesítési cookie-k köztes is hozzáadhat a feldolgozási sor.</span><span class="sxs-lookup"><span data-stu-id="d075e-149">Also add the Cookie Authentication middleware to the pipeline.</span></span> <span data-ttu-id="d075e-150">A köztes írása egy cookie-t a felhasználói jogcímeket, és majd olvasása során a következő lapon terhelések a cookie-k felelős.</span><span class="sxs-lookup"><span data-stu-id="d075e-150">This middleware is responsible for writing the user claims to a cookie, and then reading the cookie during subsequent page loads.</span></span>

```csharp
app.UseCookieAuthentication(new CookieAuthenticationOptions {
    AutomaticAuthenticate = true,
    AutomaticChallenge = true,
    AccessDeniedPath = "/Home/Forbidden",
    CookieSecure = CookieSecurePolicy.Always,

    // The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default
    ExpireTimeSpan = TimeSpan.FromHours(1),
    SlidingExpiration = true
});
```

## <a name="initiate-the-authentication-flow"></a><span data-ttu-id="d075e-151">A hitelesítési folyamat kezdeményezéséhez</span><span class="sxs-lookup"><span data-stu-id="d075e-151">Initiate the authentication flow</span></span>
<span data-ttu-id="d075e-152">A hitelesítési folyamat elindításához az ASP.NET mvc-ben, térjen vissza a **ChallengeResult** a a contoller:</span><span class="sxs-lookup"><span data-stu-id="d075e-152">To start the authentication flow in ASP.NET MVC, return a **ChallengeResult** from the contoller:</span></span>

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

<span data-ttu-id="d075e-153">Ennek hatására a közbenső szoftvert 302-es (található) választ, amely átirányítja a hitelesítési végpontra.</span><span class="sxs-lookup"><span data-stu-id="d075e-153">This causes the middleware to return a 302 (Found) response that redirects to the authentication endpoint.</span></span>

## <a name="user-login-sessions"></a><span data-ttu-id="d075e-154">Felhasználói munkamenetek</span><span class="sxs-lookup"><span data-stu-id="d075e-154">User login sessions</span></span>
<span data-ttu-id="d075e-155">Ahogy azt korábban említettük, ha a felhasználó először jelentkezik be, a hitelesítési cookie-k köztes ír egy cookie-t a felhasználói jogcímeket.</span><span class="sxs-lookup"><span data-stu-id="d075e-155">As mentioned, when the user first signs in, the Cookie Authentication middleware writes the user claims to a cookie.</span></span> <span data-ttu-id="d075e-156">Ezt követően HTTP-kérések hitelesítése a cookie-k olvasásakor.</span><span class="sxs-lookup"><span data-stu-id="d075e-156">After that, HTTP requests are authenticated by reading the cookie.</span></span>

<span data-ttu-id="d075e-157">Alapértelmezés szerint a cookie-k köztes ír egy [munkamenetcookie][session-cookie], mely lekérdezi törlése után a felhasználó bezárja a böngészőt.</span><span class="sxs-lookup"><span data-stu-id="d075e-157">By default, the cookie middleware writes a [session cookie][session-cookie], which gets deleted once the user closes the browser.</span></span> <span data-ttu-id="d075e-158">A felhasználó ezután felkeresi a webhelyet, amikor legközelebb rendelkeznek újból bejelentkezni.</span><span class="sxs-lookup"><span data-stu-id="d075e-158">The next time the user next visits the site, they will have to sign in again.</span></span> <span data-ttu-id="d075e-159">Azonban ha **IsPersistent** igaz értékű a **ChallengeResult**, a köztes ír egy állandó cookie-t, a böngésző bezárása után a felhasználó bejelentkezett marad.</span><span class="sxs-lookup"><span data-stu-id="d075e-159">However, if you set **IsPersistent** to true in the **ChallengeResult**, the middleware writes a persistent cookie, so the user stays logged in after closing the browser.</span></span> <span data-ttu-id="d075e-160">Beállíthatja, hogy a cookie lejárati; Lásd: [cookie-k beállítások szabályozása][cookie-options].</span><span class="sxs-lookup"><span data-stu-id="d075e-160">You can configure the cookie expiration; see [Controlling cookie options][cookie-options].</span></span> <span data-ttu-id="d075e-161">Állandó cookie-k a felhasználók kényelmesebb, de lehet, hogy egyes alkalmazások (szóbeli, egy banki alkalmazás) nem megfelelő Ha azt szeretné, hogy a felhasználót, hogy minden egyes bejelentkezés.</span><span class="sxs-lookup"><span data-stu-id="d075e-161">Persistent cookies are more convenient for the user, but may be inappropriate for some applications (say, a banking application) where you want the user to sign in every time.</span></span>

## <a name="about-the-openid-connect-middleware"></a><span data-ttu-id="d075e-162">Az OpenID Connect köztes kapcsolatos</span><span class="sxs-lookup"><span data-stu-id="d075e-162">About the OpenID Connect middleware</span></span>
<span data-ttu-id="d075e-163">Az OpenID Connect köztes az ASP.NET elrejti a legtöbb protokoll részleteit.</span><span class="sxs-lookup"><span data-stu-id="d075e-163">The OpenID Connect middleware in ASP.NET hides most of the protocol details.</span></span> <span data-ttu-id="d075e-164">Ez a szakasz néhány megjegyzés, amely lehet hasznos, ha a protokoll folyamat ismertetése megvalósításával kapcsolatban.</span><span class="sxs-lookup"><span data-stu-id="d075e-164">This section contains some notes about the implementation, that may be useful for understanding the protocol flow.</span></span>

<span data-ttu-id="d075e-165">Első lépésként vizsgáljuk meg a hitelesítési folyamat tekintetében az ASP.NET (az alkalmazás és az Azure AD közötti OIDC protokoll folyamat részleteit figyelmen kívül hagyva).</span><span class="sxs-lookup"><span data-stu-id="d075e-165">First, let's examine the authentication flow in terms of ASP.NET (ignoring the details of the OIDC protocol flow between the app and Azure AD).</span></span> <span data-ttu-id="d075e-166">Az alábbi ábrán látható, a folyamat.</span><span class="sxs-lookup"><span data-stu-id="d075e-166">The following diagram shows the process.</span></span>

![Bejelentkezés folyamata](./images/sign-in-flow.png)

<span data-ttu-id="d075e-168">Ezen a diagramon nincsenek két MVC-vezérlők.</span><span class="sxs-lookup"><span data-stu-id="d075e-168">In this diagram, there are two MVC controllers.</span></span> <span data-ttu-id="d075e-169">A fiók vezérlő bejelentkezési kéréseket kezeli, és az otthoni tartományvezérlő fel a kezdőlap szolgál.</span><span class="sxs-lookup"><span data-stu-id="d075e-169">The Account controller handles sign-in requests, and the Home controller serves up the home page.</span></span>

<span data-ttu-id="d075e-170">A hitelesítési folyamat a következő:</span><span class="sxs-lookup"><span data-stu-id="d075e-170">Here is the authentication process:</span></span>

1. <span data-ttu-id="d075e-171">A felhasználó a "Bejelentkezés" gombra kattint, és a böngésző GET kérés küldése.</span><span class="sxs-lookup"><span data-stu-id="d075e-171">The user clicks the "Sign in" button, and the browser sends a GET request.</span></span> <span data-ttu-id="d075e-172">Például: `GET /Account/SignIn/`.</span><span class="sxs-lookup"><span data-stu-id="d075e-172">For example: `GET /Account/SignIn/`.</span></span>
2. <span data-ttu-id="d075e-173">A fiók vezérlő értéket ad vissza egy `ChallengeResult`.</span><span class="sxs-lookup"><span data-stu-id="d075e-173">The account controller returns a `ChallengeResult`.</span></span>
3. <span data-ttu-id="d075e-174">A OIDC köztes egy HTTP 302 választ, az Azure AD-átirányítás ad vissza.</span><span class="sxs-lookup"><span data-stu-id="d075e-174">The OIDC middleware returns an HTTP 302 response, redirecting to Azure AD.</span></span>
4. <span data-ttu-id="d075e-175">A böngészőben a hitelesítési kérést küld az Azure AD</span><span class="sxs-lookup"><span data-stu-id="d075e-175">The browser sends the authentication request to Azure AD</span></span>
5. <span data-ttu-id="d075e-176">A felhasználó bejelentkezik az Azure AD és az Azure AD választ küld vissza hitelesítés.</span><span class="sxs-lookup"><span data-stu-id="d075e-176">The user signs in to Azure AD, and Azure AD sends back an authentication response.</span></span>
6. <span data-ttu-id="d075e-177">A OIDC köztes rendszerbiztonsági tag jogcímeket hoz létre, és a hitelesítési cookie-k köztes számára továbbítja azokat.</span><span class="sxs-lookup"><span data-stu-id="d075e-177">The OIDC middleware creates a claims principal and passes it to the Cookie Authentication middleware.</span></span>
7. <span data-ttu-id="d075e-178">A cookie-k köztes rendezi sorba a jogcímek rendszerbiztonsági tag, és beállítja egy cookie-t.</span><span class="sxs-lookup"><span data-stu-id="d075e-178">The cookie middleware serializes the claims principal and sets a cookie.</span></span>
8. <span data-ttu-id="d075e-179">A OIDC köztes az alkalmazás visszahívási URL-címre irányítja át.</span><span class="sxs-lookup"><span data-stu-id="d075e-179">The OIDC middleware redirects to the application's callback URL.</span></span>
9. <span data-ttu-id="d075e-180">A böngésző követi az átirányítást, a cookie-k a kérelem küldése.</span><span class="sxs-lookup"><span data-stu-id="d075e-180">The browser follows the redirect, sending the cookie in the request.</span></span>
10. <span data-ttu-id="d075e-181">A cookie-k köztes deserializes egy egyszerű jogcímek a cookie-k, és beállítja a `HttpContext.User` egyenlő a jogcímek rendszerbiztonsági tag.</span><span class="sxs-lookup"><span data-stu-id="d075e-181">The cookie middleware deserializes the cookie to a claims principal and sets `HttpContext.User` equal to the claims principal.</span></span> <span data-ttu-id="d075e-182">A kérelem az MVC-vezérlőhöz történik.</span><span class="sxs-lookup"><span data-stu-id="d075e-182">The request is routed to an MVC controller.</span></span>

### <a name="authentication-ticket"></a><span data-ttu-id="d075e-183">Hitelesítési jegy</span><span class="sxs-lookup"><span data-stu-id="d075e-183">Authentication ticket</span></span>
<span data-ttu-id="d075e-184">Ha a hitelesítés sikeres, a OIDC köztes hitelesítési jegyre, amely tartalmaz, amely tárolja a felhasználói jogcímek jogcímek rendszerbiztonsági tag hoz létre.</span><span class="sxs-lookup"><span data-stu-id="d075e-184">If authentication succeeds, the OIDC middleware creates an authentication ticket, which contains a claims principal that holds the user's claims.</span></span> <span data-ttu-id="d075e-185">A jegy belül végezheti el a **AuthenticationValidated** vagy **TicketReceived** esemény.</span><span class="sxs-lookup"><span data-stu-id="d075e-185">You can access the ticket inside the **AuthenticationValidated** or **TicketReceived** event.</span></span>

> [!NOTE]
> <span data-ttu-id="d075e-186">Az egész hitelesítési folyamat befejezéséig `HttpContext.User` továbbra is rendelkezik egy névtelen egyszerű **nem** a hitelesített felhasználó.</span><span class="sxs-lookup"><span data-stu-id="d075e-186">Until the entire authentication flow is completed, `HttpContext.User` still holds an anonymous principal, **not** the authenticated user.</span></span> <span data-ttu-id="d075e-187">A névtelen rendszerbiztonsági tag egy üres jogcímek gyűjteményt tartalmaz.</span><span class="sxs-lookup"><span data-stu-id="d075e-187">The anonymous principal has an empty claims collection.</span></span> <span data-ttu-id="d075e-188">Hitelesítés befejeződik, és az alkalmazás átirányítja a cookie-k köztes deserializes után a hitelesítési cookie-t és a készletek `HttpContext.User` a jogcímek rendszerbiztonsági tag, amely a hitelesített felhasználó jelöli.</span><span class="sxs-lookup"><span data-stu-id="d075e-188">After authentication completes and the app redirects, the cookie middleware deserializes the authentication cookie and sets `HttpContext.User` to a claims principal that represents the authenticated user.</span></span>
> 
> 

### <a name="authentication-events"></a><span data-ttu-id="d075e-189">Hitelesítési események</span><span class="sxs-lookup"><span data-stu-id="d075e-189">Authentication events</span></span>
<span data-ttu-id="d075e-190">A hitelesítési folyamat során az OpenID Connect köztes események sorozatát riasztást:</span><span class="sxs-lookup"><span data-stu-id="d075e-190">During the authentication process, the OpenID Connect middleware raises a series of events:</span></span>

* <span data-ttu-id="d075e-191">**Redirecttoidentityprovider metódus**.</span><span class="sxs-lookup"><span data-stu-id="d075e-191">**RedirectToIdentityProvider**.</span></span> <span data-ttu-id="d075e-192">A köztes átirányítja a felhasználókat a hitelesítési végpontra hívni a jogosultsággal.</span><span class="sxs-lookup"><span data-stu-id="d075e-192">Called right before the middleware redirects to the authentication endpoint.</span></span> <span data-ttu-id="d075e-193">Ez az esemény segítségével módosíthatja az átirányítási URL-címet; például adja meg a kérelem paramétereit.</span><span class="sxs-lookup"><span data-stu-id="d075e-193">You can use this event to modify the redirect URL; for example, to add request parameters.</span></span> <span data-ttu-id="d075e-194">Lásd: [hozzáadása a felügyeleti beleegyezést kérő üzenete](signup.md#adding-the-admin-consent-prompt) példát.</span><span class="sxs-lookup"><span data-stu-id="d075e-194">See [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) for an example.</span></span>
* <span data-ttu-id="d075e-195">**AuthorizationCodeReceived**.</span><span class="sxs-lookup"><span data-stu-id="d075e-195">**AuthorizationCodeReceived**.</span></span> <span data-ttu-id="d075e-196">Az engedélyezési kód hívása.</span><span class="sxs-lookup"><span data-stu-id="d075e-196">Called with the authorization code.</span></span>
* <span data-ttu-id="d075e-197">**TokenResponseReceived**.</span><span class="sxs-lookup"><span data-stu-id="d075e-197">**TokenResponseReceived**.</span></span> <span data-ttu-id="d075e-198">Neve a köztes lekérése egy hozzáférési jogkivonat a kiállító terjesztési hely, de előtt érvényességét.</span><span class="sxs-lookup"><span data-stu-id="d075e-198">Called after the middleware gets an access token from the IDP, but before it is validated.</span></span> <span data-ttu-id="d075e-199">Csak hitelesítésikód-folyamata vonatkozik.</span><span class="sxs-lookup"><span data-stu-id="d075e-199">Applies only to authorization code flow.</span></span>
* <span data-ttu-id="d075e-200">**TokenValidated**.</span><span class="sxs-lookup"><span data-stu-id="d075e-200">**TokenValidated**.</span></span> <span data-ttu-id="d075e-201">Hívása után a köztes érvényesíti a azonosító jogkivonatot.</span><span class="sxs-lookup"><span data-stu-id="d075e-201">Called after the middleware validates the ID token.</span></span> <span data-ttu-id="d075e-202">Ezen a ponton az alkalmazás rendelkezik érvényesített, a felhasználóval kapcsolatos jogcímek egy készletét.</span><span class="sxs-lookup"><span data-stu-id="d075e-202">At this point, the application has a set of validated claims about the user.</span></span> <span data-ttu-id="d075e-203">Ezt az eseményt további érvényesítést hajt végre a rendszer a jogcímeket, illetve jogcímek átalakítására használható.</span><span class="sxs-lookup"><span data-stu-id="d075e-203">You can use this event to perform additional validation on the claims, or to transform claims.</span></span> <span data-ttu-id="d075e-204">Lásd: [jogcímek használata](claims.md).</span><span class="sxs-lookup"><span data-stu-id="d075e-204">See [Working with claims](claims.md).</span></span>
* <span data-ttu-id="d075e-205">**UserInformationReceived**.</span><span class="sxs-lookup"><span data-stu-id="d075e-205">**UserInformationReceived**.</span></span> <span data-ttu-id="d075e-206">Ha a köztes lekérése a felhasználói adatok végpont a felhasználói profil neve.</span><span class="sxs-lookup"><span data-stu-id="d075e-206">Called if the middleware gets the user profile from the user info endpoint.</span></span> <span data-ttu-id="d075e-207">Csak hitelesítésikód-folyamata, és csak akkor vonatkozik `GetClaimsFromUserInfoEndpoint = true` a köztes beállításai.</span><span class="sxs-lookup"><span data-stu-id="d075e-207">Applies only to authorization code flow, and only when `GetClaimsFromUserInfoEndpoint = true` in the middleware options.</span></span>
* <span data-ttu-id="d075e-208">**TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="d075e-208">**TicketReceived**.</span></span> <span data-ttu-id="d075e-209">Hívható meg, ha a hitelesítés végbemegy.</span><span class="sxs-lookup"><span data-stu-id="d075e-209">Called when authentication is completed.</span></span> <span data-ttu-id="d075e-210">Ez az az utolsó esemény, feltéve, hogy a hitelesítés sikeres lesz.</span><span class="sxs-lookup"><span data-stu-id="d075e-210">This is the last event, assuming that authentication succeeds.</span></span> <span data-ttu-id="d075e-211">Után ez az esemény történik, a felhasználó jelentkezett be az alkalmazásba.</span><span class="sxs-lookup"><span data-stu-id="d075e-211">After this event is handled, the user is signed into the app.</span></span>
* <span data-ttu-id="d075e-212">**AuthenticationFailed**.</span><span class="sxs-lookup"><span data-stu-id="d075e-212">**AuthenticationFailed**.</span></span> <span data-ttu-id="d075e-213">Meghívni, ha a hitelesítés sikertelen.</span><span class="sxs-lookup"><span data-stu-id="d075e-213">Called if authentication fails.</span></span> <span data-ttu-id="d075e-214">Ez az esemény használatával kezeli a hitelesítési hibák &mdash; például úgy, hogy egy hibalap irányít át.</span><span class="sxs-lookup"><span data-stu-id="d075e-214">Use this event to handle authentication failures &mdash; for example, by redirecting to an error page.</span></span>

<span data-ttu-id="d075e-215">Adja meg a visszahívások ezeket az eseményeket, állítsa be a **események** a köztes beállítást.</span><span class="sxs-lookup"><span data-stu-id="d075e-215">To provide callbacks for these events, set the **Events** option on the middleware.</span></span> <span data-ttu-id="d075e-216">Az eseménykezelők deklarálnia két különböző módja van: beágyazott lambda kifejezések, illetve az abból származó osztály **OpenIdConnectEvents**.</span><span class="sxs-lookup"><span data-stu-id="d075e-216">There are two different ways to declare the event handlers: Inline with lambdas, or in a class that derives from **OpenIdConnectEvents**.</span></span> <span data-ttu-id="d075e-217">A második megközelítést akkor ajánlott, ha az esemény visszahívások rendelkezik bármely jelentős logika, így azok nem megzavarhatják a indítási osztályt.</span><span class="sxs-lookup"><span data-stu-id="d075e-217">The second approach is recommended if your event callbacks have any substantial logic, so they don't clutter your startup class.</span></span> <span data-ttu-id="d075e-218">A hivatkozás ezt a módszert használ.</span><span class="sxs-lookup"><span data-stu-id="d075e-218">Our reference implementation uses this approach.</span></span>

### <a name="openid-connect-endpoints"></a><span data-ttu-id="d075e-219">OpenID connect végpontok</span><span class="sxs-lookup"><span data-stu-id="d075e-219">OpenID connect endpoints</span></span>
<span data-ttu-id="d075e-220">Az Azure AD által támogatott [OpenID Connect felderítési](https://openid.net/specs/openid-connect-discovery-1_0.html), amelynek az identitásszolgáltató (IDP) egy a JSON-metaadatok dokumentumot ad vissza egy [jól ismert végpont](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span><span class="sxs-lookup"><span data-stu-id="d075e-220">Azure AD supports [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), wherein the identity provider (IDP) returns a JSON metadata document from a [well-known endpoint](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span></span> <span data-ttu-id="d075e-221">A metaadat-dokumentum tartalmaz információkat, mint:</span><span class="sxs-lookup"><span data-stu-id="d075e-221">The metadata document contains information such as:</span></span>

* <span data-ttu-id="d075e-222">Az engedélyezési végpont URL-CÍMÉT.</span><span class="sxs-lookup"><span data-stu-id="d075e-222">The URL of the authorization endpoint.</span></span> <span data-ttu-id="d075e-223">Ez azért, ahol az alkalmazás átirányítja a felhasználókat a felhasználó hitelesítésére.</span><span class="sxs-lookup"><span data-stu-id="d075e-223">This is where the app redirects to authenticate the user.</span></span>
* <span data-ttu-id="d075e-224">A "munkamenet befejezése" végpont, ahol az alkalmazás jelentkezzen ki a felhasználó ugrik URL-CÍMÉT.</span><span class="sxs-lookup"><span data-stu-id="d075e-224">The URL of the "end session" endpoint, where the app goes to log out the user.</span></span>
* <span data-ttu-id="d075e-225">Az aláíró kulcsok, amelyet az ügyfél használ, amely azt lekérése az IDP OIDC jogkivonatok érvényesítésére beolvasása az URL-címe.</span><span class="sxs-lookup"><span data-stu-id="d075e-225">The URL to get the signing keys, which the client uses to validate the OIDC tokens that it gets from the IDP.</span></span>

<span data-ttu-id="d075e-226">Alapértelmezés szerint a OIDC köztes meg tudja a metaadatok beolvasása.</span><span class="sxs-lookup"><span data-stu-id="d075e-226">By default, the OIDC middleware knows how to fetch this metadata.</span></span> <span data-ttu-id="d075e-227">Állítsa be a **hatóság** a köztes, és a köztes hoz létre a metaadatok URL-CÍMÉT.</span><span class="sxs-lookup"><span data-stu-id="d075e-227">Set the **Authority** option in the middleware, and the middleware constructs the URL for the metadata.</span></span> <span data-ttu-id="d075e-228">(A metaadatainak URL-CÍMÉT úgy, hogy lehet felülbírálni a **MetadataAddress** lehetőséget.)</span><span class="sxs-lookup"><span data-stu-id="d075e-228">(You can override the metadata URL by setting the **MetadataAddress** option.)</span></span>

### <a name="openid-connect-flows"></a><span data-ttu-id="d075e-229">OpenID connect adatfolyamok</span><span class="sxs-lookup"><span data-stu-id="d075e-229">OpenID connect flows</span></span>
<span data-ttu-id="d075e-230">Alapértelmezés szerint a OIDC köztes hibrid folyamat használja az űrlap post válasz mód.</span><span class="sxs-lookup"><span data-stu-id="d075e-230">By default, the OIDC middleware uses hybrid flow with form post response mode.</span></span>

* <span data-ttu-id="d075e-231">*Hibrid folyamat* azt jelenti, hogy az ügyfél kérheti le egy azonosító jogkivonat és egy engedélyezési kód ugyanazon oda-vissza az engedélyezési kiszolgálóra.</span><span class="sxs-lookup"><span data-stu-id="d075e-231">*Hybrid flow* means the client can get an ID token and an authorization code in the same round-trip to the authorization server.</span></span>
* <span data-ttu-id="d075e-232">*Űrlap post válasz mód* azt jelenti, hogy a hitelesítési kiszolgáló egy HTTP POST kérelem használja a azonosító token és engedélyezési kódot küldeni az alkalmazás.</span><span class="sxs-lookup"><span data-stu-id="d075e-232">*Form post reponse mode* means the authorization server uses an HTTP POST request to send the ID token and authorization code to the app.</span></span> <span data-ttu-id="d075e-233">Az értékek a következők űrlap-urlencoded (tartalomtípus = "application/x-www-form-urlencoded").</span><span class="sxs-lookup"><span data-stu-id="d075e-233">The values are form-urlencoded (content type = "application/x-www-form-urlencoded").</span></span>

<span data-ttu-id="d075e-234">A OIDC köztes átirányítja az engedélyezési végpont, amikor az átirányítási URL-címet tartalmazza az összes OIDC által igényelt lekérdezési karakterlánc paramétert.</span><span class="sxs-lookup"><span data-stu-id="d075e-234">When the OIDC middleware redirects to the authorization endpoint, the redirect URL includes all of the query string parameters needed by OIDC.</span></span> <span data-ttu-id="d075e-235">A hibrid folyamata:</span><span class="sxs-lookup"><span data-stu-id="d075e-235">For hybrid flow:</span></span>

* <span data-ttu-id="d075e-236">client_id.</span><span class="sxs-lookup"><span data-stu-id="d075e-236">client_id.</span></span> <span data-ttu-id="d075e-237">Ez az érték meg a **ClientId** beállítás</span><span class="sxs-lookup"><span data-stu-id="d075e-237">This value is set in the **ClientId** option</span></span>
* <span data-ttu-id="d075e-238">hatókör = "openid profil", ami azt jelenti, OIDC kérelmet, és azt szeretnénk, hogy a felhasználói profil.</span><span class="sxs-lookup"><span data-stu-id="d075e-238">scope = "openid profile", which means it's an OIDC request and we want the user's profile.</span></span>
* <span data-ttu-id="d075e-239">response_type = "code id_token".</span><span class="sxs-lookup"><span data-stu-id="d075e-239">response_type  = "code id_token".</span></span> <span data-ttu-id="d075e-240">Azt határozza meg a hibrid folyamata.</span><span class="sxs-lookup"><span data-stu-id="d075e-240">This specifies hybrid flow.</span></span>
* <span data-ttu-id="d075e-241">response_mode = "form_post".</span><span class="sxs-lookup"><span data-stu-id="d075e-241">response_mode = "form_post".</span></span> <span data-ttu-id="d075e-242">Azt határozza meg az űrlap post válasz.</span><span class="sxs-lookup"><span data-stu-id="d075e-242">This specifies form post response.</span></span>

<span data-ttu-id="d075e-243">Adjon meg egy másik folyamat, állítsa be a **ResponseType** tulajdonság a beállítások.</span><span class="sxs-lookup"><span data-stu-id="d075e-243">To specify a different flow, set the **ResponseType** property on the options.</span></span> <span data-ttu-id="d075e-244">Példa:</span><span class="sxs-lookup"><span data-stu-id="d075e-244">For example:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

<span data-ttu-id="d075e-245">[**Tovább**][claims]</span><span class="sxs-lookup"><span data-stu-id="d075e-245">[**Next**][claims]</span></span>

[claims]: claims.md
[cookie-options]: /aspnet/core/security/authentication/cookie#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
