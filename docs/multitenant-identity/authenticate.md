---
title: Hitelesítés a több-bérlős alkalmazásokban
description: Hogyan egy több-bérlős alkalmazás hitelesítheti a felhasználókat az Azure Active Directoryból.
author: MikeWasson
ms.date: 07/21/2017
ms.topic: guide
ms.service: architecture-center
ms.subservice: reference-architecture
pnp.series.title: Manage Identity in Multitenant Applications
pnp.series.prev: tailspin
pnp.series.next: claims
ms.openlocfilehash: a35342c0e40290332a349577260de316b5e7d503
ms.sourcegitcommit: 579c39ff4b776704ead17a006bf24cd4cdc65edd
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 04/17/2019
ms.locfileid: "59640431"
---
# <a name="authenticate-using-azure-ad-and-openid-connect"></a><span data-ttu-id="1e48c-103">Hitelesítés az Azure AD-vel és az OpenID Connect</span><span class="sxs-lookup"><span data-stu-id="1e48c-103">Authenticate using Azure AD and OpenID Connect</span></span>

<span data-ttu-id="1e48c-104">[![GitHub](../_images/github.png) Mintakód][sample application]</span><span class="sxs-lookup"><span data-stu-id="1e48c-104">[![GitHub](../_images/github.png) Sample code][sample application]</span></span>

<span data-ttu-id="1e48c-105">A Surveys alkalmazás az OpenID Connect (OIDC) protokoll használatával hitelesíti a felhasználókat az Azure Active Directory (Azure AD).</span><span class="sxs-lookup"><span data-stu-id="1e48c-105">The Surveys application uses the OpenID Connect (OIDC) protocol to authenticate users with Azure Active Directory (Azure AD).</span></span> <span data-ttu-id="1e48c-106">A Surveys alkalmazás használja az ASP.NET Core, amely beépített közbenső OIDC rendelkezik.</span><span class="sxs-lookup"><span data-stu-id="1e48c-106">The Surveys application uses ASP.NET Core, which has built-in middleware for OIDC.</span></span> <span data-ttu-id="1e48c-107">Az alábbi ábrán látható, hogy mi történik, ha a felhasználó bejelentkezik, magas szinten.</span><span class="sxs-lookup"><span data-stu-id="1e48c-107">The following diagram shows what happens when the user signs in, at a high level.</span></span>

![A hitelesítési folyamatból](./images/auth-flow.png)

1. <span data-ttu-id="1e48c-109">A felhasználó az alkalmazásban a "bejelentkezés" gombra kattint.</span><span class="sxs-lookup"><span data-stu-id="1e48c-109">The user clicks the "sign in" button in the app.</span></span> <span data-ttu-id="1e48c-110">Ez a művelet egy MVC-vezérlő kezeli.</span><span class="sxs-lookup"><span data-stu-id="1e48c-110">This action is handled by an MVC controller.</span></span>
2. <span data-ttu-id="1e48c-111">Az MVC-vezérlő értéket ad vissza egy **ChallengeResult** művelet.</span><span class="sxs-lookup"><span data-stu-id="1e48c-111">The MVC controller returns a **ChallengeResult** action.</span></span>
3. <span data-ttu-id="1e48c-112">A közbenső szoftver elfogja a **ChallengeResult** , és létrehoz egy 302 választ, amely átirányítja a felhasználót az Azure AD bejelentkezési oldalra.</span><span class="sxs-lookup"><span data-stu-id="1e48c-112">The middleware intercepts the **ChallengeResult** and creates a 302 response, which redirects the user to the Azure AD sign-in page.</span></span>
4. <span data-ttu-id="1e48c-113">A felhasználó hitelesíti magát az Azure ad-ben.</span><span class="sxs-lookup"><span data-stu-id="1e48c-113">The user authenticates with Azure AD.</span></span>
5. <span data-ttu-id="1e48c-114">Az Azure AD elküldi az alkalmazás-azonosító jogkivonat.</span><span class="sxs-lookup"><span data-stu-id="1e48c-114">Azure AD sends an ID token to the application.</span></span>
6. <span data-ttu-id="1e48c-115">A közbenső szoftver az azonosító jogkivonat érvényesíti.</span><span class="sxs-lookup"><span data-stu-id="1e48c-115">The middleware validates the ID token.</span></span> <span data-ttu-id="1e48c-116">Ezen a ponton a felhasználó mostantól az alkalmazáson belüli hitelesítését.</span><span class="sxs-lookup"><span data-stu-id="1e48c-116">At this point, the user is now authenticated inside the application.</span></span>
7. <span data-ttu-id="1e48c-117">A közbenső szoftver alkalmazásnak átirányítja a felhasználót.</span><span class="sxs-lookup"><span data-stu-id="1e48c-117">The middleware redirects the user back to application.</span></span>

## <a name="register-the-app-with-azure-ad"></a><span data-ttu-id="1e48c-118">Az alkalmazás regisztrálása az Azure ad-vel</span><span class="sxs-lookup"><span data-stu-id="1e48c-118">Register the app with Azure AD</span></span>

<span data-ttu-id="1e48c-119">OpenID Connect engedélyezéséhez az SaaS-szolgáltató regisztrálja az alkalmazás a saját Azure AD-bérlő belül.</span><span class="sxs-lookup"><span data-stu-id="1e48c-119">To enable OpenID Connect, the SaaS provider registers the application inside their own Azure AD tenant.</span></span>

<span data-ttu-id="1e48c-120">Az alkalmazás regisztrálásához kövesse [alkalmazások az Azure Active Directoryval való integrálását](/azure/active-directory/active-directory-integrating-applications/), a szakaszban [egy alkalmazás hozzáadása](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span><span class="sxs-lookup"><span data-stu-id="1e48c-120">To register the application, follow the steps in [Integrating Applications with Azure Active Directory](/azure/active-directory/active-directory-integrating-applications/), in the section [Adding an Application](/azure/active-directory/active-directory-integrating-applications/#adding-an-application).</span></span>

<span data-ttu-id="1e48c-121">Lásd: [a Surveys alkalmazás futtatása](./run-the-app.md) lépései a Surveys alkalmazás számára.</span><span class="sxs-lookup"><span data-stu-id="1e48c-121">See [Run the Surveys application](./run-the-app.md) for the specific steps for the Surveys application.</span></span> <span data-ttu-id="1e48c-122">Vegye figyelembe a következőket:</span><span class="sxs-lookup"><span data-stu-id="1e48c-122">Note the following:</span></span>

- <span data-ttu-id="1e48c-123">Egy több-bérlős alkalmazásban konfigurálnia kell a több-bérlős beállítás explicit módon.</span><span class="sxs-lookup"><span data-stu-id="1e48c-123">For a multitenant application, you must configure the multi-tenanted option explicitly.</span></span> <span data-ttu-id="1e48c-124">Ez lehetővé teszi, hogy más szervezetek számára az alkalmazás eléréséhez.</span><span class="sxs-lookup"><span data-stu-id="1e48c-124">This enables other organizations to access the application.</span></span>

- <span data-ttu-id="1e48c-125">A válasz-URL az URL-címe, ahol az Azure AD elküldi az OAuth 2.0-válaszok.</span><span class="sxs-lookup"><span data-stu-id="1e48c-125">The reply URL is the URL where Azure AD will send OAuth 2.0 responses.</span></span> <span data-ttu-id="1e48c-126">Az ASP.NET Core használata esetén ez meg kell felelnie a közbenső hitelesítési szoftver konfigurált elérési útja (lásd a következő szakaszban).</span><span class="sxs-lookup"><span data-stu-id="1e48c-126">When using the ASP.NET Core, this needs to match the path that you configure in the authentication middleware (see next section).</span></span>

## <a name="configure-the-auth-middleware"></a><span data-ttu-id="1e48c-127">A hitelesítési közbenső szoftver konfigurálása</span><span class="sxs-lookup"><span data-stu-id="1e48c-127">Configure the auth middleware</span></span>

<span data-ttu-id="1e48c-128">Ez a szakasz ismerteti a közbenső hitelesítési szoftver konfigurálása az ASP.NET Core OpenID-kapcsolattal több-bérlős hitelesítéshez.</span><span class="sxs-lookup"><span data-stu-id="1e48c-128">This section describes how to configure the authentication middleware in ASP.NET Core for multitenant authentication with OpenID Connect.</span></span>

<span data-ttu-id="1e48c-129">Az a [indítási osztályt](/aspnet/core/fundamentals/startup), az OpenID Connect közbenső szoftver hozzáadása:</span><span class="sxs-lookup"><span data-stu-id="1e48c-129">In your [startup class](/aspnet/core/fundamentals/startup), add the OpenID Connect middleware:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(new OpenIdConnectOptions {
    ClientId = configOptions.AzureAd.ClientId,
    ClientSecret = configOptions.AzureAd.ClientSecret, // for code flow
    Authority = Constants.AuthEndpointPrefix,
    ResponseType = OpenIdConnectResponseType.CodeIdToken,
    PostLogoutRedirectUri = configOptions.AzureAd.PostLogoutRedirectUri,
    SignInScheme = CookieAuthenticationDefaults.AuthenticationScheme,
    TokenValidationParameters = new TokenValidationParameters { ValidateIssuer = false },
    Events = new SurveyAuthenticationEvents(configOptions.AzureAd, loggerFactory),
});
```

<span data-ttu-id="1e48c-130">Figyelje meg, hogy néhány beállítás, megnyílik a futásidejű konfigurációs beállításai.</span><span class="sxs-lookup"><span data-stu-id="1e48c-130">Notice that some of the settings are taken from runtime configuration options.</span></span> <span data-ttu-id="1e48c-131">Íme a közbenső szoftver beállítások jelenti:</span><span class="sxs-lookup"><span data-stu-id="1e48c-131">Here's what the middleware options mean:</span></span>

- <span data-ttu-id="1e48c-132">**ClientId**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-132">**ClientId**.</span></span> <span data-ttu-id="1e48c-133">Az alkalmazás ügyfél-azonosító, amely az Azure ad-ben az alkalmazás regisztrálásakor kapott.</span><span class="sxs-lookup"><span data-stu-id="1e48c-133">The application's client ID, which you got when you registered the application in Azure AD.</span></span>
- <span data-ttu-id="1e48c-134">**Szolgáltató**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-134">**Authority**.</span></span> <span data-ttu-id="1e48c-135">Több-bérlős alkalmazás esetében állítsa ezt a beállítást `https://login.microsoftonline.com/common/`.</span><span class="sxs-lookup"><span data-stu-id="1e48c-135">For a multitenant application, set this to `https://login.microsoftonline.com/common/`.</span></span> <span data-ttu-id="1e48c-136">Ez az az Azure AD közös végpont, amely lehetővé teszi a felhasználók bármilyen Azure AD-bérlővel, jelentkezzen be az URL-CÍMÉT.</span><span class="sxs-lookup"><span data-stu-id="1e48c-136">This is the URL for the Azure AD common endpoint, which enables users from any Azure AD tenant to sign in.</span></span> <span data-ttu-id="1e48c-137">A közös végpontot kapcsolatos további információkért lásd: [ebben a blogbejegyzésben](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span><span class="sxs-lookup"><span data-stu-id="1e48c-137">For more information about the common endpoint, see [this blog post](https://www.cloudidentity.com/blog/2014/08/26/the-common-endpoint-walks-like-a-tenant-talks-like-a-tenant-but-is-not-a-tenant/).</span></span>
- <span data-ttu-id="1e48c-138">A **TokenValidationParameters**állítsa be **ValidateIssuer** hamis értékre.</span><span class="sxs-lookup"><span data-stu-id="1e48c-138">In **TokenValidationParameters**, set **ValidateIssuer** to false.</span></span> <span data-ttu-id="1e48c-139">Ez azt jelenti, hogy az alkalmazás felelős a kibocsátó értékét az azonosító jogkivonat érvényesítése.</span><span class="sxs-lookup"><span data-stu-id="1e48c-139">That means the app will be responsible for validating the issuer value in the ID token.</span></span> <span data-ttu-id="1e48c-140">(A közbenső szoftver továbbra is érvényesíti a jogkivonatot magát.) A kibocsátó ellenőrzésével kapcsolatos további információkért lásd: [kibocsátó érvényesítése](claims.md#issuer-validation).</span><span class="sxs-lookup"><span data-stu-id="1e48c-140">(The middleware still validates the token itself.) For more information about validating the issuer, see [Issuer validation](claims.md#issuer-validation).</span></span>
- <span data-ttu-id="1e48c-141">**PostLogoutRedirectUri**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-141">**PostLogoutRedirectUri**.</span></span> <span data-ttu-id="1e48c-142">Adja meg a felhasználók átirányítása után a kijelentkezési URL-címet. Ez lehet egy oldal, amely lehetővé teszi a névtelen kérelmek &mdash; általában a kezdőlapon.</span><span class="sxs-lookup"><span data-stu-id="1e48c-142">Specify a URL to redirect users after the sign out. This should be a page that allows anonymous requests &mdash; typically the home page.</span></span>
- <span data-ttu-id="1e48c-143">**SignInScheme**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-143">**SignInScheme**.</span></span> <span data-ttu-id="1e48c-144">Állítsa a bestattempt értékre `CookieAuthenticationDefaults.AuthenticationScheme`.</span><span class="sxs-lookup"><span data-stu-id="1e48c-144">Set this to `CookieAuthenticationDefaults.AuthenticationScheme`.</span></span> <span data-ttu-id="1e48c-145">Ez a beállítás azt jelenti, hogy a felhasználó hitelesítése után a felhasználói jogcímeket a rendszer helyben tárolja egy cookie-ban.</span><span class="sxs-lookup"><span data-stu-id="1e48c-145">This setting means that after the user is authenticated, the user claims are stored locally in a cookie.</span></span> <span data-ttu-id="1e48c-146">Ez a cookie módját a felhasználó bejelentkezve marad a böngésző-munkamenet során.</span><span class="sxs-lookup"><span data-stu-id="1e48c-146">This cookie is how the user stays logged in during the browser session.</span></span>
- <span data-ttu-id="1e48c-147">**Események.**</span><span class="sxs-lookup"><span data-stu-id="1e48c-147">**Events.**</span></span> <span data-ttu-id="1e48c-148">Esemény visszahívások; Lásd: [hitelesítési események](#authentication-events).</span><span class="sxs-lookup"><span data-stu-id="1e48c-148">Event callbacks; see [Authentication events](#authentication-events).</span></span>

<span data-ttu-id="1e48c-149">A folyamat a hitelesítési cookie-k közbenső is hozzáadhat.</span><span class="sxs-lookup"><span data-stu-id="1e48c-149">Also add the Cookie Authentication middleware to the pipeline.</span></span> <span data-ttu-id="1e48c-150">A közbenső szoftver felelős a felhasználói jogcímeket a cookie-k írásakor, és a cookie-k során későbbi lapbetöltések olvassa.</span><span class="sxs-lookup"><span data-stu-id="1e48c-150">This middleware is responsible for writing the user claims to a cookie, and then reading the cookie during subsequent page loads.</span></span>

```csharp
app.UseCookieAuthentication(new CookieAuthenticationOptions {
    AutomaticAuthenticate = true,
    AutomaticChallenge = true,
    AccessDeniedPath = "/Home/Forbidden",
    CookieSecure = CookieSecurePolicy.Always,

    // The default setting for cookie expiration is 14 days. SlidingExpiration is set to true by default
    ExpireTimeSpan = TimeSpan.FromHours(1),
    SlidingExpiration = true
});
```

## <a name="initiate-the-authentication-flow"></a><span data-ttu-id="1e48c-151">A hitelesítési folyamat elindításához</span><span class="sxs-lookup"><span data-stu-id="1e48c-151">Initiate the authentication flow</span></span>

<span data-ttu-id="1e48c-152">A hitelesítési folyamat elindításához az ASP.NET mvc-ben, adja vissza egy **ChallengeResult** származó a contoller:</span><span class="sxs-lookup"><span data-stu-id="1e48c-152">To start the authentication flow in ASP.NET MVC, return a **ChallengeResult** from the contoller:</span></span>

```csharp
[AllowAnonymous]
public IActionResult SignIn()
{
    return new ChallengeResult(
        OpenIdConnectDefaults.AuthenticationScheme,
        new AuthenticationProperties
        {
            IsPersistent = true,
            RedirectUri = Url.Action("SignInCallback", "Account")
        });
}
```

<span data-ttu-id="1e48c-153">Ennek hatására a közbenső szoftvert választ 302 (található), amely átirányítja a felhasználókat a hitelesítési végpontra.</span><span class="sxs-lookup"><span data-stu-id="1e48c-153">This causes the middleware to return a 302 (Found) response that redirects to the authentication endpoint.</span></span>

## <a name="user-login-sessions"></a><span data-ttu-id="1e48c-154">Felhasználói munkamenetek</span><span class="sxs-lookup"><span data-stu-id="1e48c-154">User login sessions</span></span>

<span data-ttu-id="1e48c-155">Ahogy említettük, ha a felhasználó először jelentkezik be, a hitelesítési cookie-k közbenső ír egy cookie-t a felhasználói jogcímeket.</span><span class="sxs-lookup"><span data-stu-id="1e48c-155">As mentioned, when the user first signs in, the Cookie Authentication middleware writes the user claims to a cookie.</span></span> <span data-ttu-id="1e48c-156">Ezt követően a HTTP-kérések hitelesítése a cookie-k olvasása.</span><span class="sxs-lookup"><span data-stu-id="1e48c-156">After that, HTTP requests are authenticated by reading the cookie.</span></span>

<span data-ttu-id="1e48c-157">Alapértelmezés szerint a cookie-k közbenső ír egy [munkamenetcookie-t][session-cookie], mely beolvasása törlése után a felhasználó bezárja a böngészőt.</span><span class="sxs-lookup"><span data-stu-id="1e48c-157">By default, the cookie middleware writes a [session cookie][session-cookie], which gets deleted once the user closes the browser.</span></span> <span data-ttu-id="1e48c-158">A következő alkalommal, amikor a felhasználó ezután felkeresi a webhelyet, akkor kell jelentkezzen be újra.</span><span class="sxs-lookup"><span data-stu-id="1e48c-158">The next time the user next visits the site, they will have to sign in again.</span></span> <span data-ttu-id="1e48c-159">Azonban ha **IsPersistent** true-ra a **ChallengeResult**, a közbenső szoftver ír egy állandó cookie-t, ezért a böngésző bezárása után a felhasználó bejelentkezve marad.</span><span class="sxs-lookup"><span data-stu-id="1e48c-159">However, if you set **IsPersistent** to true in the **ChallengeResult**, the middleware writes a persistent cookie, so the user stays logged in after closing the browser.</span></span> <span data-ttu-id="1e48c-160">Beállíthatja, hogy a cookie lejáratának; Lásd: [cookie beállításai szabályozása][cookie-options].</span><span class="sxs-lookup"><span data-stu-id="1e48c-160">You can configure the cookie expiration; see [Controlling cookie options][cookie-options].</span></span> <span data-ttu-id="1e48c-161">Maradandó cookie-k a felhasználók kényelmesebb, de lehet, hogy nem megfelelő alkalmazások (például, egy banki alkalmazás) Amennyiben azt szeretné, hogy a felhasználót, hogy jelentkezzen be minden alkalommal.</span><span class="sxs-lookup"><span data-stu-id="1e48c-161">Persistent cookies are more convenient for the user, but may be inappropriate for some applications (say, a banking application) where you want the user to sign in every time.</span></span>

## <a name="about-the-openid-connect-middleware"></a><span data-ttu-id="1e48c-162">Tudnivalók az OpenID Connect közbenső szoftvert</span><span class="sxs-lookup"><span data-stu-id="1e48c-162">About the OpenID Connect middleware</span></span>

<span data-ttu-id="1e48c-163">Az OpenID Connect közbenső szoftvert az ASP.NET elrejti a legtöbb protokoll részleteit.</span><span class="sxs-lookup"><span data-stu-id="1e48c-163">The OpenID Connect middleware in ASP.NET hides most of the protocol details.</span></span> <span data-ttu-id="1e48c-164">Ez a szakasz tartalmaz néhány megjegyzés, amely lehet hasznos, ha a protokoll folyamat ismertetése megvalósításával kapcsolatban.</span><span class="sxs-lookup"><span data-stu-id="1e48c-164">This section contains some notes about the implementation, that may be useful for understanding the protocol flow.</span></span>

<span data-ttu-id="1e48c-165">Először is hozzunk vizsgálja meg a hitelesítési folyamat alapján (figyelmen kívül hagyja az alkalmazás és az Azure AD közötti OIDC protokoll folyamat részletei) az ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="1e48c-165">First, let's examine the authentication flow in terms of ASP.NET (ignoring the details of the OIDC protocol flow between the app and Azure AD).</span></span> <span data-ttu-id="1e48c-166">Az alábbi ábrán látható a folyamat.</span><span class="sxs-lookup"><span data-stu-id="1e48c-166">The following diagram shows the process.</span></span>

![Bejelentkezési folyamata](./images/sign-in-flow.png)

<span data-ttu-id="1e48c-168">Ezen az ábrán két MVC-vezérlők vannak.</span><span class="sxs-lookup"><span data-stu-id="1e48c-168">In this diagram, there are two MVC controllers.</span></span> <span data-ttu-id="1e48c-169">A fiók vezérlő bejelentkezési kérelmet kezel, és a kezdőlapvezérlő kiszolgálja a kezdőlapon.</span><span class="sxs-lookup"><span data-stu-id="1e48c-169">The Account controller handles sign-in requests, and the Home controller serves up the home page.</span></span>

<span data-ttu-id="1e48c-170">A hitelesítési folyamat a következő:</span><span class="sxs-lookup"><span data-stu-id="1e48c-170">Here is the authentication process:</span></span>

1. <span data-ttu-id="1e48c-171">A felhasználó a "Sign-in" gombra kattint, és a böngészőben a GET-kérést küld.</span><span class="sxs-lookup"><span data-stu-id="1e48c-171">The user clicks the "Sign in" button, and the browser sends a GET request.</span></span> <span data-ttu-id="1e48c-172">Például: `GET /Account/SignIn/`.</span><span class="sxs-lookup"><span data-stu-id="1e48c-172">For example: `GET /Account/SignIn/`.</span></span>
2. <span data-ttu-id="1e48c-173">A fiók vezérlő értéket ad vissza egy `ChallengeResult`.</span><span class="sxs-lookup"><span data-stu-id="1e48c-173">The account controller returns a `ChallengeResult`.</span></span>
3. <span data-ttu-id="1e48c-174">A OIDC közbenső HTTP 302 választ, az Azure AD-átirányítás adja vissza.</span><span class="sxs-lookup"><span data-stu-id="1e48c-174">The OIDC middleware returns an HTTP 302 response, redirecting to Azure AD.</span></span>
4. <span data-ttu-id="1e48c-175">A böngészőben a hitelesítési kérést küld az Azure ad-ben</span><span class="sxs-lookup"><span data-stu-id="1e48c-175">The browser sends the authentication request to Azure AD</span></span>
5. <span data-ttu-id="1e48c-176">A felhasználó bejelentkezik az Azure ad-hez, és az Azure AD választ küld vissza hitelesítést.</span><span class="sxs-lookup"><span data-stu-id="1e48c-176">The user signs in to Azure AD, and Azure AD sends back an authentication response.</span></span>
6. <span data-ttu-id="1e48c-177">A OIDC közbenső rendszerbiztonsági tag jogcímeket hoz létre, és továbbítja azt a hitelesítési cookie-k közbenső szoftver.</span><span class="sxs-lookup"><span data-stu-id="1e48c-177">The OIDC middleware creates a claims principal and passes it to the Cookie Authentication middleware.</span></span>
7. <span data-ttu-id="1e48c-178">A cookie-k közbenső szerializálja a jogcímtag, és beállítja a cookie-k.</span><span class="sxs-lookup"><span data-stu-id="1e48c-178">The cookie middleware serializes the claims principal and sets a cookie.</span></span>
8. <span data-ttu-id="1e48c-179">A OIDC közbenső átirányítja az alkalmazás visszahívási URL-CÍMÉT.</span><span class="sxs-lookup"><span data-stu-id="1e48c-179">The OIDC middleware redirects to the application's callback URL.</span></span>
9. <span data-ttu-id="1e48c-180">A böngészőben a cookie-t küld a kérelemben szereplő átirányítási követi.</span><span class="sxs-lookup"><span data-stu-id="1e48c-180">The browser follows the redirect, sending the cookie in the request.</span></span>
10. <span data-ttu-id="1e48c-181">A cookie-k közbenső deserializes egy egyszerű jogcímek a cookie-k, és beállítja a `HttpContext.User` a jogcímtag egyenlő.</span><span class="sxs-lookup"><span data-stu-id="1e48c-181">The cookie middleware deserializes the cookie to a claims principal and sets `HttpContext.User` equal to the claims principal.</span></span> <span data-ttu-id="1e48c-182">A kérelem egy MVC-vezérlő irányítja a rendszer.</span><span class="sxs-lookup"><span data-stu-id="1e48c-182">The request is routed to an MVC controller.</span></span>

### <a name="authentication-ticket"></a><span data-ttu-id="1e48c-183">Hitelesítési jegy</span><span class="sxs-lookup"><span data-stu-id="1e48c-183">Authentication ticket</span></span>

<span data-ttu-id="1e48c-184">Ha a hitelesítés sikeres, a OIDC közbenső hitelesítési jegyre, amely tartalmazza a felhasználói jogcímeket tartalmazó jogcímeket rendszerbiztonsági tag hoz létre.</span><span class="sxs-lookup"><span data-stu-id="1e48c-184">If authentication succeeds, the OIDC middleware creates an authentication ticket, which contains a claims principal that holds the user's claims.</span></span> <span data-ttu-id="1e48c-185">A jegy belül hozzáférhet a **AuthenticationValidated** vagy **TicketReceived** esemény.</span><span class="sxs-lookup"><span data-stu-id="1e48c-185">You can access the ticket inside the **AuthenticationValidated** or **TicketReceived** event.</span></span>

> [!NOTE]
> <span data-ttu-id="1e48c-186">Az egész hitelesítési folyamat befejezéséig `HttpContext.User` továbbra is fogja tárolni egy névtelen egyszerű **nem** a hitelesített felhasználó.</span><span class="sxs-lookup"><span data-stu-id="1e48c-186">Until the entire authentication flow is completed, `HttpContext.User` still holds an anonymous principal, **not** the authenticated user.</span></span> <span data-ttu-id="1e48c-187">A névtelen egyszerű egy üres jogcímek gyűjteménye van.</span><span class="sxs-lookup"><span data-stu-id="1e48c-187">The anonymous principal has an empty claims collection.</span></span> <span data-ttu-id="1e48c-188">Hitelesítés befejeződik, és az alkalmazás átirányítja a cookie-k közbenső deserializes után a hitelesítési cookie-k és a csoportok `HttpContext.User` a jogcímek egyszerű, amely a hitelesített felhasználó jelöli.</span><span class="sxs-lookup"><span data-stu-id="1e48c-188">After authentication completes and the app redirects, the cookie middleware deserializes the authentication cookie and sets `HttpContext.User` to a claims principal that represents the authenticated user.</span></span>

### <a name="authentication-events"></a><span data-ttu-id="1e48c-189">Hitelesítési események</span><span class="sxs-lookup"><span data-stu-id="1e48c-189">Authentication events</span></span>

<span data-ttu-id="1e48c-190">A hitelesítési folyamat során az OpenID Connect közbenső szoftvert események sorát vet fel:</span><span class="sxs-lookup"><span data-stu-id="1e48c-190">During the authentication process, the OpenID Connect middleware raises a series of events:</span></span>

- <span data-ttu-id="1e48c-191">**RedirectToIdentityProvider**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-191">**RedirectToIdentityProvider**.</span></span> <span data-ttu-id="1e48c-192">Nevű jobb, előtt a közbenső szoftver a hitelesítési végpontra irányítja át.</span><span class="sxs-lookup"><span data-stu-id="1e48c-192">Called right before the middleware redirects to the authentication endpoint.</span></span> <span data-ttu-id="1e48c-193">Használhatja ezt az eseményt az átirányítási URL-címet; Ha például a kérelem paramétereinek hozzáadása.</span><span class="sxs-lookup"><span data-stu-id="1e48c-193">You can use this event to modify the redirect URL; for example, to add request parameters.</span></span> <span data-ttu-id="1e48c-194">Lásd: [hozzáadása a rendszergazda beleegyezést kérő](signup.md#adding-the-admin-consent-prompt) példaként.</span><span class="sxs-lookup"><span data-stu-id="1e48c-194">See [Adding the admin consent prompt](signup.md#adding-the-admin-consent-prompt) for an example.</span></span>
- <span data-ttu-id="1e48c-195">**AuthorizationCodeReceived**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-195">**AuthorizationCodeReceived**.</span></span> <span data-ttu-id="1e48c-196">Az engedélyezési kódot meghívva.</span><span class="sxs-lookup"><span data-stu-id="1e48c-196">Called with the authorization code.</span></span>
- <span data-ttu-id="1e48c-197">**TokenResponseReceived**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-197">**TokenResponseReceived**.</span></span> <span data-ttu-id="1e48c-198">Neve az a közbenső szoftver lekérése hozzáférési token az Identitásszolgáltató, de előtt érvényességét.</span><span class="sxs-lookup"><span data-stu-id="1e48c-198">Called after the middleware gets an access token from the IDP, but before it is validated.</span></span> <span data-ttu-id="1e48c-199">Csak az engedélyezési kód folyamata vonatkozik.</span><span class="sxs-lookup"><span data-stu-id="1e48c-199">Applies only to authorization code flow.</span></span>
- <span data-ttu-id="1e48c-200">**TokenValidated**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-200">**TokenValidated**.</span></span> <span data-ttu-id="1e48c-201">Miután a közbenső szoftver ellenőrzi az azonosító jogkivonat neve.</span><span class="sxs-lookup"><span data-stu-id="1e48c-201">Called after the middleware validates the ID token.</span></span> <span data-ttu-id="1e48c-202">Ezen a ponton az alkalmazás rendelkezik a felhasználóval kapcsolatos ellenőrzött jogcímek egy készletét.</span><span class="sxs-lookup"><span data-stu-id="1e48c-202">At this point, the application has a set of validated claims about the user.</span></span> <span data-ttu-id="1e48c-203">Ezt az eseményt a további ellenőrzéshez a jogcímek, vagy a jogcímek átalakítására használható.</span><span class="sxs-lookup"><span data-stu-id="1e48c-203">You can use this event to perform additional validation on the claims, or to transform claims.</span></span> <span data-ttu-id="1e48c-204">Lásd: [használata](claims.md).</span><span class="sxs-lookup"><span data-stu-id="1e48c-204">See [Working with claims](claims.md).</span></span>
- <span data-ttu-id="1e48c-205">**UserInformationReceived**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-205">**UserInformationReceived**.</span></span> <span data-ttu-id="1e48c-206">Ha a közbenső szoftver a felhasználói profil olvas be a felhasználói adatok végpont neve.</span><span class="sxs-lookup"><span data-stu-id="1e48c-206">Called if the middleware gets the user profile from the user info endpoint.</span></span> <span data-ttu-id="1e48c-207">Csak az engedélyezési kód folyamata, és csak akkor vonatkozik `GetClaimsFromUserInfoEndpoint = true` a közbenső szoftver beállítások között.</span><span class="sxs-lookup"><span data-stu-id="1e48c-207">Applies only to authorization code flow, and only when `GetClaimsFromUserInfoEndpoint = true` in the middleware options.</span></span>
- <span data-ttu-id="1e48c-208">**TicketReceived**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-208">**TicketReceived**.</span></span> <span data-ttu-id="1e48c-209">Meghívva, ha a hitelesítés végbemegy.</span><span class="sxs-lookup"><span data-stu-id="1e48c-209">Called when authentication is completed.</span></span> <span data-ttu-id="1e48c-210">Ez az az utolsó esemény, feltéve, hogy a hitelesítés sikeres lesz.</span><span class="sxs-lookup"><span data-stu-id="1e48c-210">This is the last event, assuming that authentication succeeds.</span></span> <span data-ttu-id="1e48c-211">Ez az esemény történik, ha a felhasználó bejelentkezett az alkalmazásba.</span><span class="sxs-lookup"><span data-stu-id="1e48c-211">After this event is handled, the user is signed into the app.</span></span>
- <span data-ttu-id="1e48c-212">**AuthenticationFailed**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-212">**AuthenticationFailed**.</span></span> <span data-ttu-id="1e48c-213">Ha a hitelesítés sikertelen nevezik.</span><span class="sxs-lookup"><span data-stu-id="1e48c-213">Called if authentication fails.</span></span> <span data-ttu-id="1e48c-214">Ez az esemény segítségével hitelesítési hibák kezelésére &mdash; például úgy, hogy egy hibalap átirányítása.</span><span class="sxs-lookup"><span data-stu-id="1e48c-214">Use this event to handle authentication failures &mdash; for example, by redirecting to an error page.</span></span>

<span data-ttu-id="1e48c-215">Adja meg visszahívások ezeket az eseményeket, állítsa be a **események** a közbenső szoftverek lehetőséget.</span><span class="sxs-lookup"><span data-stu-id="1e48c-215">To provide callbacks for these events, set the **Events** option on the middleware.</span></span> <span data-ttu-id="1e48c-216">Az eseménykezelőket deklarálnia két különböző módja van: Beágyazott lambdas, vagy az a osztálynak **OpenIdConnectEvents**.</span><span class="sxs-lookup"><span data-stu-id="1e48c-216">There are two different ways to declare the event handlers: Inline with lambdas, or in a class that derives from **OpenIdConnectEvents**.</span></span> <span data-ttu-id="1e48c-217">A második megközelítéssel ajánlott, ha az esemény-visszahívások bármely jelentős logikát, így azok feleslegesen ne tűzdelje tele az indítási osztályt.</span><span class="sxs-lookup"><span data-stu-id="1e48c-217">The second approach is recommended if your event callbacks have any substantial logic, so they don't clutter your startup class.</span></span> <span data-ttu-id="1e48c-218">Referenciaimplementáció ezt a módszert használja.</span><span class="sxs-lookup"><span data-stu-id="1e48c-218">Our reference implementation uses this approach.</span></span>

### <a name="openid-connect-endpoints"></a><span data-ttu-id="1e48c-219">OpenID Connect végpontok</span><span class="sxs-lookup"><span data-stu-id="1e48c-219">OpenID Connect endpoints</span></span>

<span data-ttu-id="1e48c-220">Az Azure AD támogatja [OpenID Connect-felderítési](https://openid.net/specs/openid-connect-discovery-1_0.html), viselkedésmintáit az identitásszolgáltató (IDP) adja vissza a JSON-metaadatok dokumentumok egy [jól ismert végpont](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span><span class="sxs-lookup"><span data-stu-id="1e48c-220">Azure AD supports [OpenID Connect Discovery](https://openid.net/specs/openid-connect-discovery-1_0.html), wherein the identity provider (IDP) returns a JSON metadata document from a [well-known endpoint](https://openid.net/specs/openid-connect-discovery-1_0.html#ProviderConfig).</span></span> <span data-ttu-id="1e48c-221">A metaadat-dokumentum például tartalmaz információkat:</span><span class="sxs-lookup"><span data-stu-id="1e48c-221">The metadata document contains information such as:</span></span>

- <span data-ttu-id="1e48c-222">Az engedélyezési végpont URL-címe</span><span class="sxs-lookup"><span data-stu-id="1e48c-222">The URL of the authorization endpoint.</span></span> <span data-ttu-id="1e48c-223">Ez az, ahol az alkalmazás átirányítja a felhasználókat a felhasználó hitelesítéséhez.</span><span class="sxs-lookup"><span data-stu-id="1e48c-223">This is where the app redirects to authenticate the user.</span></span>
- <span data-ttu-id="1e48c-224">Az URL-címe az "a munkamenet befejezése" végpont, ahol az alkalmazás felhasználójának kijelentkeztetése ugrik.</span><span class="sxs-lookup"><span data-stu-id="1e48c-224">The URL of the "end session" endpoint, where the app goes to log out the user.</span></span>
- <span data-ttu-id="1e48c-225">Az aláíró kulcsok, amelyek az ügyfél használatával, amely lekéri az identitásszolgáltató OIDC jogkivonatok érvényesítésére lekérése az URL-címe.</span><span class="sxs-lookup"><span data-stu-id="1e48c-225">The URL to get the signing keys, which the client uses to validate the OIDC tokens that it gets from the IDP.</span></span>

<span data-ttu-id="1e48c-226">Alapértelmezés szerint a OIDC közbenső meg tudja beolvasni a metaadatok.</span><span class="sxs-lookup"><span data-stu-id="1e48c-226">By default, the OIDC middleware knows how to fetch this metadata.</span></span> <span data-ttu-id="1e48c-227">Állítsa be a **hatóság** opcióhoz a közbenső szoftver, és a közbenső szoftver hoz létre a metaadatok URL-CÍMÉT.</span><span class="sxs-lookup"><span data-stu-id="1e48c-227">Set the **Authority** option in the middleware, and the middleware constructs the URL for the metadata.</span></span> <span data-ttu-id="1e48c-228">(Beállításával felülbírálhatja a metaadatok URL-címe a **MetadataAddress** beállítás.)</span><span class="sxs-lookup"><span data-stu-id="1e48c-228">(You can override the metadata URL by setting the **MetadataAddress** option.)</span></span>

### <a name="openid-connect-flows"></a><span data-ttu-id="1e48c-229">OpenID Connect folyamatok</span><span class="sxs-lookup"><span data-stu-id="1e48c-229">OpenID Connect flows</span></span>

<span data-ttu-id="1e48c-230">Alapértelmezés szerint a OIDC közbenső hibrid folyamat használja az űrlap post Válaszmód.</span><span class="sxs-lookup"><span data-stu-id="1e48c-230">By default, the OIDC middleware uses hybrid flow with form post response mode.</span></span>

- <span data-ttu-id="1e48c-231">*Hibrid folyamat* azt jelenti, hogy az ügyfél kérheti egy azonosító jogkivonat és a egy engedélyezési kód ugyanazon oda-vissza, az engedélyezési kiszolgáló.</span><span class="sxs-lookup"><span data-stu-id="1e48c-231">*Hybrid flow* means the client can get an ID token and an authorization code in the same round-trip to the authorization server.</span></span>
- <span data-ttu-id="1e48c-232">*Űrlap post összesítéshez mód* azt jelenti, hogy az engedélyezési kiszolgáló HTTP-közzététel kérelmet használ az azonosító jogkivonat és engedélyezési kód küldése az alkalmazásnak.</span><span class="sxs-lookup"><span data-stu-id="1e48c-232">*Form post reponse mode* means the authorization server uses an HTTP POST request to send the ID token and authorization code to the app.</span></span> <span data-ttu-id="1e48c-233">Az értékek a következők űrlap-kulcstárolókat (tartalomtípus = "application/x-www-form-urlencoded").</span><span class="sxs-lookup"><span data-stu-id="1e48c-233">The values are form-urlencoded (content type = "application/x-www-form-urlencoded").</span></span>

<span data-ttu-id="1e48c-234">Ha a OIDC közbenső szoftver az engedélyezési végpontra irányítja, az átirányítási URL-cím tartalmazza az összes OIDC által igényelt, a lekérdezési karakterlánc paraméterei.</span><span class="sxs-lookup"><span data-stu-id="1e48c-234">When the OIDC middleware redirects to the authorization endpoint, the redirect URL includes all of the query string parameters needed by OIDC.</span></span> <span data-ttu-id="1e48c-235">A hibrid flow:</span><span class="sxs-lookup"><span data-stu-id="1e48c-235">For hybrid flow:</span></span>

- <span data-ttu-id="1e48c-236">client_id.</span><span class="sxs-lookup"><span data-stu-id="1e48c-236">client_id.</span></span> <span data-ttu-id="1e48c-237">Ez az érték meg a **ClientId** lehetőség</span><span class="sxs-lookup"><span data-stu-id="1e48c-237">This value is set in the **ClientId** option</span></span>
- <span data-ttu-id="1e48c-238">hatókör = "openid profile", ami azt jelenti, OIDC kérelmet, és szeretnénk, hogy a felhasználó profilját.</span><span class="sxs-lookup"><span data-stu-id="1e48c-238">scope = "openid profile", which means it's an OIDC request and we want the user's profile.</span></span>
- <span data-ttu-id="1e48c-239">response_type = "code id_token".</span><span class="sxs-lookup"><span data-stu-id="1e48c-239">response_type  = "code id_token".</span></span> <span data-ttu-id="1e48c-240">Azt határozza meg a hibrid folyamat.</span><span class="sxs-lookup"><span data-stu-id="1e48c-240">This specifies hybrid flow.</span></span>
- <span data-ttu-id="1e48c-241">response_mode = "form_post".</span><span class="sxs-lookup"><span data-stu-id="1e48c-241">response_mode = "form_post".</span></span> <span data-ttu-id="1e48c-242">Azt határozza meg a post válasz.</span><span class="sxs-lookup"><span data-stu-id="1e48c-242">This specifies form post response.</span></span>

<span data-ttu-id="1e48c-243">Adjon meg egy másik folyamat, állítsa be a **ResponseType** tulajdonság a beállítások.</span><span class="sxs-lookup"><span data-stu-id="1e48c-243">To specify a different flow, set the **ResponseType** property on the options.</span></span> <span data-ttu-id="1e48c-244">Példa:</span><span class="sxs-lookup"><span data-stu-id="1e48c-244">For example:</span></span>

```csharp
app.UseOpenIdConnectAuthentication(options =>
{
    options.ResponseType = "code"; // Authorization code flow

    // Other options
}
```

<span data-ttu-id="1e48c-245">[**Tovább**][claims]</span><span class="sxs-lookup"><span data-stu-id="1e48c-245">[**Next**][claims]</span></span>

[claims]: claims.md
[cookie-options]: /aspnet/core/security/authentication/cookie#controlling-cookie-options
[session-cookie]: https://en.wikipedia.org/wiki/HTTP_cookie#Session_cookie
[sample application]: https://github.com/mspnp/multitenant-saas-guidance
