---
title: Magas rendelkezésre állású virtuális hálózati berendezések üzembe helyezése
titleSuffix: Azure Reference Architectures
description: Magas rendelkezésre állású virtuális berendezések üzembe helyezéséről.
author: telmosampaio
ms.date: 12/08/2018
ms.custom: seodec18
ms.openlocfilehash: d3f9017db1bbf9741b10db16eb5a3dbab78f1160
ms.sourcegitcommit: 7d21aec9d9de0004ac777c1d1e364f53aac2350d
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 12/09/2018
ms.locfileid: "53120752"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="a512d-103">Magas rendelkezésre állású virtuális hálózati berendezések üzembe helyezése</span><span class="sxs-lookup"><span data-stu-id="a512d-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="a512d-104">Ez a cikk a magas rendelkezésre állású hálózati virtuális berendezések (network virtual appliance, NVA) Azure-ban való üzembe helyezésének módját ismerteti.</span><span class="sxs-lookup"><span data-stu-id="a512d-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="a512d-105">Az NVA-kat általában a szegélyhálózatokról, más néven DMZ-kről a más hálózatok és alhálózatok felé irányuló hálózati forgalom szabályozására használják.</span><span class="sxs-lookup"><span data-stu-id="a512d-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="a512d-106">Az DMZ Azure-ban történő implementálásával kapcsolatos további tudnivalókért lásd a [Microsoft-felhőszolgáltatásokkal és a hálózati biztonsággal][cloud-security] foglalkozó cikket.</span><span class="sxs-lookup"><span data-stu-id="a512d-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="a512d-107">A cikk csak bejövő, csak kimenő, valamint bejövő és kimenő forgalmú példaarchitektúrákat is tartalmaz.</span><span class="sxs-lookup"><span data-stu-id="a512d-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="a512d-108">**Előfeltételek:** A jelen cikk feltételezi, hogy az olvasó alapszinten érti az Azure-hálózatok, az [Azure-terheléselosztók][lb-overview] és a [felhasználó által definiált útvonalak][udr-overview] (UDR-ek) működését.</span><span class="sxs-lookup"><span data-stu-id="a512d-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="a512d-109">Architektúra-diagramok</span><span class="sxs-lookup"><span data-stu-id="a512d-109">Architecture diagrams</span></span>

<span data-ttu-id="a512d-110">Az NVA-k számos különböző architektúrában helyezhetők üzembe egy DMZ-n.</span><span class="sxs-lookup"><span data-stu-id="a512d-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="a512d-111">A következő ábra például [egyetlen NVA][nva-scenario] bejövő forgalomhoz való használatát illusztrálja.</span><span class="sxs-lookup"><span data-stu-id="a512d-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="a512d-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="a512d-112">![[0]][0]</span></span>

<span data-ttu-id="a512d-113">Ebben az architektúrában az NVA biztonságos hálózati határt biztosít az összes bejövő és kimenő hálózati forgalom ellenőrzésével, és csak azt a forgalmat engedi át, amely megfelel a hálózati biztonsági szabályoknak.</span><span class="sxs-lookup"><span data-stu-id="a512d-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="a512d-114">Az a tény azonban, hogy az összes hálózati forgalom az NVA-n halad keresztül, azt eredményezi, hogy az NVA rendszerkritikus meghibásodási pontot képez a hálózatban.</span><span class="sxs-lookup"><span data-stu-id="a512d-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="a512d-115">Ha az NVA leáll, akkor nincs más útvonal a hálózati forgalom számára, és a háttérbeli alhálózatok nem lesznek elérhetők.</span><span class="sxs-lookup"><span data-stu-id="a512d-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="a512d-116">Az NVA magas rendelkezésre állásúvá tételéhez helyezzen üzembe több NVA-t egy rendelkezésre állási csoport részeként.</span><span class="sxs-lookup"><span data-stu-id="a512d-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="a512d-117">A következő architektúrák bemutatják a magas rendelkezésre állású NVA-khoz szükséges erőforrásokat és konfigurációkat:</span><span class="sxs-lookup"><span data-stu-id="a512d-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

| <span data-ttu-id="a512d-118">Megoldás</span><span class="sxs-lookup"><span data-stu-id="a512d-118">Solution</span></span> | <span data-ttu-id="a512d-119">Előnyök</span><span class="sxs-lookup"><span data-stu-id="a512d-119">Benefits</span></span> | <span data-ttu-id="a512d-120">Megfontolandó szempontok</span><span class="sxs-lookup"><span data-stu-id="a512d-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="a512d-121">[Bejövő forgalom 7-es rétegű NVA-kkal][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="a512d-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="a512d-122">Az összes NVA-csomópont aktív</span><span class="sxs-lookup"><span data-stu-id="a512d-122">All NVA nodes are active</span></span> |<span data-ttu-id="a512d-123">Kapcsolatok leállítására és SNAT használatára képes NVA-t igényel</span><span class="sxs-lookup"><span data-stu-id="a512d-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="a512d-124">Külön NVA-készletet igényel az internetről és az Azure-ból érkező forgalomhoz</span><span class="sxs-lookup"><span data-stu-id="a512d-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="a512d-125">Csak az Azure-on kívülről származó forgalom kezelésére használható</span><span class="sxs-lookup"><span data-stu-id="a512d-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="a512d-126">[Kimenő forgalom 7-es rétegű NVA-kkal][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="a512d-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="a512d-127">Az összes NVA-csomópont aktív</span><span class="sxs-lookup"><span data-stu-id="a512d-127">All NVA nodes are active</span></span> | <span data-ttu-id="a512d-128">Kapcsolatok leállítására és forráshálózati címfordítás (source network address translation, SNAT) implementálására képes NVA-t igényel</span><span class="sxs-lookup"><span data-stu-id="a512d-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="a512d-129">[Bejövő és kimenő forgalom 7-es rétegű NVA-kkal][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="a512d-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="a512d-130">Az összes csomópont aktív</span><span class="sxs-lookup"><span data-stu-id="a512d-130">All nodes are active</span></span><br/><span data-ttu-id="a512d-131">Képes kezelni az Azure-ból eredő forgalmat</span><span class="sxs-lookup"><span data-stu-id="a512d-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="a512d-132">Kapcsolatok leállítására és SNAT használatára képes NVA-t igényel</span><span class="sxs-lookup"><span data-stu-id="a512d-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="a512d-133">Külön NVA-készletet igényel az internetről és az Azure-ból érkező forgalomhoz</span><span class="sxs-lookup"><span data-stu-id="a512d-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="a512d-134">[PIP-UDR kapcsoló][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="a512d-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="a512d-135">Egyetlen NVA-készlet az összes forgalomhoz</span><span class="sxs-lookup"><span data-stu-id="a512d-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="a512d-136">Az összes forgalom kezelésére képes (nincsenek korlátozva a portszabályok)</span><span class="sxs-lookup"><span data-stu-id="a512d-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="a512d-137">Aktív-passzív</span><span class="sxs-lookup"><span data-stu-id="a512d-137">Active-passive</span></span><br/><span data-ttu-id="a512d-138">Feladatátvételi folyamatot igényel</span><span class="sxs-lookup"><span data-stu-id="a512d-138">Requires a failover process</span></span> |
| [<span data-ttu-id="a512d-139">PIP-UDR SNAT</span><span class="sxs-lookup"><span data-stu-id="a512d-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="a512d-140">Egyetlen NVA-készlet az összes forgalomhoz</span><span class="sxs-lookup"><span data-stu-id="a512d-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="a512d-141">Az összes forgalom kezelésére képes (nincsenek korlátozva a portszabályok)</span><span class="sxs-lookup"><span data-stu-id="a512d-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="a512d-142">Nincs szükség a bejövő kéréseket SNAT konfigurálása</span><span class="sxs-lookup"><span data-stu-id="a512d-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="a512d-143">Aktív-passzív</span><span class="sxs-lookup"><span data-stu-id="a512d-143">Active-passive</span></span><br/><span data-ttu-id="a512d-144">Feladatátvételi folyamatot igényel</span><span class="sxs-lookup"><span data-stu-id="a512d-144">Requires a failover process</span></span><br/><span data-ttu-id="a512d-145">Tesztelés és a feladatátvételi logika futtatása a virtuális hálózaton kívül</span><span class="sxs-lookup"><span data-stu-id="a512d-145">Probing and failover logic run outside the virtual network</span></span> |

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="a512d-146">Bejövő forgalom 7-es rétegű NVA-kkal</span><span class="sxs-lookup"><span data-stu-id="a512d-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="a512d-147">Az alábbi ábrán egy magas rendelkezésre állású architektúra látható, amely egy internetkapcsolattal rendelkező terheléselosztó mögötti bejövő forgalmi DMZ-t implementál.</span><span class="sxs-lookup"><span data-stu-id="a512d-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="a512d-148">Ezt az architektúrát arra tervezték, hogy 7-es rétegű forgalmi kapcsolatot, például HTTP-t vagy HTTPS-t biztosítson Azure-beli számítási feladatokhoz:</span><span class="sxs-lookup"><span data-stu-id="a512d-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="a512d-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="a512d-149">![[1]][1]</span></span>

<span data-ttu-id="a512d-150">Az ilyen architektúra előnye, hogy minden NVA aktív, és ha az egyik meghibásodik, akkor a terheléselosztó átirányítja a hálózati forgalmat egy másikra.</span><span class="sxs-lookup"><span data-stu-id="a512d-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="a512d-151">Mindkét NVA a belső terheléselosztóra irányítja a forgalmat, így mindaddig, amíg egy NVA aktív, a forgalom nem akad el.</span><span class="sxs-lookup"><span data-stu-id="a512d-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="a512d-152">Az NVA-knak le kell zárnia a webes szintű virtuális gépek felé tartó SSL-forgalmat.</span><span class="sxs-lookup"><span data-stu-id="a512d-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="a512d-153">Ezek az NVA-k nem használhatók a helyszíni forgalom kezelésére, mert a helyszíni forgalom egy másik, saját hálózati útvonalakkal rendelkező dedikált NVA-készletet igényel.</span><span class="sxs-lookup"><span data-stu-id="a512d-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="a512d-154">Ezt az architektúrát az [Azure és a helyszíni adatközpont közötti DMZ][dmz-on-prem] és az [Azure és az internet közötti DMZ][dmz-internet] referenciaarchitektúrákban használják.</span><span class="sxs-lookup"><span data-stu-id="a512d-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="a512d-155">Ezen referenciaarchitektúrák mindegyike tartalmaz egy felhasználható üzembehelyezési megoldást.</span><span class="sxs-lookup"><span data-stu-id="a512d-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="a512d-156">További információkért kövesse a hivatkozásokat.</span><span class="sxs-lookup"><span data-stu-id="a512d-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="a512d-157">Kimenő forgalom 7-es rétegű NVA-kkal</span><span class="sxs-lookup"><span data-stu-id="a512d-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="a512d-158">Az előző architektúra bővíthető oly módon, hogy egy kimenő forgalmi DMZ-t is biztosítson az Azure-beli számítási feladatokból származó kérelmek kezelésére.</span><span class="sxs-lookup"><span data-stu-id="a512d-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="a512d-159">A következő architektúrát arra tervezték, hogy magas rendelkezésre állást biztosítson a DMZ-n lévő NVA-k számára 7-es rétegű forgalom (például HTTP vagy HTTPS) esetén:</span><span class="sxs-lookup"><span data-stu-id="a512d-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="a512d-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="a512d-160">![[2]][2]</span></span>

<span data-ttu-id="a512d-161">Ebben az architektúrában az Azure-ból származó összes forgalom át van irányítva egy belső terheléselosztóra.</span><span class="sxs-lookup"><span data-stu-id="a512d-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="a512d-162">A terheléselosztó elosztja a kimenő kérelmeket egy NVA-készlet tagjai között.</span><span class="sxs-lookup"><span data-stu-id="a512d-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="a512d-163">Ezek az NVA-k az internetre irányítják a forgalmat saját nyilvános IP-címeik használatával.</span><span class="sxs-lookup"><span data-stu-id="a512d-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="a512d-164">Ezt az architektúrát az [Azure és a helyszíni adatközpont közötti DMZ][dmz-on-prem] és az [Azure és az internet közötti DMZ][dmz-internet] referenciaarchitektúrákban használják.</span><span class="sxs-lookup"><span data-stu-id="a512d-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="a512d-165">Ezen referenciaarchitektúrák mindegyike tartalmaz egy felhasználható üzembehelyezési megoldást.</span><span class="sxs-lookup"><span data-stu-id="a512d-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="a512d-166">További információkért kövesse a hivatkozásokat.</span><span class="sxs-lookup"><span data-stu-id="a512d-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="a512d-167">Bejövő és kimenő forgalom 7-es rétegű NVA-kkal</span><span class="sxs-lookup"><span data-stu-id="a512d-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="a512d-168">A két előző architektúrában külön DMZ tartozott a bejövő és a kimenő forgalomhoz.</span><span class="sxs-lookup"><span data-stu-id="a512d-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="a512d-169">A következő architektúra bemutatja, hogyan kell létrehozni olyan DMZ-t, amely egyaránt használható a bejövő és kimenő 7-es rétegű forgalomhoz (például HTTP-hez vagy HTTPS-hez):</span><span class="sxs-lookup"><span data-stu-id="a512d-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="a512d-171">Ebben az architektúrában az NVA-k az alkalmazásátjáróról érkező kérelmeket dolgozzák fel.</span><span class="sxs-lookup"><span data-stu-id="a512d-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="a512d-172">Az NVA-k a terheléselosztó háttérkészletében található, számítási feladatokat végző virtuális gépek kimenő kérelmeit is feldolgozzák.</span><span class="sxs-lookup"><span data-stu-id="a512d-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="a512d-173">Mivel a bejövő forgalmat a rendszer alkalmazásátjáróval, a kimenőt pedig terheléselosztóval irányítja, az NVA-k felelősek a munkamenet affinitásának fenntartásáért.</span><span class="sxs-lookup"><span data-stu-id="a512d-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="a512d-174">Ez azt jelenti, hogy az alkalmazásátjáró leképezi a bejövő és a kimenő kérelmeket, így továbbíthatja a helyes választ az eredeti kérelmezőnek.</span><span class="sxs-lookup"><span data-stu-id="a512d-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="a512d-175">Azonban a belső terheléselosztó nem fér hozzá az alkalmazásátjáró leképezéseihez, így a saját logikáját használja, amikor választ küld az NVA-knak.</span><span class="sxs-lookup"><span data-stu-id="a512d-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="a512d-176">Előfordulhat, hogy a terheléselosztó nem annak az NVA-nak küld választ, amely eredetileg megkapta a kérelmet az alkalmazásátjáróról.</span><span class="sxs-lookup"><span data-stu-id="a512d-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="a512d-177">Ebben az esetben az NVA-knak kommunikálniuk kell, és továbbítaniuk kell egymás között a választ, hogy a megfelelő NVA küldhesse tovább a választ az alkalmazásátjáróra.</span><span class="sxs-lookup"><span data-stu-id="a512d-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="a512d-178">Úgy is megoldhatja az aszimmetrikus útvonal-választási problémát, ha gondoskodik róla, hogy az NVA-k bejövő forráshálózati címfordítást (SNAT) végezzenek.</span><span class="sxs-lookup"><span data-stu-id="a512d-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="a512d-179">Ez lecserélné a kérelmező eredeti forrás IP-címét az NVA által a bejövő adatfolyamon használt IP-címeinek egyikével.</span><span class="sxs-lookup"><span data-stu-id="a512d-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="a512d-180">Így gondoskodni lehet róla, hogy több NVA is használható legyen egyszerre az útvonal szimmetriájának megőrzése mellett.</span><span class="sxs-lookup"><span data-stu-id="a512d-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="a512d-181">PIP-UDR kapcsoló 4-es rétegű NVA-kkal</span><span class="sxs-lookup"><span data-stu-id="a512d-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="a512d-182">Az alábbi szakasz egy aktív és egy passzív NVA-val rendelkező architektúrát mutat be.</span><span class="sxs-lookup"><span data-stu-id="a512d-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="a512d-183">Ez az architektúra mind a bejövő, mind a kimenő 4-es rétegű forgalmat kezeli:</span><span class="sxs-lookup"><span data-stu-id="a512d-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="a512d-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="a512d-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="a512d-185">Ez az architektúra teljes körű megoldást érhető el a [GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="a512d-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="a512d-186">Ez az architektúra hasonlít a cikkben elsőként bemutatott architektúrára.</span><span class="sxs-lookup"><span data-stu-id="a512d-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="a512d-187">Az egyetlen NVA-t tartalmazott, amely a 4-es rétegű beérkező kérelmek fogadását és szűrését végezte.</span><span class="sxs-lookup"><span data-stu-id="a512d-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="a512d-188">Ez az architektúra mindezt egy második passzív NVA-val egészíti ki a magas rendelkezésre állás érdekében.</span><span class="sxs-lookup"><span data-stu-id="a512d-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="a512d-189">Ha az aktív NVA meghibásodik, a passzív NVA aktiválódik, és az UDR, valamint a PIP úgy módosul, hogy az imént aktivált NVA hálózati adaptereire mutasson.</span><span class="sxs-lookup"><span data-stu-id="a512d-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="a512d-190">Az UDR és a PIP ezen módosításai manuálisan vagy egy automatizált folyamattal is elvégezhetők.</span><span class="sxs-lookup"><span data-stu-id="a512d-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="a512d-191">Az automatizált folyamat jellemzően egy démon, vagy egy másik Azure-beli figyelőszolgáltatás,</span><span class="sxs-lookup"><span data-stu-id="a512d-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="a512d-192">amely végrehajtja az aktív NVA állapotvizsgálatát, majd átkapcsolja az UDR-t és a PIP-et, amikor az NVA meghibásodását észleli.</span><span class="sxs-lookup"><span data-stu-id="a512d-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="a512d-193">A fenti ábrán egy például szolgáló [ZooKeeper][zookeeper]-fürt látható, amely egy magas rendelkezésre állású démont biztosít.</span><span class="sxs-lookup"><span data-stu-id="a512d-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="a512d-194">A ZooKeeper-fürtön belül egy csomópontkvórum kiválaszt egy vezetőt.</span><span class="sxs-lookup"><span data-stu-id="a512d-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="a512d-195">Ha a vezető meghibásodik, akkor a többi csomópont választást tart egy új vezető kinevezésére.</span><span class="sxs-lookup"><span data-stu-id="a512d-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="a512d-196">A jelen architektúra esetében a vezető csomópont végrehajtja a démont, amely lekérdezi az NVA üzemállapoti végpontját.</span><span class="sxs-lookup"><span data-stu-id="a512d-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="a512d-197">Ha az NVA nem válaszol az állapotvizsgálatra, akkor a démon aktiválja a passzív NVA-t.</span><span class="sxs-lookup"><span data-stu-id="a512d-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="a512d-198">Ezt követően a démon lehívja az Azure REST API-t a PIP eltávolításához a meghibásodott NVA-ból, majd csatolja azt az újonnan aktivált NVA-hoz.</span><span class="sxs-lookup"><span data-stu-id="a512d-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="a512d-199">A démon ezután módosítja az UDR-t, hogy az újonnan aktivált NVA belső IP-címére mutasson.</span><span class="sxs-lookup"><span data-stu-id="a512d-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="a512d-200">Ne vegyen fel ZooKeeper-csomópontokat olyan alhálózatba, amely csak olyan útvonalon keresztül érhető el, amely tartalmazza az NVA-t.</span><span class="sxs-lookup"><span data-stu-id="a512d-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="a512d-201">Ha mégis így tesz, a ZooKeeper-csomópontok nem lesznek érhetők az NVA meghibásodásakor.</span><span class="sxs-lookup"><span data-stu-id="a512d-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="a512d-202">Ha a démon bármilyen okból sikertelen, akkor nem fogja tudni használni a ZooKeeper-csomópontokat a probléma diagnosztizálására.</span><span class="sxs-lookup"><span data-stu-id="a512d-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="a512d-203">A teljes megoldás, beleértve a mintakódot, olvassa el a fájlokat a [GitHub-adattár][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="a512d-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="a512d-204">A PIP-UDR nva-k SNAT</span><span class="sxs-lookup"><span data-stu-id="a512d-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="a512d-205">Ez az architektúra két Azure-beli virtuális gépek futtatásához az NVA tűzfala egy aktív-passzív konfigurációt, amely támogatja az Automatikus feladatátvétel, de nem szükséges a forrás hálózati cím címfordítás (SNAT) használja.</span><span class="sxs-lookup"><span data-stu-id="a512d-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![PIP-UDR nva-k nélkül SNAT-architektúra](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="a512d-207">Ez az architektúra teljes körű megoldást érhető el a [GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="a512d-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="a512d-208">Ez a megoldás Azure ügyfelek, akik SNAT nem lehet konfigurálni a bejövő kérelmekre a saját NVA tűzfalak lett tervezve.</span><span class="sxs-lookup"><span data-stu-id="a512d-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="a512d-209">SNAT elrejti az eredeti forrás ügyfél IP-címe.</span><span class="sxs-lookup"><span data-stu-id="a512d-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="a512d-210">Ha be kell jelentkeznie az eredeti IP-címek vagy az nva-k mögött belül más többrétegű biztonsági összetevők használni őket, ez a megoldás egyszerű megközelítést kínál.</span><span class="sxs-lookup"><span data-stu-id="a512d-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="a512d-211">A következő ugrás címét az aktív NVA tűzfal virtuális gép hálózati adapteréhez IP-címét állítsa által automatizált UDR táblabejegyzéseket feladatátvétele.</span><span class="sxs-lookup"><span data-stu-id="a512d-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="a512d-212">Az automatikus feladatátvételi logika használatával létrehozott függvényalkalmazás szolgáltatásban üzemeltetett [Azure Functions](/azure/azure-functions/).</span><span class="sxs-lookup"><span data-stu-id="a512d-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="a512d-213">A feladatátvételi kódja fut, mint belül az Azure Functions egy kiszolgáló nélküli függvény.</span><span class="sxs-lookup"><span data-stu-id="a512d-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="a512d-214">Üzembe helyezés kényelmesen, költségkímélő és könnyen kezelése és testreszabása.</span><span class="sxs-lookup"><span data-stu-id="a512d-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="a512d-215">Emellett a függvényalkalmazás üzemeltetett belül az Azure Functions, így egy csoporttól sem a virtuális hálózaton.</span><span class="sxs-lookup"><span data-stu-id="a512d-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="a512d-216">Ha a virtuális hálózatot milyen hatással vannak az NVA-tűzfalak, a függvényalkalmazás továbbra is futtatható önállóan.</span><span class="sxs-lookup"><span data-stu-id="a512d-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="a512d-217">Tesztelés azért pontosabb, valamint az ugyanazon útvonalat használja, mint a bejövő ügyfélkérelmek a virtuális hálózaton kívül történik.</span><span class="sxs-lookup"><span data-stu-id="a512d-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="a512d-218">Az nva-t tűzfal rendelkezésre állásának ellenőrzéséhez a függvénykódot alkalmazás mintavételek a két módszer egyikével:</span><span class="sxs-lookup"><span data-stu-id="a512d-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="a512d-219">Az Azure-beli virtuális gépek állapotának figyelésével az nva-t tűzfal üzemeltetéséhez.</span><span class="sxs-lookup"><span data-stu-id="a512d-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="a512d-220">Tesztelésével nyitott portot a tűzfalon a háttér-webkiszolgálóhoz van-e.</span><span class="sxs-lookup"><span data-stu-id="a512d-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="a512d-221">Ezt a beállítást, a az nva-n egy szoftvercsatorna tesztelése a függvény-alkalmazás kódjához PIP-n keresztül kell közzétennie.</span><span class="sxs-lookup"><span data-stu-id="a512d-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="a512d-222">Válassza a mintavétel a függvényalkalmazás konfigurálásakor használni kívánt típusát.</span><span class="sxs-lookup"><span data-stu-id="a512d-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="a512d-223">A teljes megoldás, beleértve a mintakódot, olvassa el a fájlokat a [GitHub-adattár][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="a512d-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="a512d-224">További lépések</span><span class="sxs-lookup"><span data-stu-id="a512d-224">Next steps</span></span>

- <span data-ttu-id="a512d-225">Megtudhatja, hogyan [implementálhat DMZ-t az Azure és a helyszíni adatközpont között][dmz-on-prem] 7-es rétegű NVA-k használatával.</span><span class="sxs-lookup"><span data-stu-id="a512d-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-prem] using layer-7 NVAs.</span></span>
- <span data-ttu-id="a512d-226">Megtudhatja, hogyan [implementálhat DMZ-t az Azure és az internet között][dmz-internet] 7-es rétegű NVA-k használatával.</span><span class="sxs-lookup"><span data-stu-id="a512d-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="a512d-227">Az Azure-ban a hálózati virtuális berendezés hibák elhárítása</span><span class="sxs-lookup"><span data-stu-id="a512d-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Egyetlen NVA-ból álló architektúra"
[1]: ./images/nva-ha/l7-ingress.png "7-es rétegű bejövő forgalom"
[2]: ./images/nva-ha/l7-ingress-egress.png "7-es rétegű kimenő forgalom"
[3]: ./images/nva-ha/active-passive.png "Aktív-passzív fürt"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
