---
title: Kompenzáló tranzakció mintája
titleSuffix: Cloud Design Patterns
description: Visszavonhat egy sorozatnyi, együttesen végül konzisztens műveletet meghatározó lépés által végrehajtott munkát.
keywords: tervezési minta
author: dragon119
ms.date: 06/23/2017
ms.custom: seodec18
ms.openlocfilehash: b81151a6db08c2c14c7f26af3b4b79bfd22a18bb
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: MT
ms.contentlocale: hu-HU
ms.lasthandoff: 01/04/2019
ms.locfileid: "54011616"
---
# <a name="compensating-transaction-pattern"></a><span data-ttu-id="92a3f-104">Kompenzáló tranzakció mintája</span><span class="sxs-lookup"><span data-stu-id="92a3f-104">Compensating Transaction pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="92a3f-105">Visszavon egy sor, együtt végül egy konzisztens műveletet alkotó lépésben végrehajtott munkát, ha egy vagy több lépés meghiúsul.</span><span class="sxs-lookup"><span data-stu-id="92a3f-105">Undo the work performed by a series of steps, which together define an eventually consistent operation, if one or more of the steps fail.</span></span> <span data-ttu-id="92a3f-106">A végleges konzisztenciájú modellt követő műveletek általában olyan felhőben üzemeltetett alkalmazásokban találhatók, amelyek összetett üzleti folyamatokat és munkafolyamatokat valósítanak meg.</span><span class="sxs-lookup"><span data-stu-id="92a3f-106">Operations that follow the eventual consistency model are commonly found in cloud-hosted applications that implement complex business processes and workflows.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="92a3f-107">Kontextus és probléma</span><span class="sxs-lookup"><span data-stu-id="92a3f-107">Context and problem</span></span>

<span data-ttu-id="92a3f-108">A felhőben futó alkalmazások gyakran módosítják az adatokat.</span><span class="sxs-lookup"><span data-stu-id="92a3f-108">Applications running in the cloud frequently modify data.</span></span> <span data-ttu-id="92a3f-109">Ezek az adatokat számos, különböző földrajzi helyeken lévő adatforrás között lehetnek elosztva.</span><span class="sxs-lookup"><span data-stu-id="92a3f-109">This data might be spread across various data sources held in different geographic locations.</span></span> <span data-ttu-id="92a3f-110">Az elosztott környezetben a versengés elkerülése és a teljesítmény javítása érdekében az alkalmazásnak nem az erős tranzakció-konzisztencia biztosítására kell törekednie.</span><span class="sxs-lookup"><span data-stu-id="92a3f-110">To avoid contention and improve performance in a distributed environment, an application shouldn't try to provide strong transactional consistency.</span></span> <span data-ttu-id="92a3f-111">Ehelyett az alkalmazásnak a végleges konzisztenciát kell megvalósítania.</span><span class="sxs-lookup"><span data-stu-id="92a3f-111">Rather, the application should implement eventual consistency.</span></span> <span data-ttu-id="92a3f-112">Ebben a modellben egy tipikus üzleti tevékenység különálló lépések sorozatából áll.</span><span class="sxs-lookup"><span data-stu-id="92a3f-112">In this model, a typical business operation consists of a series of separate steps.</span></span> <span data-ttu-id="92a3f-113">A lépések végrehajtása közben a rendszer állapotának átfogó képe inkonzisztens lehet, amikor azonban a tevékenység befejeződött, és az összes lépés végrehajtása megtörtént, a rendszernek újra konzisztensnek kell lennie.</span><span class="sxs-lookup"><span data-stu-id="92a3f-113">While these steps are being performed, the overall view of the system state might be inconsistent, but when the operation has completed and all of the steps have been executed the system should become consistent again.</span></span>

> <span data-ttu-id="92a3f-114">Az [Adatkonzisztencia – Ismertető](https://msdn.microsoft.com/library/dn589800.aspx) információkkal szolgál arról, hogy az elosztott tranzakciók miért nem skálázhatók jól, illetve ismerteti a végleges konzisztenciájú modell alapelveit.</span><span class="sxs-lookup"><span data-stu-id="92a3f-114">The [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) provides information about why distributed transactions don't scale well, and the principles of the eventual consistency model.</span></span>

<span data-ttu-id="92a3f-115">A végleges konzisztenciájú modell esetében a kihívást a meghiúsult lépések kezelése jelenti.</span><span class="sxs-lookup"><span data-stu-id="92a3f-115">A challenge in the eventual consistency model is how to handle a step that has failed.</span></span> <span data-ttu-id="92a3f-116">Ebben az esetben szükség lehet a művelet összes korábbi lépése által elvégzett munka visszavonására.</span><span class="sxs-lookup"><span data-stu-id="92a3f-116">In this case it might be necessary to undo all of the work completed by the previous steps in the operation.</span></span> <span data-ttu-id="92a3f-117">Az adatokat azonban nem lehet egyszerűen visszaállítani, mert a párhuzamos alkalmazáspéldányok esetleg módosíthatták azokat.</span><span class="sxs-lookup"><span data-stu-id="92a3f-117">However, the data can't simply be rolled back because other concurrent instances of the application might have changed it.</span></span> <span data-ttu-id="92a3f-118">Még az olyan esetekben is, ahol az adatokat egy párhuzamos alkalmazáspéldány sem módosította, egy lépések visszavonása nem feltétlenül jelenti egyértelműen az eredeti állapot visszaállítását.</span><span class="sxs-lookup"><span data-stu-id="92a3f-118">Even in cases where the data hasn't been changed by a concurrent instance, undoing a step might not simply be a matter of restoring the original state.</span></span> <span data-ttu-id="92a3f-119">Előfordulhat, hogy különböző üzletspecifikus szabályok alkalmazása válik szükségessé (lásd a Példa szakaszban bemutatott utazási webhely esetét).</span><span class="sxs-lookup"><span data-stu-id="92a3f-119">It might be necessary to apply various business-specific rules (see the travel website described in the Example section).</span></span>

<span data-ttu-id="92a3f-120">Ha a végleges konzisztenciát megvalósító művelet több heterogén adattárolóra is kiterjed, a lépések visszavonása esetében az összes adattárat végig kell járni.</span><span class="sxs-lookup"><span data-stu-id="92a3f-120">If an operation that implements eventual consistency spans several heterogeneous data stores, undoing the steps in the operation will require visiting each data store in turn.</span></span> <span data-ttu-id="92a3f-121">Minden egyes adattárban megfelelően kell visszavonni az elvégzett munkát ahhoz, hogy a rendszer ne maradjon inkonzisztens.</span><span class="sxs-lookup"><span data-stu-id="92a3f-121">The work performed in every data store must be undone reliably to prevent the system from remaining inconsistent.</span></span>

<span data-ttu-id="92a3f-122">A végleges konzisztenciát megvalósító művelet által érintett adatok közül nem feltétlenül található mindegyik adatbázisban.</span><span class="sxs-lookup"><span data-stu-id="92a3f-122">Not all data affected by an operation that implements eventual consistency might be held in a database.</span></span> <span data-ttu-id="92a3f-123">A szolgáltatásorientált architektúra (SOA) környezetében egy művelet meghívhat egy másik műveletet a szolgáltatásban, változást okozva a szolgáltatás által tárolt állapotban.</span><span class="sxs-lookup"><span data-stu-id="92a3f-123">In a service oriented architecture (SOA) environment an operation could invoke an action in a service, and cause a change in the state held by that service.</span></span> <span data-ttu-id="92a3f-124">A művelet visszavonásához ezt az állapotváltozást is vissza kell vonni.</span><span class="sxs-lookup"><span data-stu-id="92a3f-124">To undo the operation, this state change must also be undone.</span></span> <span data-ttu-id="92a3f-125">Ehhez szükség lehet a szolgáltatás ismételt meghívására, illetve egy másik, az eredeti lépés hatását visszavonó művelet végrehajtására.</span><span class="sxs-lookup"><span data-stu-id="92a3f-125">This can involve invoking the service again and performing another action that reverses the effects of the first.</span></span>

## <a name="solution"></a><span data-ttu-id="92a3f-126">Megoldás</span><span class="sxs-lookup"><span data-stu-id="92a3f-126">Solution</span></span>

<span data-ttu-id="92a3f-127">A megoldást egy kompenzáló tranzakció megvalósítása jelenti.</span><span class="sxs-lookup"><span data-stu-id="92a3f-127">The solution is to implement a compensating transaction.</span></span> <span data-ttu-id="92a3f-128">A kompenzáló tranzakció lépéseinek vissza kell vonniuk az eredeti művelet lépéseinek hatásait.</span><span class="sxs-lookup"><span data-stu-id="92a3f-128">The steps in a compensating transaction must undo the effects of the steps in the original operation.</span></span> <span data-ttu-id="92a3f-129">Előfordulhat, hogy a kompenzáló tranzakció nem tudja egyszerűen visszaállítani a rendszer aktuális állapotát a művelet megkezdése előtti állapotra, mert ez a megoldás felülírná a párhuzamos alkalmazáspéldányok által végrehajtott esetleges módosításokat.</span><span class="sxs-lookup"><span data-stu-id="92a3f-129">A compensating transaction might not be able to simply replace the current state with the state the system was in at the start of the operation because this approach could overwrite changes made by other concurrent instances of an application.</span></span> <span data-ttu-id="92a3f-130">Ehelyett egy intelligens folyamatra van szükség, amely a párhuzamos alkalmazáspéldányok által végzett munkát is figyelembe veszi.</span><span class="sxs-lookup"><span data-stu-id="92a3f-130">Instead, it must be an intelligent process that takes into account any work done by concurrent instances.</span></span> <span data-ttu-id="92a3f-131">Ez a folyamat általában alkalmazásspecifikus, és az eredeti művelet által elvégzett munka jellege határozza meg.</span><span class="sxs-lookup"><span data-stu-id="92a3f-131">This process will usually be application specific, driven by the nature of the work performed by the original operation.</span></span>

<span data-ttu-id="92a3f-132">Gyakran alkalmazott megközelítés egy munkafolyamat segítségével megvalósítani egy végül konzisztens műveletet, amely esetében kompenzációra van szükség.</span><span class="sxs-lookup"><span data-stu-id="92a3f-132">A common approach is to use a workflow to implement an eventually consistent operation that requires compensation.</span></span> <span data-ttu-id="92a3f-133">Az eredeti műveletet végrehajtása során a rendszer információkat rögzít minden lépésről, illetve arról, hogyan lehet visszavonni az általuk elvégzett munkát.</span><span class="sxs-lookup"><span data-stu-id="92a3f-133">As the original operation proceeds, the system records information about each step and how the work performed by that step can be undone.</span></span> <span data-ttu-id="92a3f-134">Ha a művelet bármely ponton meghiúsul, a munkafolyamat visszafelé haladva végigveszi az elvégzett lépéseket, és az összes esetében végrehajtja a visszavonáshoz szükséges munkát.</span><span class="sxs-lookup"><span data-stu-id="92a3f-134">If the operation fails at any point, the workflow rewinds back through the steps it's completed and performs the work that reverses each step.</span></span> <span data-ttu-id="92a3f-135">Fontos megjegyezni, hogy a kompenzáló tranzakció nem feltétlenül az eredeti műveletnek megfelelő sorrendben vonja vissza az elvégzett munkát, és egyszerre több visszavonási lépést is végrehajthat.</span><span class="sxs-lookup"><span data-stu-id="92a3f-135">Note that a compensating transaction might not have to undo the work in the exact reverse order of the original operation, and it might be possible to perform some of the undo steps in parallel.</span></span>

> <span data-ttu-id="92a3f-136">Ez a gyakorlat nagyban hasonlít a [Clemens Vasters blogjában](https://vasters.com/clemensv/2012/09/01/Sagas.aspx) tárgyalt Sagas-stratégiához.</span><span class="sxs-lookup"><span data-stu-id="92a3f-136">This approach is similar to the Sagas strategy discussed in [Clemens Vasters’ blog](https://vasters.com/clemensv/2012/09/01/Sagas.aspx).</span></span>

<span data-ttu-id="92a3f-137">A kompenzáló tranzakció is egy végül konzisztenssé váló művelet, amely szintén meghiúsulhat.</span><span class="sxs-lookup"><span data-stu-id="92a3f-137">A compensating transaction is also an eventually consistent operation and it could also fail.</span></span> <span data-ttu-id="92a3f-138">A rendszernek képesnek kell lennie a kompenzáló tranzakció helyreállítására az adott hibánál, majd folytatni a műveletet.</span><span class="sxs-lookup"><span data-stu-id="92a3f-138">The system should be able to resume the compensating transaction at the point of failure and continue.</span></span> <span data-ttu-id="92a3f-139">Előfordulhat, hogy egy meghiúsult lépést meg kell ismételni, ezért a kompenzáló tranzakcióban szereplő lépéseket idempotens parancsokként kell meghatározni.</span><span class="sxs-lookup"><span data-stu-id="92a3f-139">It might be necessary to repeat a step that's failed, so the steps in a compensating transaction should be defined as idempotent commands.</span></span> <span data-ttu-id="92a3f-140">További információ: [Idempotens minták](https://blog.jonathanoliver.com/idempotency-patterns/) (Jonathan Oliver blogjában).</span><span class="sxs-lookup"><span data-stu-id="92a3f-140">For more information, see [Idempotency Patterns](https://blog.jonathanoliver.com/idempotency-patterns/) on Jonathan Oliver’s blog.</span></span>

<span data-ttu-id="92a3f-141">Bizonyos esetekben előfordulhat, hogy egy meghiúsult lépés helyreállítása csak manuális intézkedés révén lehetséges.</span><span class="sxs-lookup"><span data-stu-id="92a3f-141">In some cases it might not be possible to recover from a step that has failed except through manual intervention.</span></span> <span data-ttu-id="92a3f-142">Ilyen helyzetben a rendszernek riasztást kell létrehoznia, és a lehető legtöbb információt kell biztosítania a hiba okairól.</span><span class="sxs-lookup"><span data-stu-id="92a3f-142">In these situations the system should raise an alert and provide as much information as possible about the reason for the failure.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="92a3f-143">Problémák és megfontolandó szempontok</span><span class="sxs-lookup"><span data-stu-id="92a3f-143">Issues and considerations</span></span>

<span data-ttu-id="92a3f-144">A minta megvalósítása során az alábbi pontokat vegye figyelembe:</span><span class="sxs-lookup"><span data-stu-id="92a3f-144">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="92a3f-145">Nem mindig egyszerű megállapítani, hogy a végleges konzisztenciát megvalósító művelet adott lépése mikor hiúsult meg.</span><span class="sxs-lookup"><span data-stu-id="92a3f-145">It might not be easy to determine when a step in an operation that implements eventual consistency has failed.</span></span> <span data-ttu-id="92a3f-146">Előfordulhat, hogy egy lépés nem azonnal hiúsul meg, de elakadást okoz.</span><span class="sxs-lookup"><span data-stu-id="92a3f-146">A step might not fail immediately, but instead could block.</span></span> <span data-ttu-id="92a3f-147">Egyes esetekben szükséges lehet valamilyen időtúllépési mechanizmus bevezetésére.</span><span class="sxs-lookup"><span data-stu-id="92a3f-147">It might be necessary to implement some form of time-out mechanism.</span></span>

<span data-ttu-id="92a3f-148">A kompenzáció logikáját nem könnyű általánosítani.</span><span class="sxs-lookup"><span data-stu-id="92a3f-148">-Compensation logic isn't easily generalized.</span></span> <span data-ttu-id="92a3f-149">A kompenzáló tranzakciók alkalmazásspecifikusak.</span><span class="sxs-lookup"><span data-stu-id="92a3f-149">A compensating transaction is application specific.</span></span> <span data-ttu-id="92a3f-150">A meghiúsult művelet lépéseinek hatása akkor vonható vissza, ha az alkalmazás ehhez elegendő információval rendelkezik.</span><span class="sxs-lookup"><span data-stu-id="92a3f-150">It relies on the application having sufficient information to be able to undo the effects of each step in a failed operation.</span></span>

<span data-ttu-id="92a3f-151">A kompenzáló tranzakción belüli lépéseket idempotens parancsokként kell meghatározni.</span><span class="sxs-lookup"><span data-stu-id="92a3f-151">You should define the steps in a compensating transaction as idempotent commands.</span></span> <span data-ttu-id="92a3f-152">Ez a kompenzáló tranzakció meghiúsulása esetén lehetővé teszi a lépések megismétlését.</span><span class="sxs-lookup"><span data-stu-id="92a3f-152">This enables the steps to be repeated if the compensating transaction itself fails.</span></span>

<span data-ttu-id="92a3f-153">Az eredeti művelet lépéseit és a kompenzáló tranzakciót kezelő infrastruktúrának rugalmasnak kell lennie.</span><span class="sxs-lookup"><span data-stu-id="92a3f-153">The infrastructure that handles the steps in the original operation, and the compensating transaction, must be resilient.</span></span> <span data-ttu-id="92a3f-154">Nem veszítheti el a meghiúsult lépések kompenzációjához szükséges információkat, továbbá megbízhatóan kell monitoroznia a kompenzációs logika előrehaladásának állapotát.</span><span class="sxs-lookup"><span data-stu-id="92a3f-154">It must not lose the information required to compensate for a failing step, and it must be able to reliably monitor the progress of the compensation logic.</span></span>

<span data-ttu-id="92a3f-155">A kompenzáló tranzakció nem feltétlenül az eredeti művelet kezdetén fennálló állapotba állítja vissza az adatokat a rendszerben.</span><span class="sxs-lookup"><span data-stu-id="92a3f-155">A compensating transaction doesn't necessarily return the data in the system to the state it was in at the start of the original operation.</span></span> <span data-ttu-id="92a3f-156">Ehelyett a művelet meghiúsulása előtt sikeresen végrehajtott lépések által elvégzett munkát kompenzálja.</span><span class="sxs-lookup"><span data-stu-id="92a3f-156">Instead, it compensates for the work performed by the steps that completed successfully before the operation failed.</span></span>

<span data-ttu-id="92a3f-157">A kompenzáló tranzakció lépéseinek sorrendje nem feltétlenül az eredeti művelet lépéseinek a fordítottja.</span><span class="sxs-lookup"><span data-stu-id="92a3f-157">The order of the steps in the compensating transaction doesn't necessarily have to be the exact opposite of the steps in the original operation.</span></span> <span data-ttu-id="92a3f-158">Például ha egy adattár a többinél érzékenyebb az inkonzisztenciákra, a kompenzáló tranzakció lépései először ennek a tárolónak a módosításait vonják vissza.</span><span class="sxs-lookup"><span data-stu-id="92a3f-158">For example, one data store might be more sensitive to inconsistencies than another, and so the steps in the compensating transaction that undo the changes to this store should occur first.</span></span>

<span data-ttu-id="92a3f-159">A műveletet végrehajtó erőforrásokra helyezett rövid távú, időkorlát-alapú zárolás és az erőforrások előzetes beszerzése növeli a tevékenység sikeres végrehajtásának esélyét.</span><span class="sxs-lookup"><span data-stu-id="92a3f-159">Placing a short-term timeout-based lock on each resource that's required to complete an operation, and obtaining these resources in advance, can help increase the likelihood that the overall activity will succeed.</span></span> <span data-ttu-id="92a3f-160">A munkát csak az összes erőforrás beszerzését követően szabad végrehajtani.</span><span class="sxs-lookup"><span data-stu-id="92a3f-160">The work should be performed only after all the resources have been acquired.</span></span> <span data-ttu-id="92a3f-161">A zárolás lejárta előtt az összes tevékenységet be kell fejezni.</span><span class="sxs-lookup"><span data-stu-id="92a3f-161">All actions must be finalized before the locks expire.</span></span>

<span data-ttu-id="92a3f-162">A kompenzáló tranzakciót kiváltó hibák minimalizálása érdekében érdemes lehet olyan újrapróbálkozási logikát alkalmazni, amely a szokásosnál megengedőbb.</span><span class="sxs-lookup"><span data-stu-id="92a3f-162">Consider using retry logic that is more forgiving than usual to minimize failures that trigger a compensating transaction.</span></span> <span data-ttu-id="92a3f-163">Ha a végleges konzisztenciát megvalósító művelet egyik lépése meghiúsul, próbálja meg átmeneti kivételként kezelni a hibát, és ismételje meg az adott lépést.</span><span class="sxs-lookup"><span data-stu-id="92a3f-163">If a step in an operation that implements eventual consistency fails, try handling the failure as a transient exception and repeat the step.</span></span> <span data-ttu-id="92a3f-164">Csak akkor állítsa le a műveletet és indítsa el a kompenzáló tranzakciót, ha a lépés ismételten vagy visszavonhatatlanul meghiúsul.</span><span class="sxs-lookup"><span data-stu-id="92a3f-164">Only stop the operation and initiate a compensating transaction if a step fails repeatedly or irrecoverably.</span></span>

> <span data-ttu-id="92a3f-165">A kompenzáló tranzakció végrehajtásával kapcsolatban számos hasonló kihívás merül fel, mint a végleges konzisztencia esetében.</span><span class="sxs-lookup"><span data-stu-id="92a3f-165">Many of the challenges of implementing a compensating transaction are the same as those with implementing eventual consistency.</span></span> <span data-ttu-id="92a3f-166">További információért lásd a végleges konzisztencia megvalósításának szempontjaival foglalkozó részt az [Adatkonzisztencia – Ismertető](https://msdn.microsoft.com/library/dn589800.aspx) témakörben.</span><span class="sxs-lookup"><span data-stu-id="92a3f-166">See the section Considerations for Implementing Eventual Consistency in the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) for more information.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="92a3f-167">Mikor érdemes ezt a mintát használni?</span><span class="sxs-lookup"><span data-stu-id="92a3f-167">When to use this pattern</span></span>

<span data-ttu-id="92a3f-168">Ezt a mintát csak olyan műveletek esetében javasolt használni, amelyeket a meghiúsulásuk esetén vissza kell vonni.</span><span class="sxs-lookup"><span data-stu-id="92a3f-168">Use this pattern only for operations that must be undone if they fail.</span></span> <span data-ttu-id="92a3f-169">Ha lehetséges, keressen olyan megoldásokat, amelyekkel elkerülhető a kompenzáló tranzakciók jelentette összetettség.</span><span class="sxs-lookup"><span data-stu-id="92a3f-169">If possible, design solutions to avoid the complexity of requiring compensating transactions.</span></span>

## <a name="example"></a><span data-ttu-id="92a3f-170">Példa</span><span class="sxs-lookup"><span data-stu-id="92a3f-170">Example</span></span>

<span data-ttu-id="92a3f-171">Az utazási webhely lehetővé teszi, hogy az ügyfelek utakat foglaljanak le.</span><span class="sxs-lookup"><span data-stu-id="92a3f-171">A travel website lets customers book itineraries.</span></span> <span data-ttu-id="92a3f-172">Egy útiterv repülőjárat- és szállásfoglalások egész sorát tartalmazhatja.</span><span class="sxs-lookup"><span data-stu-id="92a3f-172">A single itinerary might comprise a series of flights and hotels.</span></span> <span data-ttu-id="92a3f-173">Az ügyfél, aki Seattle-ből Londonba, majd onnan Párizsba utazik, a következő lépéseket hajthatja végre az útiterv létrehozása során:</span><span class="sxs-lookup"><span data-stu-id="92a3f-173">A customer traveling from Seattle to London and then on to Paris could perform the following steps when creating an itinerary:</span></span>

1. <span data-ttu-id="92a3f-174">Helyet foglal a Seattle-ből Londonba tartó F1 repülőjáratra.</span><span class="sxs-lookup"><span data-stu-id="92a3f-174">Book a seat on flight F1 from Seattle to London.</span></span>
2. <span data-ttu-id="92a3f-175">Helyet foglal a Londonból Párizsba tartó F2 repülőjáratra.</span><span class="sxs-lookup"><span data-stu-id="92a3f-175">Book a seat on flight F2 from London to Paris.</span></span>
3. <span data-ttu-id="92a3f-176">Helyet foglal a Párizsból Seattle-be tartó F3 repülőjáratra.</span><span class="sxs-lookup"><span data-stu-id="92a3f-176">Book a seat on flight F3 from Paris to Seattle.</span></span>
4. <span data-ttu-id="92a3f-177">Szobát foglal a londoni H1 szállodában.</span><span class="sxs-lookup"><span data-stu-id="92a3f-177">Reserve a room at hotel H1 in London.</span></span>
5. <span data-ttu-id="92a3f-178">Szobát foglal a párizsi H2 szállodában.</span><span class="sxs-lookup"><span data-stu-id="92a3f-178">Reserve a room at hotel H2 in Paris.</span></span>

<span data-ttu-id="92a3f-179">Ezek a lépések egy végül konzisztens műveletet alkotnak, bár minden egyes lépés külön műveletet jelent.</span><span class="sxs-lookup"><span data-stu-id="92a3f-179">These steps constitute an eventually consistent operation, although each step is a separate action.</span></span> <span data-ttu-id="92a3f-180">Ezért a lépések végrehajtása mellett a rendszernek a visszavonásukhoz szükséges műveleteket is rögzítenie kell arra az esetre, ha az ügyfél úgy dönt, hogy törli az útitervet.</span><span class="sxs-lookup"><span data-stu-id="92a3f-180">Therefore, as well as performing these steps, the system must also record the counter operations necessary to undo each step in case the customer decides to cancel the itinerary.</span></span> <span data-ttu-id="92a3f-181">Az ellenkező irányú műveletek elvégzéséhez szükséges lépések kompenzáló tranzakcióként futtathatók le.</span><span class="sxs-lookup"><span data-stu-id="92a3f-181">The steps necessary to perform the counter operations can then run as a compensating transaction.</span></span>

<span data-ttu-id="92a3f-182">Megjegyzendő, hogy a kompenzáló tranzakció lépései nem feltétlenül az eredeti lépések pontos ellentétét jelentik, továbbá a kompenzáló tranzakció minden egyes lépésének logikája figyelembe kell vegyen minden vonatkozó üzletspecifikus szabályt.</span><span class="sxs-lookup"><span data-stu-id="92a3f-182">Notice that the steps in the compensating transaction might not be the exact opposite of the original steps, and the logic in each step in the compensating transaction must take into account any business-specific rules.</span></span> <span data-ttu-id="92a3f-183">Például ha az ügyfél lemondja a repülőjegyre vonatkozó foglalást, korántsem biztos, hogy visszatérítés is jár neki.</span><span class="sxs-lookup"><span data-stu-id="92a3f-183">For example, unbooking a seat on a flight might not entitle the customer to a complete refund of any money paid.</span></span> <span data-ttu-id="92a3f-184">Az ábra bemutatja, hogyan hozható létre kompenzáló tranzakció egy utazás foglalására irányuló, hosszú ideje tartó tranzakció visszaállítására.</span><span class="sxs-lookup"><span data-stu-id="92a3f-184">The figure illustrates generating a compensating transaction to undo a long-running transaction to book a travel itinerary.</span></span>

![Kompenzáló tranzakció létrehozása egy utazás foglalására irányuló, hosszú ideje tartó tranzakció visszaállítására](./_images/compensating-transaction-diagram.png)

> [!NOTE]
> <span data-ttu-id="92a3f-186">Elvileg lehetséges a kompenzáló tranzakció lépéseinek párhuzamos végrehajtása is, attól függően, hogy az egyes lépések kompenzációs logikája hogyan lett kialakítva.</span><span class="sxs-lookup"><span data-stu-id="92a3f-186">It might be possible for the steps in the compensating transaction to be performed in parallel, depending on how you've designed the compensating logic for each step.</span></span>

<span data-ttu-id="92a3f-187">Számos üzleti megoldás esetében egyetlen hibás lépés nem feltétlenül jelenti azt, hogy az egész rendszert vissza kell állítani egy kompenzáló tranzakcióval.</span><span class="sxs-lookup"><span data-stu-id="92a3f-187">In many business solutions, failure of a single step doesn't always necessitate rolling the system back by using a compensating transaction.</span></span> <span data-ttu-id="92a3f-188">Ha például &mdash;az ügyfél lefoglalja az F1, F2 és F3 repülőjáratot az utazási webhely forgatókönyvében,&mdash;de utána nem tud szobát foglalni a H1 szállodában, a járatfoglalások törlése helyett érdemes inkább a város egy másik szállodáját a figyelmébe ajánlani.</span><span class="sxs-lookup"><span data-stu-id="92a3f-188">For example, if&mdash;after having booked flights F1, F2, and F3 in the travel website scenario&mdash;the customer is unable to reserve a room at hotel H1, it's preferable to offer the customer a room at a different hotel in the same city rather than canceling the flights.</span></span> <span data-ttu-id="92a3f-189">Az ügyfél továbbra is dönthet a lemondás mellett (ebben az esetben lefut a kompenzáló tranzakció, és visszavonja az F1, F2 és F3 járatra vonatkozó foglalást), de ezt a döntést az ügyfélnek kell meghoznia, nem pedig a rendszernek.</span><span class="sxs-lookup"><span data-stu-id="92a3f-189">The customer can still decide to cancel (in which case the compensating transaction runs and undoes the bookings made on flights F1, F2, and F3), but this decision should be made by the customer rather than by the system.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="92a3f-190">Kapcsolódó minták és útmutatók</span><span class="sxs-lookup"><span data-stu-id="92a3f-190">Related patterns and guidance</span></span>

<span data-ttu-id="92a3f-191">Az alábbi minták és útmutatók szintén hasznosak lehetnek a minta megvalósításakor:</span><span class="sxs-lookup"><span data-stu-id="92a3f-191">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="92a3f-192">[Adatkonzisztencia – Ismertető](https://msdn.microsoft.com/library/dn589800.aspx).</span><span class="sxs-lookup"><span data-stu-id="92a3f-192">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="92a3f-193">A Kompenzáló tranzakció mintája gyakran használják olyan műveletek visszavonásához, amelyek a végleges konzisztenciájú modell megvalósítását szolgálják.</span><span class="sxs-lookup"><span data-stu-id="92a3f-193">The Compensating Transaction pattern is often used to undo operations that implement the eventual consistency model.</span></span> <span data-ttu-id="92a3f-194">Ez az ismertető a végleges konzisztencia előnyeiről és hátrányairól nyújt tájékoztatást.</span><span class="sxs-lookup"><span data-stu-id="92a3f-194">This primer provides information on the benefits and tradeoffs of eventual consistency.</span></span>

- <span data-ttu-id="92a3f-195">[A Feladatütemező ügynök felügyeleti mintája](./scheduler-agent-supervisor.md).</span><span class="sxs-lookup"><span data-stu-id="92a3f-195">[Scheduler-Agent-Supervisor pattern](./scheduler-agent-supervisor.md).</span></span> <span data-ttu-id="92a3f-196">Ismerteti, hogyan lehet olyan rugalmas rendszereket megvalósítani, amelyek elosztott szolgáltatásokat és erőforrásokat használó üzleti műveletek végrehajtását végzik.</span><span class="sxs-lookup"><span data-stu-id="92a3f-196">Describes how to implement resilient systems that perform business operations that use distributed services and resources.</span></span> <span data-ttu-id="92a3f-197">Egyes esetekben szükség lehet egy művelet által elvégzett munka kompenzáló tranzakcióval történő visszavonására.</span><span class="sxs-lookup"><span data-stu-id="92a3f-197">Sometimes, it might be necessary to undo the work performed by an operation by using a compensating transaction.</span></span>

- <span data-ttu-id="92a3f-198">[Újrapróbálkozási minta](./retry.md).</span><span class="sxs-lookup"><span data-stu-id="92a3f-198">[Retry pattern](./retry.md).</span></span> <span data-ttu-id="92a3f-199">A kompenzáló tranzakciók végrehajtása költséges lehet, de az Újrapróbálkozási minta szerint megvalósított, a hibás műveletek megismétlésére vonatkozó hatékony szabályzattal minimálisra lehet csökkenteni a használatukat.</span><span class="sxs-lookup"><span data-stu-id="92a3f-199">Compensating transactions can be expensive to perform, and it might be possible to minimize their use by implementing an effective policy of retrying failing operations by following the Retry pattern.</span></span>
